# syntax=docker/dockerfile:1.4
##############################################################################
# Build caddy with brotli compression support
FROM golang:1.22-bullseye AS caddy-builder
# Use golang:bullseye (Debian-based)

# Enable cgo for compiling the Brotli plugin
ENV CGO_ENABLED=1

# Install C toolchain, Caddy plugin dependencies for Debian
RUN apt-get update && apt-get install -y \
    git \
    build-essential \
    pkg-config \
    libbrotli-dev \
  && go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest \
  && xcaddy build v2.7.6 \
    && rm -rf /var/lib/apt/lists/*

# Final stage: copy the built caddy binary into a fresh Caddy Debian image
FROM docker.io/library/caddy:2

COPY --from=caddy-builder /go/caddy /usr/bin/caddy

# Set default command (can be overridden by --entrypoint in podman run)
# ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"] # Keep this for ntn-dev to customize
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]