# syntax=docker/dockerfile:1.4

##############################################################################
# Stage 0: Frontend Assets Builder with Vite
# This stage builds your Vite assets (www folder)
FROM node:20-slim as frontend-builder
WORKDIR /app
# Copy package.json and package-lock.json first to leverage Docker cache
COPY package.json package-lock.json ./
# Use npm ci for clean install if package-lock.json exists, otherwise npm install
RUN npm ci || npm install
# Install Playwright dependencies and browsers
RUN apt-get update && apt-get install -y \
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm-dev \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libpango-1.0-0 \
    libgtk-3-0 \
    libx11-xcb1 \
    libxss1 \
    libxtst6 \
    libappindicator3-1 \
    libdbus-glib-1-2 \
    libgconf-2-4 \
    libnotify4 \
    libsecret-1-0 \
    libvulkan1 \
    --no-install-recommends \
    && rm -rf /var/lib/apt/lists/*
# Copy all source files required for the build (e.g., src/, public/ if any)
COPY . .

##############################################################################
# 1. Main Development Container (now based on node:20-slim again)
FROM node:20-slim

# Install Caddy from apt, and other general system dependencies
RUN apt-get update && apt-get install -y \
    caddy \
    nodejs \
    npm \
    # Playwright Chromium dependencies (copied from frontend-builder stage)
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm-dev \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libpango-1.0-0 \
    libgtk-3-0 \
    libx11-xcb1 \
    libxss1 \
    libxtst6 \
    libappindicator3-1 \
    libdbus-glib-1-2 \
    libgconf-2-4 \
    libnotify4 \
    libsecret-1-0 \
    libvulkan1 \
    --no-install-recommends \
    \
    bash \
    procps \
    python3 \
    python3-pip \
    python3-venv \
    curl \
    gnupg \
    gosu \
    strace \
    git \
    redis-server \
    redis-tools \
    brotli \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create appuser and appgroup early for permissions
RUN addgroup --system appgroup && adduser --system appuser --ingroup appgroup \
    && chown appuser:appgroup /tmp # Ensure /tmp is writable for non-root user


##############################################################################
# 2. Build args & env
ARG DOMAIN
ARG EMAIL
ARG APP_PASSWORD
ENV DOMAIN=${DOMAIN} \
    EMAIL=${EMAIL} \
    APP_PASSWORD=${APP_PASSWORD}

##############################################################################
# 3. Python venv & packages
RUN python3 -m venv /venv
ENV PATH="/venv/bin:$PATH"
COPY requirements.txt .
RUN pip install -r requirements.txt \
    && rm -rf /root/.cache/pip

##############################################################################
# 4. Copy code & initial data
WORKDIR /app

# IMPORTANT: This line now copies the 'www' folder, which Vite will generate.
COPY --from=frontend-builder /app/www/ /app/www/
# Ensure appuser has read/write access to the frontend assets
RUN chown -R appuser:appgroup /app/www

# These files/folders will be mounted as volumes during development
# COPY rss/ /rss/
# COPY src/api.py /app/www/api.py
# COPY reconstruct_api.py /tmp/reconstruct_api.py
# COPY playwright.config.js /app/playwright.config.js
# COPY tests/ /app/tests/
# COPY build_entrypoint.sh /build_entrypoint.sh

# Ensure clean copy of ui.spec.js by removing any old version first
RUN rm -f /app/tests/ui.spec.js

# Copy initial configuration files into the image
COPY ./data/config/rssFeeds.json /data/config/rssFeeds.json
COPY ./data/config/keywordBlacklist.json /data/config/keywordBlacklist.json
COPY data/ /data/feed/


RUN addgroup --system appgroup && adduser --system appuser --ingroup appgroup \
    && chown appuser:appgroup /tmp # Ensure /tmp is writable for non-root user

##############################################################################
# 5. Build entrypoint
# The entrypoint script will be mounted as a volume
# This section remains commented out because build_entrypoint.sh is volume mounted
# RUN cp /build_entrypoint.sh /usr/local/bin/docker-entrypoint.sh && \
#     chmod +x /usr/local/bin/docker-entrypoint.sh

##############################################################################


##############################################################################
# 7. Declare the data volume & expose ports
VOLUME /data
EXPOSE 80 443 4575

##############################################################################
# 8. Entrypoint + default CMD
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
