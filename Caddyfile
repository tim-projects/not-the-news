{
   email {$EMAIL}
   storage file_system /data
   acme_ca {$ACME_CA:https://acme-v02.api.letsencrypt.org/directory}
}

 {$DOMAIN} {

   # 1. Handle specific static files first.
   handle /sw.js {
     @no_redirect {
       not path /login.html
     }
     # This serves the file if it's a GET request
     file_server {
       root * /app/www
     }
   }
   handle /login.html {
     root * /app/www
     file_server
   }
   handle /manifest.json {
     root * /app/www
     file_server
   }

   # 2. Handle common static asset directories/patterns.
   handle /js/* {
     root * /app/www
     file_server
   }
   handle /*.css {
     root * /app/www
     file_server
   }
   handle /*.js {
     root * /app/www
     file_server
   }
   handle /*.svg {
     root * /app/www
     file_server
   }
   handle /*.ttf {
     root * /app/www
     file_server
   }
   handle /*.woff {
     root * /app/www
     file_server
   }
   handle /*.woff2 {
     root * /app/www
     file_server
   }
   handle /images/* {
     root * /app/www
     file_server
   }

   # 3. Handle API endpoints.
   handle /api/login* {
     reverse_proxy 127.0.0.1:4575 {
       header_up X-Forwarded-Proto https
       header_up Host {host}
     }
   }

   handle /api/user-state* {
     reverse_proxy 127.0.0.1:4575 {
       header_up X-Forwarded-Proto https
       header_up Host {host}
     }
   }
   handle /api/load-config* {
     reverse_proxy 127.0.0.1:4575 {
       header_up X-Forwarded-Proto https
       header_up Host {host}
     }
   }
   handle /api/save-config* {
     reverse_proxy 127.0.0.1:4575 {
       header_up X-Forwarded-Proto https
       header_up Host {host}
     }
   }
   handle /api/time* {
     reverse_proxy 127.0.0.1:4575 {
       header_up X-Forwarded-Proto https
       header_up Host {host}
     }
   }
   handle /api/feed-guids* {
     reverse_proxy 127.0.0.1:4575 {
       header_up X-Forwarded-Proto https
       header_up Host {host}
     }
   }

   handle /api/feed-items* {
     reverse_proxy 127.0.0.1:4575 {
       header_up X-Forwarded-Proto https
       header_up Host {host}
     }
   }

   # 4. Handle feed.xml specifically.
   @feed {
     path /feed.xml
   }
   handle @feed {
     root * /data/feed
     header {
       Access-Control-Allow-Origin   *
       Access-Control-Expose-Headers ETag, Last-Modified
     }
     file_server
   }

   # 5. Catch-all handle block for all *other* requests.
   handle {
     @unauth {
       not header Cookie auth*
     }
     redir @unauth /login.html 302

     # Serve the main application files as a fallback if no redirect happens.
     root * /app/www
     file_server
   }

   # Global directives outside of specific handle blocks (e.g., encoding)
   encode {
     br 11
     gzip 5
     match {
       header Content-Type text/html
       header Content-Type text/css
       header Content-Type application/javascript
       header Content-Type application/rss+xml
       header Content-Type application/xml
       header Content-Type text/xml
       header Content-Type application/json
     }
     minimum_length 512
   }

   # API no-cache headers can remain here, or be integrated into the /api/* handle blocks.
   @api_nocache {
     path /api/load-config*
     path /api/save-config*
     path /api/user-state*
   }
   header @api_nocache {
     Cache-Control "no-cache, no-store, must-revalidate"
     Pragma "no-cache"
     Expires "0"
   }
 }
