{
  email {$EMAIL}
  storage file_system /data
  acme_ca {$ACME_CA:https://acme-v02.api.letsencrypt.org/directory}
}

{$DOMAIN} {
  # This sets the web root for all requests.
  root * /app/www

  # A single handle block that processes requests in a precise order.
  handle {
    # 1. Handle API endpoints first
    @api {
      path /api/*
    }
    handle @api {
      reverse_proxy 127.0.0.1:4575 {
        header_up X-Forwarded-Proto https
        header_up Host {host}
      }
    }

    # 2. Handle specific feed.xml
    handle_path /feed.xml {
      root * /data/feed
      header {
        Access-Control-Allow-Origin *
        Access-Control-Expose-Headers ETag, Last-Modified
      }
      file_server
    }

    # 3. Handle the login redirect.
    # This rule is now explicitly at the top of the request chain.
    @unauth {
      not header Cookie auth*
      not path /login.html
      not path /sw.js
    }
    redir @unauth /login.html 302

    # 4. Serve all other files.
    file_server
  }

  # Global directives for encoding and no-cache headers.
  encode {
    br 11
    gzip 5
    match {
      header Content-Type text/html
      header Content-Type text/css
      header Content-Type application/javascript
      header Content-Type application/rss+xml
      header Content-Type application/xml
      header Content-Type text/xml
      header Content-Type application/json
    }
    minimum_length 512
  }

  @api_nocache {
    path /api/load-config*
    path /api/save-config*
    path /api/user-state*
  }
  header @api_nocache {
    Cache-Control "no-cache, no-store, must-revalidate"
    Pragma "no-cache"
    Expires "0"
  }
}