{
  email {$EMAIL}
  storage file_system /data
  acme_ca {$ACME_CA:https://acme-v02.api.letsencrypt.org/directory}
}

{$DOMAIN} {

  # 1. Handle specific static files first.
  # These files should always be served directly and never redirected.
  handle /sw.js, /login.html, /manifest.json { # Corrected: Grouped matchers with commas
    root * /app/www
    file_server
  }

  # 2. Handle common static asset directories/patterns.
  # This ensures all your JS, CSS, images, etc. are served directly.
  handle /js/*, /*.css, /*.js, /*.svg, /*.ttf, /*.woff, /*.woff2, /images/* { # Corrected: Grouped matchers with commas
    root * /app/www
    file_server
  }

  # 3. Handle API endpoints.
  # These will be reverse-proxied to your backend.
  handle /api/login* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }

  handle /api/user-state* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/load-config* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/save-config* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/time* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/feed-guids* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }

  handle /api/feed-items* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }

  # 4. Handle feed.xml specifically.
  @feed {
    path /feed.xml
  }
  handle @feed {
    root * /data/feed
    header {
      Access-Control-Allow-Origin   *
      Access-Control-Expose-Headers ETag, Last-Modified
    }
    file_server
  }

  # 5. Catch-all handle block for all *other* requests.
  # This is where your authentication redirect logic should now live.
  # Any request that hasn't been handled by the specific `handle` blocks above
  # will fall into this block.
  handle {
    @unauth {
      not header Cookie auth*
    }
    redir @unauth /login.html 302

    # Serve the main application files as a fallback if no redirect happens.
    root * /app/www
    file_server
  }

  # Global directives outside of specific handle blocks (e.g., encoding)
  encode {
    br 11
    gzip 5
    match {
      header Content-Type text/html
      header Content-Type text/css
      header Content-Type application/javascript
      header Content-Type application/rss+xml
      header Content-Type application/xml
      header Content-Type text/xml
      header Content-Type application/json
    }
    minimum_length 512
  }

  # API no-cache headers can remain here, or be integrated into the /api/* handle blocks.
  @api_nocache {
    path /api/load-config*
    path /api/save-config*
    path /api/user-state*
  }
  header @api_nocache {
    Cache-Control "no-cache, no-store, must-revalidate"
    Pragma "no-cache"
    Expires "0"
  }
}