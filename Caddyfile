{
  email {$EMAIL}
  storage file_system /data
  acme_ca {$ACME_CA:https://acme-v02.api.letsencrypt.org/directory}
}

{$DOMAIN} {
  # Explicitly handle common static files first to ensure they are never redirected.
  # Caddy will serve these directly and stop processing other rules for these paths.
  handle /sw.js
  handle /login.html
  handle /js/*
  handle /*.css
  handle /*.js
  handle /*.svg
  handle /*.ttf
  handle /*.woff
  handle /*.woff2
  handle /manifest.json
  handle /images/* {
    root * /app/www
    file_server
  }

  @unauth {
    not header Cookie auth*
    # Removed specific static file exclusions from here, as they are now handled
    # by the dedicated `handle` blocks above for robustness.
    # The API exclusions remain here.
    not path /api/login*
    not path /api/user-state*
    not path /api/load-config*
    not path /api/save-config*
    not path /api/time*
    not path /api/feed-guids*
    not path /api/feed-items*
    not path /api/user-state/shuffledOutGuids
  }
  redir @unauth /login.html 302

  # ALL 'handle' blocks for API endpoints must now include '/api/'
  handle /api/login* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }

  handle /api/user-state* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/load-config* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/save-config* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/time* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }
  handle /api/feed-guids* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }

  handle /api/feed-items* {
    reverse_proxy 127.0.0.1:4575 {
      header_up X-Forwarded-Proto https
      header_up Host {host}
    }
  }

  # This `root` and `file_server` will act as a general fallback for any static files
  # not explicitly handled by the `handle` blocks above.
  root * /app/www
  file_server

  encode {
    br 11
    gzip 5
    match {
      header Content-Type text/html
      header Content-Type text/css
      header Content-Type application/javascript
      header Content-Type application/rss+xml
      header Content-Type application/xml
      header Content-Type text/xml
      header Content-Type application/json
    }
    minimum_length 512
  }

  @api_nocache {
    path /api/load-config*
    path /api/save-config*
    path /api/user-state*
  }
  header @api_nocache {
    Cache-Control "no-cache, no-store, must-revalidate"
    Pragma "no-cache"
    Expires "0"
  }
  @feed {
    path /feed.xml
  }
  handle @feed {
    root * /data/feed
    header {
      Access-Control-Allow-Origin   *
      Access-Control-Expose-Headers ETag, Last-Modified
    }
    file_server
  }
}