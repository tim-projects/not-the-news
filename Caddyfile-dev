{
   storage file_system /data
}

http://:80 {

   # CRITICAL: Service worker must be first and accessible without any auth
   @service_worker {
     path_regexp ^/sw\.js$
   }
   handle @service_worker {
     root * /app/www
     file_server
   }

   # Other critical static files (no auth required)
   @static_files {
     path /login.html
     path /manifest.json
     path_regexp ^.*\.(css|js|svg|ttf|woff|woff2|png|jpg|jpeg|gif|ico|webp)$
     path /js/*
     path /images/*
     path /assets/*
   }
   handle @static_files {
     root * /app/www
     file_server
   }

   # API endpoints
   handle /api/* {
     # Unauthenticated /api/login endpoint
     handle /api/login {
       reverse_proxy 127.0.0.1:4575
     }

     # Authenticated API endpoints
     @protected_api {
       path /api/user-state*
       path /api/load-config*
       path /api/save-config*
       path /api/time*
       path /api/feed-guids*
       path /api/feed-items*
     }
     handle @protected_api {
       @unauth_check {
         not header Cookie auth*
       }
       respond @unauth_check "Unauthorized" 401
       
       reverse_proxy 127.0.0.1:4575
     }

     # API no-cache headers (apply to all API routes handled by the proxy)
     @api_nocache {
        path /api/load-config*
        path /api/save-config*
        path /api/user-state*
     }
     header @api_nocache {
       Cache-Control "no-cache, no-store, must-revalidate"
       Pragma "no-cache"
       Expires "0"
     }
   }

   # Handle feed.xml (accessible without auth)
   @feed {
     path /feed.xml
   }
   handle @feed {
     root * /data/feed
     header {
       Access-Control-Allow-Origin   *
       Access-Control-Expose-Headers ETag, Last-Modified
     }
     file_server
   }

   # Main application with auth redirect for everything else
   handle {
     @unauth_app {
       not header Cookie auth*
       not path /sw.js
       not path /login.html
       not path /manifest.json
       not path_regexp ^.*\.(css|js|svg|ttf|woff|woff2|png|jpg|jpeg|gif|ico|webp)$
       not path /js/*
       not path /images/*
       not path /assets/*
       not path /feed.xml
     }
     redir @unauth_app /login.html 302

     root * /app/www
     try_files {path} /index.html
     file_server
   }


}