# TODO - not to be worked on without explicit human permission

-----

III. Verification and Testing Plan
After implementing these changes, thorough testing will be critical:
Write and run tests for all the following. Fix any issues that arise.

Core App Initialization & Data Loading:

Basic Functionality:

- [ ] Verify starring/unstarring and hiding/unhiding items works locally and syncs correctly to the server.

- [ ] Verify "Next Deck" and "Shuffle" functionality works.

- [ ] Verify all other user preferences (theme, new tab, images, filter mode) save and load correctly.

rssFeeds & keywordBlacklist:

- [ ] Verify user can input RSS feed URLs and keyword blacklists, save them, and they persist correctly on the server in the CONFIG_DIR.

- [ ] Verify changes made on one client reflect on another client after refresh/sync.

Crucially, verify that these do not appear in the USER_STATE_DIR on the server anymore.

Sync Behavior:

- [ ] Observe network traffic for currentDeckGuids updates (should be full array, but small).

- [ ] Observe network traffic for rssFeeds and keywordBlacklist updates (should be full file transfers via save-config).

- [ ] Observe network traffic for starred/hidden updates (should be small delta objects).

- [ ] Verify If-None-Match caching for GET /user-state/<key> works as expected (304 responses).

- [ ] Offline Functionality: Ensure the application continues to function robustly when offline, leveraging IndexedDB for all relevant user state and feed data.d


- fix the wrong url on reddit/wired titles
- implement a hidden pop up bar and flash a toast message when syncing, if something went wrong saving the state, or when syncing/internet disconnected. This should cover the top header while it's active, and hide after 1 second of inactivity.

- improve repo structure for ai

I want you to review the entire codebase and create a report - FUNCTIONS-MAP.md. In this file I want you to create a human readible log of each file and the        â”‚
â”‚   functions it contains. As part of this process, I want you to record how manage lines of code each function uses. My goal here is to eventually rewrite the         â”‚
â”‚   codebase to ensure that each file aims to be a maximum 300 lines. But it should make sense with which function is stored where. So I need this                      â”‚
â”‚   FUNCTIONS-MAP.md so that I can think of a new repo structure

You still need to fix loading configs to and from the server, and make sure the shuffle is working properly

# LATER
- If the user clears 3 decks in a day, before showing the 4th deck, pick a random starred card, show them it and encourage them to expunge it (i.e. set it to unstarred and hidden). offer a button under the card to skip the expunge and continue as normal - i.e. generate a new currentdeck.
- When an item is hidden, imediatelly show an undo button in tbe bottom left for 5 seconds, which when pressed would restore unhidden status of that item and place it back in the deck. After 5 seconds of not being pressed the button would fade out and disappear, or if pressed disappear immediately.
- insyead of just dark/light themes  Create a drop down and offer the user afew themes of each (but still default the the existing dark theme).
- Add a custom theme option to the theme dropdown. When selected a configure button appears in the settings. Pressing this button opens a new test area showing a custom editable style sheet. This would overwrite the root variables in the stylesheet by default. The custom style sheet would be saved for the user, and enabled as long as the theme dropdown is set to custome theme.
- Add a locally stored setting to increase or decrease the global font size (this doesn't need to be syncd because its device specific), but it night be better to store it globally with a device fingerprint so it could be restored later. The global font size setting would be in a percentage ranging from 50% to 200% and add a modifier to all fonts to change their relative sizings..

- Keyword whitelist. 
This is a list of keywords that override your blacklist. This feature can be used to ensure that if you do need to catch current or timely events that you have a way to do so.

for example. Adding a keyword set of 'breaking, war' will promote to the top any items that contain both these keywords.
- if reddit description contains [link], if it's an i.reddit.it image, rewrite the link as an img tag, if it's v.reddit.it rewrite the link as a video tag, otherwise set the <link> tag to it. Hide the [link]

- AI based feed tastemaking
Ambitious idea to build an algo that auto finds new rss feeds based on the users app interactions

```
Hereâ€™s the **fully updated design prompt** with all the enhancements weâ€™ve discussed:

---

# âœ… Personalized Feed Ranking & News Control

*(for app: **Not The News**)*

---

## **Core Concept**

A vertical feed app serving **10-card decks**.
Each item = an enriched RSS entry with:

* **Category** (Tier 1)
* **Subcategory** (Tier 2)
* **Timeliness Tag** (Tier 3: `breaking`, `recent`, `evergreen`)
* **Hash** (for fast relevance scoring)

User interactions:

* Scroll, Star, Hide, Click, Shuffle, Clear Deck.

Goal:

* Personalize feed for **long-term interests**, **balanced variety**, **controlled timeliness**.
* Avoid addiction loops & doomscrolling.
* Allow news for engagement but prevent full takeover.

---

## âœ… **Event Logging**

Minimal but rich logs:

```json
{
  "event": "enter" | "exit" | "star" | "hide" | "click" | "shuffle" | "clear_deck",
  "cardId": "uuid",
  "deckId": "uuid",
  "timestamp": 1721209824,
  "meta": {
    "direction": "up" | "down",  
    "gesture": "drag" | "flick"  
  }
}
```

---

## âœ… **Content Enrichment (Server-Side)**

Each RSS item â†’ enriched with:

```json
{
  "id": "uuid",
  "title": "...",
  "url": "...",
  "category": "Technology",
  "subcategory": "AI",
  "timeliness": "breaking", // breaking, recent, evergreen
  "hash": "hash_of_keywords",
  "media": {"images": 1, "videos": 0, "audio": 0}
}
```

### Category & Subcategory Extraction

* Use **keyword siloing** + **LLM API** (Gemini Flash or similar) for classification.
* Hash generated from normalized keyword set.

---

## âœ… **User Profile**

```json
{
  "keywords": [
    {"term": "AI", "long_term": 12.0, "short_term": 3.0},
    {"term": "blockchain", "long_term": -7.0, "short_term": -1.5}
  ],
  "media_prefs": {
    "images": 5.3,
    "videos": 8.2,
    "audio": -2.1,
    "text_only": 1.0
  },
  "meta": {
    "shuffles_today": 3,
    "decks_cleared_today": 2,
    "timeliness_factor": 1.0,
    "engagement_score": 0.82
  }
}
```

---

## âœ… **Three-Tier Interest Model**

* **Tier 1:** Category (stable identity)
* **Tier 2:** Subcategory (granular context)
* **Tier 3:** Timeliness Tag

  * `breaking` (+15), `recent` (+5), `evergreen` (0)
  * Aggressive decay:
    Breaking â†’ half-life = 30 min
    Recent â†’ half-life = 6â€“12h

Combined weight:

```
final_weight(term) = (long_term * 0.7) + (short_term * 1.3)
```

---

## âœ… **Signals & Behavior Scoring**

```
Star: +20
Click: +10
Dwell >5s: +5
Dwell 1â€“5s: +1
<1s: -5
Hide fast (<1s): -15
Flick away: -10
Clear after reading: +10
Shuffle spam: penalty (anti-addiction)
```

---

## âœ… **News Saturation Penalty**

* Track news ratio:

```
news_ratio = news_engagements / total_engagements
```

* If `news_ratio > 0.3`:

```
penalty = (news_ratio - 0.3) * Î²
adjusted_score = score - penalty
```

---

## âœ… **Deck Diversity Rules**

* Max **3 news items** per 10-card deck (normal mode).
* Always mix evergreen or interest-based cards.

---

## âœ… **Re-engagement Mode**

If engagement drops below 70% of baseline:

* Activate:

  * `timeliness_boost_factor = 1.5â€“2.0`
  * Max news per deck = 5
  * Halve saturation penalty.
* Deactivate gradually over 3â€“5 decks.

---

## âœ… **Trigger Category Control**

* Track "trigger\_score" for rage-bait categories.
* If too high:

```
adjusted_category_score = category_score * (1 - trigger_penalty)
```

---

## âœ… **Ranking Formula**

```
final_score =
    behavior_score
  + (keyword_score * 1.0)
  + media_score
  + (timeliness_score * user_timeliness_factor * timeliness_boost_factor)
  - saturation_penalty
```

---

## âœ… **Retention Rules**

* Long-term decay: 0.99 per cycle (never zero).
* Short-term decay: 0.9 per cycle.
* Maintain baseline profile for stability.

---

## âœ… **Pipeline Summary**

1. Aggregate & clean RSS feeds.
2. Enrich items:

   * Category, subcategory, timeliness, hash.
3. Rank on **server** using profile + rules.
4. Push **pre-ranked pool** to client.
5. Client picks 10-card decks (light shuffle allowed).

---

### âœ… **Optional Hash Optimization**

* Hash = minhash or simhash of keywords â†’ enables fast similarity checks.
* Profile still keeps **\~150 keywords** for fine-grain personalization.

---

ðŸ”¥ This design ensures:

* Personalized content.
* Controlled timeliness influence.
* Anti-addiction + diversity bias.
* Engagement recovery without spam.
* Server does heavy lifting â†’ client lightweight.

```
