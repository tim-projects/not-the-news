# TODO
- major db/sync refactor

-----

### **Prompt for `www/js/data/database.js`**

**File Path:** `www/js/data/database.js`

**Overall Goal:** Refactor IndexedDB access to guarantee a resolved `IDBDatabase` instance, eliminating direct `db` exports and centralizing instance retrieval. Add new user settings for scroll position tracking.

**Instructions:** Do not reflect on the issues. Just do exactly what is asked.

1.  **Remove Global Export:** Delete the line `export let db = null;`.
2.  **Introduce Internal State:** Add two new module-scoped variables *after* the `DB_VERSION` constant:
      * `let _dbInstance = null;`
      * `let _dbInitPromise = null;`
3.  **Modify `initDb` Function:**
      * At the very beginning of `initDb`, add: `if (_dbInitPromise) return _dbInitPromise;`
      * Change the line `db = await openDB(...)` to `_dbInitPromise = openDB(...)`.
      * Change the line `db = await _dbInitPromise;` to `_dbInstance = await _dbInitPromise;`.
      * Change the return to `return _dbInstance;`.
4.  **Add `getDb` Function:** Create a new exported asynchronous function `getDb()`:
    ```javascript
    export async function getDb() {
        if (!_dbInstance) {
            await initDb();
        }
        return _dbInstance;
    }
    ```
5.  **Update `USER_STATE_DEFS`:** Add two new entries to the `USER_STATE_DEFS` object:
    ```javascript
    lastViewedItemId: { store: 'userSettings', type: 'simple', default: null },
    lastViewedItemOffset: { store: 'userSettings', type: 'simple', default: 0 },
    ```
6.  **Update `get...()` Helper Functions:** For *every* exported `async function get...()` at the bottom of the file (e.g., `getStarredItems`, `getHiddenItems`, `getFilterMode`, etc.), change the first line from `await initDb();` to `const db = await getDb();`.
7.  **Crucial Constraint:** DO NOT add `db` as a parameter to `loadSimpleState`, `saveSimpleState`, etc., as they already correctly accept it.

**Provide the complete, modified content for `www/js/data/database.js`.**

-----

### **Prompt for `www/js/app.js`**

**File Path:** `www/js/app.js`

**Overall Goal:** Orchestrate database initialization and pass the resolved `IDBDatabase` instance (`this.db`) to all helper functions and Alpine methods that require it. Implement the Intersection Observer for scroll position saving.

**Instructions:** Do not reflect on the issues. Just do exactly what is asked.

1.  **Update Imports:**
      * Ensure `db` is *not* imported from `database.js`.
      * Ensure `initDb`, `performFullSync`, `pullUserState`, `processPendingOperations`, `loadSimpleState`, `loadArrayState`, `getBufferedChangesCount` are imported from `database.js`.
      * Ensure all necessary `init*` functions (`initSyncToggle`, `initImagesToggle`, `initTheme`, `initScrollPosition`, `initShuffleCount`, `initConfigPanelListeners`) are imported from `uiInitializers.js`.
      * Ensure `validateAndRegenerateCurrentDeck`, `loadNextDeck`, `shuffleFeed` are imported from `dataUtils.js`.
      * Ensure `toggleStar`, `toggleHidden`, `loadCurrentDeck`, `saveCurrentDeck`, `loadShuffleState`, `saveShuffleState`, `setFilterMode`, `loadFilterMode` are imported from `userStateUtils.js`.
2.  **Add Properties to Alpine Data:** Inside the `Alpine.data('app', () => ({...}))` object, add:
      * `db: null,`
      * `scrollObserver: null,`
3.  **Modify `initApp()` Method:**
      * At the start of `initApp`, change the line initializing the database to: `this.db = await initDb();`
      * **Crucial:** For *every* function call within `initApp()` that requires the `db` instance (e.g., `initSyncToggle`, `initImagesToggle`, `initTheme`, `initScrollPosition`, `initShuffleCount`, `loadSimpleState`, `loadArrayState`, `performFullSync`, `processPendingOperations`, `getBufferedChangesCount`, `loadCurrentDeck`, `saveCurrentDeck`, `setFilterMode`, `loadFilterMode`), ensure `this.db` is passed as an argument.
          * Example change: `await initSyncToggle(this);` becomes `await initSyncToggle(this, this.db);`
          * Example change: `await loadSimpleState('syncEnabled')` (if it was ever directly called without `db`) becomes `await loadSimpleState(this.db, 'syncEnabled')`.
      * Call `await initScrollPosition(this, this.db);` *after* `this.loadFeedItemsFromDB();`
      * Call `this.initScrollObserver();` *after* `initScrollPosition()` and `this.loadFeedItemsFromDB()`.
4.  **Add `initScrollObserver()` Method:** Implement the `initScrollObserver` method as described in the plan, inside the Alpine data object.
      * It must use `this.db` for `saveSimpleState` and `addPendingOperation`.
      * It must observe elements with `data-guid` attributes inside `#feed-container`.
      * It must include the `MutationObserver` logic to re-observe if `feed-container`'s children change.
5.  **Modify Other Alpine Methods:** For any existing Alpine method within `app.js` (e.g., `loadFeedItemsFromDB`, `updateCounts`, `displayCurrentDeck`, `saveFilterMode`, `handleShuffleDeck`, etc.) that directly interacts with IndexedDB or calls a helper that uses DB, ensure it uses `this.db` for its operations.
      * Example: If `loadFeedItemsFromDB` was `db.transaction(...)`, change it to `this.db.transaction(...)`.
      * Example: If `updateCounts` calls `getStarredItems()`, that function will handle `db` itself. But if `updateCounts` calls a *new* helper that needs `db`, ensure `this.db` is passed.

**Crucial Constraints:**

  * DO NOT import `db` directly from `database.js`.
  * DO NOT remove or change the `x-data` or `x-init` attributes on your main Alpine component.
  * Ensure that every call to a function that requires `db` explicitly passes `this.db`.

**Provide the complete, modified content for `www/js/app.js`.**

-----

### **Prompt for `www/js/helpers/userStateUtils.js`**

**File Path:** `www/js/helpers/userStateUtils.js`

**Overall Goal:** Decouple from direct `db` import and ensure `toggleStar` and `toggleHidden` explicitly receive the resolved `IDBDatabase` instance as a parameter.

**Instructions:** Do not reflect on the issues. Just do exactly what is asked.

1.  **Remove `db` Import:** Delete `db,` from the import statement for `../data/database.js`.
2.  **Modify `toggleStar` Function Signature:** Change its signature from `(app, guid)` to `(app, db, guid)`.
3.  **Modify `toggleHidden` Function Signature:** Change its signature from `(app, guid)` to `(app, db, guid)`.
4.  **Crucial Constraint:** DO NOT change the function signatures or internal logic for `pruneStaleHidden`, `loadCurrentDeck`, `saveCurrentDeck`, `loadShuffleState`, `saveShuffleState`, `setFilterMode`, or `loadFilterMode`, as these already correctly accept `db` as a parameter.

**Provide the complete, modified content for `www/js/helpers/userStateUtils.js`.**

-----

### **Prompt for `www/js/ui/uiInitializers.js`**

**File Path:** `www/js/ui/uiInitializers.js`

**Overall Goal:** Remove direct `db` import. Ensure all UI initialization functions that interact with the database explicitly receive the resolved `IDBDatabase` instance as a parameter. Implement the new `initScrollPosition` logic.

**Instructions:** Do not reflect on the issues. Just do exactly what is asked.

1.  **Update Imports:**
      * Remove `db,` from the import statement for `../data/database.js`.
      * Ensure `isOnline` is also imported from `../data/database.js`.
2.  **Modify Function Signatures and Internal `db` Usage:** For the following functions, add `db` as the second parameter (after `app`), and ensure all internal calls to `loadSimpleState`, `saveSimpleState`, `addPendingOperation`, `processPendingOperations`, `performFullSync` correctly pass this `db` parameter:
      * `setupBooleanToggle(app, db, getToggleEl, getTextEl, dbKey, onToggleCb)`
      * `initSyncToggle(app, db)`
      * `initImagesToggle(app, db)`
      * `initTheme(app, db)`
      * `initShuffleCount(app, db)`
3.  **Replace `initScrollPosition` Logic:** Completely replace the existing `initScrollPosition` function with the new implementation:
      * It must accept `app, db` as parameters.
      * It must load `lastViewedItemId` and `lastViewedItemOffset` using `loadSimpleState(db, ...)`.
      * It must use `document.querySelector(`.entry[data-guid="${lastViewedItemId}"]`)` to find the target element.
      * It must use `targetEl.scrollIntoView()` and optionally `window.scrollBy()` for position restoration.
      * It must wrap the scroll logic in `window.requestAnimationFrame()`.
4.  **Replace `navigator.onLine`:** Wherever `navigator.onLine` is directly used within `setupBooleanToggle` or `initTheme`, replace it with a call to the imported `isOnline()` function.
5.  **Crucial Constraint:** DO NOT modify the `initConfigPanelListeners` function signature, as it does not directly use `db`.

**Provide the complete, modified content for `www/js/ui/uiInitializers.js`.**

-----

### **Prompt for `www/js/helpers/dataUtils.js`**

**File Path:** `www/js/helpers/dataUtils.js`

**Overall Goal:** Ensure helper functions that interact with user state (via `userStateUtils.js` functions like `saveShuffleState`, `saveCurrentDeck`) receive the resolved `IDBDatabase` instance as a parameter.

**Instructions:** Do not reflect on the issues. Just do exactly what is asked.

1.  **Check Imports:** Ensure `db` is *not* imported from `../data/database.js` if it currently is.
2.  **Modify Function Signatures:** For the following functions, add `db` as the second parameter (after `app`):
      * `validateAndRegenerateCurrentDeck(app, db)`
      * `loadNextDeck(app, db)`
      * `shuffleFeed(app, db)`
3.  **Ensure `db` is Passed Down:** Within the modified functions, ensure that `db` is passed to any calls to functions that require it, such as `saveShuffleState(db, ...)` or `saveCurrentDeck(db, ...)`.

**Crucial Constraint:** DO NOT add `db` as a parameter to any other functions in this file not explicitly listed, unless it's a new helper function you are adding that directly uses `db`.

**Provide the complete, modified content for `www/js/helpers/dataUtils.js`.**



- fix the wrong url on reddit/wired titles
- implement a hidden pop up bar and flash a toast message when syncing, if something went wrong saving the state, or when syncing/internet disconnected. This should cover the top header while it's active, and hide after 1 second of inactivity.


# LATER
- Add a custom theme styling box in the settings.

- Keyword whitelist. 
This is a list of keywords that override your blacklist. This feature can be used to ensure that if you do need to catch current or timely events that you have a way to do so.

for example. Adding a keyword set of 'breaking, war' will promote to the top any items that contain both these keywords.
- if reddit description contains [link], if it's an i.reddit.it image, rewrite the link as an img tag, if it's v.reddit.it rewrite the link as a video tag, otherwise set the <link> tag to it. Hide the [link]

- AI based feed tastemaking
Ambitious idea to build an algo that auto finds new rss feeds based on the users app interactions

```
Hereâ€™s the **fully updated design prompt** with all the enhancements weâ€™ve discussed:

---

# âœ… Personalized Feed Ranking & News Control

*(for app: **Not The News**)*

---

## **Core Concept**

A vertical feed app serving **10-card decks**.
Each item = an enriched RSS entry with:

* **Category** (Tier 1)
* **Subcategory** (Tier 2)
* **Timeliness Tag** (Tier 3: `breaking`, `recent`, `evergreen`)
* **Hash** (for fast relevance scoring)

User interactions:

* Scroll, Star, Hide, Click, Shuffle, Clear Deck.

Goal:

* Personalize feed for **long-term interests**, **balanced variety**, **controlled timeliness**.
* Avoid addiction loops & doomscrolling.
* Allow news for engagement but prevent full takeover.

---

## âœ… **Event Logging**

Minimal but rich logs:

```json
{
  "event": "enter" | "exit" | "star" | "hide" | "click" | "shuffle" | "clear_deck",
  "cardId": "uuid",
  "deckId": "uuid",
  "timestamp": 1721209824,
  "meta": {
    "direction": "up" | "down",  
    "gesture": "drag" | "flick"  
  }
}
```

---

## âœ… **Content Enrichment (Server-Side)**

Each RSS item â†’ enriched with:

```json
{
  "id": "uuid",
  "title": "...",
  "url": "...",
  "category": "Technology",
  "subcategory": "AI",
  "timeliness": "breaking", // breaking, recent, evergreen
  "hash": "hash_of_keywords",
  "media": {"images": 1, "videos": 0, "audio": 0}
}
```

### Category & Subcategory Extraction

* Use **keyword siloing** + **LLM API** (Gemini Flash or similar) for classification.
* Hash generated from normalized keyword set.

---

## âœ… **User Profile**

```json
{
  "keywords": [
    {"term": "AI", "long_term": 12.0, "short_term": 3.0},
    {"term": "blockchain", "long_term": -7.0, "short_term": -1.5}
  ],
  "media_prefs": {
    "images": 5.3,
    "videos": 8.2,
    "audio": -2.1,
    "text_only": 1.0
  },
  "meta": {
    "shuffles_today": 3,
    "decks_cleared_today": 2,
    "timeliness_factor": 1.0,
    "engagement_score": 0.82
  }
}
```

---

## âœ… **Three-Tier Interest Model**

* **Tier 1:** Category (stable identity)
* **Tier 2:** Subcategory (granular context)
* **Tier 3:** Timeliness Tag

  * `breaking` (+15), `recent` (+5), `evergreen` (0)
  * Aggressive decay:
    Breaking â†’ half-life = 30 min
    Recent â†’ half-life = 6â€“12h

Combined weight:

```
final_weight(term) = (long_term * 0.7) + (short_term * 1.3)
```

---

## âœ… **Signals & Behavior Scoring**

```
Star: +20
Click: +10
Dwell >5s: +5
Dwell 1â€“5s: +1
<1s: -5
Hide fast (<1s): -15
Flick away: -10
Clear after reading: +10
Shuffle spam: penalty (anti-addiction)
```

---

## âœ… **News Saturation Penalty**

* Track news ratio:

```
news_ratio = news_engagements / total_engagements
```

* If `news_ratio > 0.3`:

```
penalty = (news_ratio - 0.3) * Î²
adjusted_score = score - penalty
```

---

## âœ… **Deck Diversity Rules**

* Max **3 news items** per 10-card deck (normal mode).
* Always mix evergreen or interest-based cards.

---

## âœ… **Re-engagement Mode**

If engagement drops below 70% of baseline:

* Activate:

  * `timeliness_boost_factor = 1.5â€“2.0`
  * Max news per deck = 5
  * Halve saturation penalty.
* Deactivate gradually over 3â€“5 decks.

---

## âœ… **Trigger Category Control**

* Track "trigger\_score" for rage-bait categories.
* If too high:

```
adjusted_category_score = category_score * (1 - trigger_penalty)
```

---

## âœ… **Ranking Formula**

```
final_score =
    behavior_score
  + (keyword_score * 1.0)
  + media_score
  + (timeliness_score * user_timeliness_factor * timeliness_boost_factor)
  - saturation_penalty
```

---

## âœ… **Retention Rules**

* Long-term decay: 0.99 per cycle (never zero).
* Short-term decay: 0.9 per cycle.
* Maintain baseline profile for stability.

---

## âœ… **Pipeline Summary**

1. Aggregate & clean RSS feeds.
2. Enrich items:

   * Category, subcategory, timeliness, hash.
3. Rank on **server** using profile + rules.
4. Push **pre-ranked pool** to client.
5. Client picks 10-card decks (light shuffle allowed).

---

### âœ… **Optional Hash Optimization**

* Hash = minhash or simhash of keywords â†’ enables fast similarity checks.
* Profile still keeps **\~150 keywords** for fine-grain personalization.

---

ðŸ”¥ This design ensures:

* Personalized content.
* Controlled timeliness influence.
* Anti-addiction + diversity bias.
* Engagement recovery without spam.
* Server does heavy lifting â†’ client lightweight.

```