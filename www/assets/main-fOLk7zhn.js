import{o as xi,a as U,b as $i,d as Mi,u as Bi,s as Li}from"./firebase-DWrEhQvN.js";const Ri="modulepreload",Pi=function(e){return"/"+e},Bn={},j=function(t,n,s){let i=Promise.resolve();if(n&&n.length>0){let c=function(u){return Promise.all(u.map(d=>Promise.resolve(d).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");i=c(n.map(u=>{if(u=Pi(u),u in Bn)return;Bn[u]=!0;const d=u.endsWith(".css"),f=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${f}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":Ri,d||(h.as="script"),h.crossOrigin="",h.href=u,l&&h.setAttribute("nonce",l),document.head.appendChild(h),d)return new Promise((p,O)=>{h.addEventListener("load",p),h.addEventListener("error",()=>O(new Error(`Unable to preload CSS for ${u}`)))})}))}function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return i.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return t().catch(r)})};var Lt=!1,Rt=!1,me=[],Pt=-1;function Fi(e){Gi(e)}function Gi(e){me.includes(e)||me.push(e),ji()}function Ni(e){let t=me.indexOf(e);t!==-1&&t>Pt&&me.splice(t,1)}function ji(){!Rt&&!Lt&&(Lt=!0,queueMicrotask(Ui))}function Ui(){Lt=!1,Rt=!0;for(let e=0;e<me.length;e++)me[e](),Pt=e;me.length=0,Pt=-1,Rt=!1}var Ce,_e,Oe,Qn,Ft=!0;function zi(e){Ft=!1,e(),Ft=!0}function Vi(e){Ce=e.reactive,Oe=e.release,_e=t=>e.effect(t,{scheduler:n=>{Ft?Fi(n):n()}}),Qn=e.raw}function Ln(e){_e=e}function Wi(e){let t=()=>{};return[s=>{let i=_e(s);return e._x_effects||(e._x_effects=new Set,e._x_runEffects=()=>{e._x_effects.forEach(r=>r())}),e._x_effects.add(i),t=()=>{i!==void 0&&(e._x_effects.delete(i),Oe(i))},i},()=>{t()}]}function Xn(e,t){let n=!0,s,i=_e(()=>{let r=e();JSON.stringify(r),n?s=r:queueMicrotask(()=>{t(r,s),s=r}),n=!1});return()=>Oe(i)}var Zn=[],es=[],ts=[];function Hi(e){ts.push(e)}function cn(e,t){typeof t=="function"?(e._x_cleanups||(e._x_cleanups=[]),e._x_cleanups.push(t)):(t=e,es.push(t))}function ns(e){Zn.push(e)}function ss(e,t,n){e._x_attributeCleanups||(e._x_attributeCleanups={}),e._x_attributeCleanups[t]||(e._x_attributeCleanups[t]=[]),e._x_attributeCleanups[t].push(n)}function is(e,t){e._x_attributeCleanups&&Object.entries(e._x_attributeCleanups).forEach(([n,s])=>{(t===void 0||t.includes(n))&&(s.forEach(i=>i()),delete e._x_attributeCleanups[n])})}function Ki(e){for(e._x_effects?.forEach(Ni);e._x_cleanups?.length;)e._x_cleanups.pop()()}var un=new MutationObserver(gn),dn=!1;function fn(){un.observe(document,{subtree:!0,childList:!0,attributes:!0,attributeOldValue:!0}),dn=!0}function rs(){qi(),un.disconnect(),dn=!1}var Le=[];function qi(){let e=un.takeRecords();Le.push(()=>e.length>0&&gn(e));let t=Le.length;queueMicrotask(()=>{if(Le.length===t)for(;Le.length>0;)Le.shift()()})}function x(e){if(!dn)return e();rs();let t=e();return fn(),t}var hn=!1,lt=[];function Ji(){hn=!0}function Yi(){hn=!1,gn(lt),lt=[]}function gn(e){if(hn){lt=lt.concat(e);return}let t=[],n=new Set,s=new Map,i=new Map;for(let r=0;r<e.length;r++)if(!e[r].target._x_ignoreMutationObserver&&(e[r].type==="childList"&&(e[r].removedNodes.forEach(a=>{a.nodeType===1&&a._x_marker&&n.add(a)}),e[r].addedNodes.forEach(a=>{if(a.nodeType===1){if(n.has(a)){n.delete(a);return}a._x_marker||t.push(a)}})),e[r].type==="attributes")){let a=e[r].target,l=e[r].attributeName,c=e[r].oldValue,u=()=>{s.has(a)||s.set(a,[]),s.get(a).push({name:l,value:a.getAttribute(l)})},d=()=>{i.has(a)||i.set(a,[]),i.get(a).push(l)};a.hasAttribute(l)&&c===null?u():a.hasAttribute(l)?(d(),u()):d()}i.forEach((r,a)=>{is(a,r)}),s.forEach((r,a)=>{Zn.forEach(l=>l(a,r))});for(let r of n)t.some(a=>a.contains(r))||es.forEach(a=>a(r));for(let r of t)r.isConnected&&ts.forEach(a=>a(r));t=null,n=null,s=null,i=null}function os(e){return qe(Ee(e))}function Ke(e,t,n){return e._x_dataStack=[t,...Ee(n||e)],()=>{e._x_dataStack=e._x_dataStack.filter(s=>s!==t)}}function Ee(e){return e._x_dataStack?e._x_dataStack:typeof ShadowRoot=="function"&&e instanceof ShadowRoot?Ee(e.host):e.parentNode?Ee(e.parentNode):[]}function qe(e){return new Proxy({objects:e},Qi)}var Qi={ownKeys({objects:e}){return Array.from(new Set(e.flatMap(t=>Object.keys(t))))},has({objects:e},t){return t==Symbol.unscopables?!1:e.some(n=>Object.prototype.hasOwnProperty.call(n,t)||Reflect.has(n,t))},get({objects:e},t,n){return t=="toJSON"?Xi:Reflect.get(e.find(s=>Reflect.has(s,t))||{},t,n)},set({objects:e},t,n,s){const i=e.find(a=>Object.prototype.hasOwnProperty.call(a,t))||e[e.length-1],r=Object.getOwnPropertyDescriptor(i,t);return r?.set&&r?.get?r.set.call(s,n)||!0:Reflect.set(i,t,n)}};function Xi(){return Reflect.ownKeys(this).reduce((t,n)=>(t[n]=Reflect.get(this,n),t),{})}function as(e){let t=s=>typeof s=="object"&&!Array.isArray(s)&&s!==null,n=(s,i="")=>{Object.entries(Object.getOwnPropertyDescriptors(s)).forEach(([r,{value:a,enumerable:l}])=>{if(l===!1||a===void 0||typeof a=="object"&&a!==null&&a.__v_skip)return;let c=i===""?r:`${i}.${r}`;typeof a=="object"&&a!==null&&a._x_interceptor?s[r]=a.initialize(e,c,r):t(a)&&a!==s&&!(a instanceof Element)&&n(a,c)})};return n(e)}function ls(e,t=()=>{}){let n={initialValue:void 0,_x_interceptor:!0,initialize(s,i,r){return e(this.initialValue,()=>Zi(s,i),a=>Gt(s,i,a),i,r)}};return t(n),s=>{if(typeof s=="object"&&s!==null&&s._x_interceptor){let i=n.initialize.bind(n);n.initialize=(r,a,l)=>{let c=s.initialize(r,a,l);return n.initialValue=c,i(r,a,l)}}else n.initialValue=s;return n}}function Zi(e,t){return t.split(".").reduce((n,s)=>n[s],e)}function Gt(e,t,n){if(typeof t=="string"&&(t=t.split(".")),t.length===1)e[t[0]]=n;else{if(t.length===0)throw error;return e[t[0]]||(e[t[0]]={}),Gt(e[t[0]],t.slice(1),n)}}var cs={};function J(e,t){cs[e]=t}function Nt(e,t){let n=er(t);return Object.entries(cs).forEach(([s,i])=>{Object.defineProperty(e,`$${s}`,{get(){return i(t,n)},enumerable:!1})}),e}function er(e){let[t,n]=ms(e),s={interceptor:ls,...t};return cn(e,n),s}function tr(e,t,n,...s){try{return n(...s)}catch(i){We(i,e,t)}}function We(e,t,n=void 0){e=Object.assign(e??{message:"No error message given."},{el:t,expression:n}),console.warn(`Alpine Expression Error: ${e.message}

${n?'Expression: "'+n+`"

`:""}`,t),setTimeout(()=>{throw e},0)}var it=!0;function us(e){let t=it;it=!1;let n=e();return it=t,n}function ye(e,t,n={}){let s;return G(e,t)(i=>s=i,n),s}function G(...e){return ds(...e)}var ds=fs;function nr(e){ds=e}function fs(e,t){let n={};Nt(n,e);let s=[n,...Ee(e)],i=typeof t=="function"?sr(s,t):rr(s,t,e);return tr.bind(null,e,t,i)}function sr(e,t){return(n=()=>{},{scope:s={},params:i=[]}={})=>{let r=t.apply(qe([s,...e]),i);ct(n,r)}}var vt={};function ir(e,t){if(vt[e])return vt[e];let n=Object.getPrototypeOf(async function(){}).constructor,s=/^[\n\s]*if.*\(.*\)/.test(e.trim())||/^(let|const)\s/.test(e.trim())?`(async()=>{ ${e} })()`:e,r=(()=>{try{let a=new n(["__self","scope"],`with (scope) { __self.result = ${s} }; __self.finished = true; return __self.result;`);return Object.defineProperty(a,"name",{value:`[Alpine] ${e}`}),a}catch(a){return We(a,t,e),Promise.resolve()}})();return vt[e]=r,r}function rr(e,t,n){let s=ir(t,n);return(i=()=>{},{scope:r={},params:a=[]}={})=>{s.result=void 0,s.finished=!1;let l=qe([r,...e]);if(typeof s=="function"){let c=s(s,l).catch(u=>We(u,n,t));s.finished?(ct(i,s.result,l,a,n),s.result=void 0):c.then(u=>{ct(i,u,l,a,n)}).catch(u=>We(u,n,t)).finally(()=>s.result=void 0)}}}function ct(e,t,n,s,i){if(it&&typeof t=="function"){let r=t.apply(n,s);r instanceof Promise?r.then(a=>ct(e,a,n,s)).catch(a=>We(a,i,t)):e(r)}else typeof t=="object"&&t instanceof Promise?t.then(r=>e(r)):e(t)}var mn="x-";function Te(e=""){return mn+e}function or(e){mn=e}var ut={};function B(e,t){return ut[e]=t,{before(n){if(!ut[n]){console.warn(String.raw`Cannot find directive \`${n}\`. \`${e}\` will use the default order of execution`);return}const s=ge.indexOf(n);ge.splice(s>=0?s:ge.indexOf("DEFAULT"),0,e)}}}function ar(e){return Object.keys(ut).includes(e)}function yn(e,t,n){if(t=Array.from(t),e._x_virtualDirectives){let r=Object.entries(e._x_virtualDirectives).map(([l,c])=>({name:l,value:c})),a=hs(r);r=r.map(l=>a.find(c=>c.name===l.name)?{name:`x-bind:${l.name}`,value:`"${l.value}"`}:l),t=t.concat(r)}let s={};return t.map(ws((r,a)=>s[r]=a)).filter(bs).map(ur(s,n)).sort(dr).map(r=>cr(e,r))}function hs(e){return Array.from(e).map(ws()).filter(t=>!bs(t))}var jt=!1,Ne=new Map,gs=Symbol();function lr(e){jt=!0;let t=Symbol();gs=t,Ne.set(t,[]);let n=()=>{for(;Ne.get(t).length;)Ne.get(t).shift()();Ne.delete(t)},s=()=>{jt=!1,n()};e(n),s()}function ms(e){let t=[],n=l=>t.push(l),[s,i]=Wi(e);return t.push(i),[{Alpine:Je,effect:s,cleanup:n,evaluateLater:G.bind(G,e),evaluate:ye.bind(ye,e)},()=>t.forEach(l=>l())]}function cr(e,t){let n=()=>{},s=ut[t.type]||n,[i,r]=ms(e);ss(e,t.original,r);let a=()=>{e._x_ignore||e._x_ignoreSelf||(s.inline&&s.inline(e,t,i),s=s.bind(s,e,t,i),jt?Ne.get(gs).push(s):s())};return a.runCleanups=r,a}var ys=(e,t)=>({name:n,value:s})=>(n.startsWith(e)&&(n=n.replace(e,t)),{name:n,value:s}),ps=e=>e;function ws(e=()=>{}){return({name:t,value:n})=>{let{name:s,value:i}=Ss.reduce((r,a)=>a(r),{name:t,value:n});return s!==t&&e(s,t),{name:s,value:i}}}var Ss=[];function pn(e){Ss.push(e)}function bs({name:e}){return _s().test(e)}var _s=()=>new RegExp(`^${mn}([^:^.]+)\\b`);function ur(e,t){return({name:n,value:s})=>{let i=n.match(_s()),r=n.match(/:([a-zA-Z0-9\-_:]+)/),a=n.match(/\.[^.\]]+(?=[^\]]*$)/g)||[],l=t||e[n]||n;return{type:i?i[1]:null,value:r?r[1]:null,modifiers:a.map(c=>c.replace(".","")),expression:s,original:l}}}var Ut="DEFAULT",ge=["ignore","ref","data","id","anchor","bind","init","for","model","modelable","transition","show","if",Ut,"teleport"];function dr(e,t){let n=ge.indexOf(e.type)===-1?Ut:e.type,s=ge.indexOf(t.type)===-1?Ut:t.type;return ge.indexOf(n)-ge.indexOf(s)}function ze(e,t,n={}){e.dispatchEvent(new CustomEvent(t,{detail:n,bubbles:!0,composed:!0,cancelable:!0}))}function Se(e,t){if(typeof ShadowRoot=="function"&&e instanceof ShadowRoot){Array.from(e.children).forEach(i=>Se(i,t));return}let n=!1;if(t(e,()=>n=!0),n)return;let s=e.firstElementChild;for(;s;)Se(s,t),s=s.nextElementSibling}function W(e,...t){console.warn(`Alpine Warning: ${e}`,...t)}var Rn=!1;function fr(){Rn&&W("Alpine has already been initialized on this page. Calling Alpine.start() more than once can cause problems."),Rn=!0,document.body||W("Unable to initialize. Trying to load Alpine before `<body>` is available. Did you forget to add `defer` in Alpine's `<script>` tag?"),ze(document,"alpine:init"),ze(document,"alpine:initializing"),fn(),Hi(t=>te(t,Se)),cn(t=>$e(t)),ns((t,n)=>{yn(t,n).forEach(s=>s())});let e=t=>!mt(t.parentElement,!0);Array.from(document.querySelectorAll(Ds().join(","))).filter(e).forEach(t=>{te(t)}),ze(document,"alpine:initialized"),setTimeout(()=>{yr()})}var wn=[],ks=[];function vs(){return wn.map(e=>e())}function Ds(){return wn.concat(ks).map(e=>e())}function Es(e){wn.push(e)}function As(e){ks.push(e)}function mt(e,t=!1){return xe(e,n=>{if((t?Ds():vs()).some(i=>n.matches(i)))return!0})}function xe(e,t){if(e){if(t(e))return e;if(e._x_teleportBack&&(e=e._x_teleportBack),!!e.parentElement)return xe(e.parentElement,t)}}function hr(e){return vs().some(t=>e.matches(t))}var Is=[];function gr(e){Is.push(e)}var mr=1;function te(e,t=Se,n=()=>{}){xe(e,s=>s._x_ignore)||lr(()=>{t(e,(s,i)=>{s._x_marker||(n(s,i),Is.forEach(r=>r(s,i)),yn(s,s.attributes).forEach(r=>r()),s._x_ignore||(s._x_marker=mr++),s._x_ignore&&i())})})}function $e(e,t=Se){t(e,n=>{Ki(n),is(n),delete n._x_marker})}function yr(){[["ui","dialog",["[x-dialog], [x-popover]"]],["anchor","anchor",["[x-anchor]"]],["sort","sort",["[x-sort]"]]].forEach(([t,n,s])=>{ar(n)||s.some(i=>{if(document.querySelector(i))return W(`found "${i}", but missing ${t} plugin`),!0})})}var zt=[],Sn=!1;function bn(e=()=>{}){return queueMicrotask(()=>{Sn||setTimeout(()=>{Vt()})}),new Promise(t=>{zt.push(()=>{e(),t()})})}function Vt(){for(Sn=!1;zt.length;)zt.shift()()}function pr(){Sn=!0}function _n(e,t){return Array.isArray(t)?Pn(e,t.join(" ")):typeof t=="object"&&t!==null?wr(e,t):typeof t=="function"?_n(e,t()):Pn(e,t)}function Pn(e,t){let n=i=>i.split(" ").filter(r=>!e.classList.contains(r)).filter(Boolean),s=i=>(e.classList.add(...i),()=>{e.classList.remove(...i)});return t=t===!0?t="":t||"",s(n(t))}function wr(e,t){let n=l=>l.split(" ").filter(Boolean),s=Object.entries(t).flatMap(([l,c])=>c?n(l):!1).filter(Boolean),i=Object.entries(t).flatMap(([l,c])=>c?!1:n(l)).filter(Boolean),r=[],a=[];return i.forEach(l=>{e.classList.contains(l)&&(e.classList.remove(l),a.push(l))}),s.forEach(l=>{e.classList.contains(l)||(e.classList.add(l),r.push(l))}),()=>{a.forEach(l=>e.classList.add(l)),r.forEach(l=>e.classList.remove(l))}}function yt(e,t){return typeof t=="object"&&t!==null?Sr(e,t):br(e,t)}function Sr(e,t){let n={};return Object.entries(t).forEach(([s,i])=>{n[s]=e.style[s],s.startsWith("--")||(s=_r(s)),e.style.setProperty(s,i)}),setTimeout(()=>{e.style.length===0&&e.removeAttribute("style")}),()=>{yt(e,n)}}function br(e,t){let n=e.getAttribute("style",t);return e.setAttribute("style",t),()=>{e.setAttribute("style",n||"")}}function _r(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function Wt(e,t=()=>{}){let n=!1;return function(){n?t.apply(this,arguments):(n=!0,e.apply(this,arguments))}}B("transition",(e,{value:t,modifiers:n,expression:s},{evaluate:i})=>{typeof s=="function"&&(s=i(s)),s!==!1&&(!s||typeof s=="boolean"?vr(e,n,t):kr(e,s,t))});function kr(e,t,n){Cs(e,_n,""),{enter:i=>{e._x_transition.enter.during=i},"enter-start":i=>{e._x_transition.enter.start=i},"enter-end":i=>{e._x_transition.enter.end=i},leave:i=>{e._x_transition.leave.during=i},"leave-start":i=>{e._x_transition.leave.start=i},"leave-end":i=>{e._x_transition.leave.end=i}}[n](t)}function vr(e,t,n){Cs(e,yt);let s=!t.includes("in")&&!t.includes("out")&&!n,i=s||t.includes("in")||["enter"].includes(n),r=s||t.includes("out")||["leave"].includes(n);t.includes("in")&&!s&&(t=t.filter((y,b)=>b<t.indexOf("out"))),t.includes("out")&&!s&&(t=t.filter((y,b)=>b>t.indexOf("out")));let a=!t.includes("opacity")&&!t.includes("scale"),l=a||t.includes("opacity"),c=a||t.includes("scale"),u=l?0:1,d=c?Re(t,"scale",95)/100:1,f=Re(t,"delay",0)/1e3,h=Re(t,"origin","center"),p="opacity, transform",O=Re(t,"duration",150)/1e3,$=Re(t,"duration",75)/1e3,m="cubic-bezier(0.4, 0.0, 0.2, 1)";i&&(e._x_transition.enter.during={transformOrigin:h,transitionDelay:`${f}s`,transitionProperty:p,transitionDuration:`${O}s`,transitionTimingFunction:m},e._x_transition.enter.start={opacity:u,transform:`scale(${d})`},e._x_transition.enter.end={opacity:1,transform:"scale(1)"}),r&&(e._x_transition.leave.during={transformOrigin:h,transitionDelay:`${f}s`,transitionProperty:p,transitionDuration:`${$}s`,transitionTimingFunction:m},e._x_transition.leave.start={opacity:1,transform:"scale(1)"},e._x_transition.leave.end={opacity:u,transform:`scale(${d})`})}function Cs(e,t,n={}){e._x_transition||(e._x_transition={enter:{during:n,start:n,end:n},leave:{during:n,start:n,end:n},in(s=()=>{},i=()=>{}){Ht(e,t,{during:this.enter.during,start:this.enter.start,end:this.enter.end},s,i)},out(s=()=>{},i=()=>{}){Ht(e,t,{during:this.leave.during,start:this.leave.start,end:this.leave.end},s,i)}})}window.Element.prototype._x_toggleAndCascadeWithTransitions=function(e,t,n,s){const i=document.visibilityState==="visible"?requestAnimationFrame:setTimeout;let r=()=>i(n);if(t){e._x_transition&&(e._x_transition.enter||e._x_transition.leave)?e._x_transition.enter&&(Object.entries(e._x_transition.enter.during).length||Object.entries(e._x_transition.enter.start).length||Object.entries(e._x_transition.enter.end).length)?e._x_transition.in(n):r():e._x_transition?e._x_transition.in(n):r();return}e._x_hidePromise=e._x_transition?new Promise((a,l)=>{e._x_transition.out(()=>{},()=>a(s)),e._x_transitioning&&e._x_transitioning.beforeCancel(()=>l({isFromCancelledTransition:!0}))}):Promise.resolve(s),queueMicrotask(()=>{let a=Os(e);a?(a._x_hideChildren||(a._x_hideChildren=[]),a._x_hideChildren.push(e)):i(()=>{let l=c=>{let u=Promise.all([c._x_hidePromise,...(c._x_hideChildren||[]).map(l)]).then(([d])=>d?.());return delete c._x_hidePromise,delete c._x_hideChildren,u};l(e).catch(c=>{if(!c.isFromCancelledTransition)throw c})})})};function Os(e){let t=e.parentNode;if(t)return t._x_hidePromise?t:Os(t)}function Ht(e,t,{during:n,start:s,end:i}={},r=()=>{},a=()=>{}){if(e._x_transitioning&&e._x_transitioning.cancel(),Object.keys(n).length===0&&Object.keys(s).length===0&&Object.keys(i).length===0){r(),a();return}let l,c,u;Dr(e,{start(){l=t(e,s)},during(){c=t(e,n)},before:r,end(){l(),u=t(e,i)},after:a,cleanup(){c(),u()}})}function Dr(e,t){let n,s,i,r=Wt(()=>{x(()=>{n=!0,s||t.before(),i||(t.end(),Vt()),t.after(),e.isConnected&&t.cleanup(),delete e._x_transitioning})});e._x_transitioning={beforeCancels:[],beforeCancel(a){this.beforeCancels.push(a)},cancel:Wt(function(){for(;this.beforeCancels.length;)this.beforeCancels.shift()();r()}),finish:r},x(()=>{t.start(),t.during()}),pr(),requestAnimationFrame(()=>{if(n)return;let a=Number(getComputedStyle(e).transitionDuration.replace(/,.*/,"").replace("s",""))*1e3,l=Number(getComputedStyle(e).transitionDelay.replace(/,.*/,"").replace("s",""))*1e3;a===0&&(a=Number(getComputedStyle(e).animationDuration.replace("s",""))*1e3),x(()=>{t.before()}),s=!0,requestAnimationFrame(()=>{n||(x(()=>{t.end()}),Vt(),setTimeout(e._x_transitioning.finish,a+l),i=!0)})})}function Re(e,t,n){if(e.indexOf(t)===-1)return n;const s=e[e.indexOf(t)+1];if(!s||t==="scale"&&isNaN(s))return n;if(t==="duration"||t==="delay"){let i=s.match(/([0-9]+)ms/);if(i)return i[1]}return t==="origin"&&["top","right","left","center","bottom"].includes(e[e.indexOf(t)+2])?[s,e[e.indexOf(t)+2]].join(" "):s}var ce=!1;function de(e,t=()=>{}){return(...n)=>ce?t(...n):e(...n)}function Er(e){return(...t)=>ce&&e(...t)}var Ts=[];function pt(e){Ts.push(e)}function Ar(e,t){Ts.forEach(n=>n(e,t)),ce=!0,xs(()=>{te(t,(n,s)=>{s(n,()=>{})})}),ce=!1}var Kt=!1;function Ir(e,t){t._x_dataStack||(t._x_dataStack=e._x_dataStack),ce=!0,Kt=!0,xs(()=>{Cr(t)}),ce=!1,Kt=!1}function Cr(e){let t=!1;te(e,(s,i)=>{Se(s,(r,a)=>{if(t&&hr(r))return a();t=!0,i(r,a)})})}function xs(e){let t=_e;Ln((n,s)=>{let i=t(n);return Oe(i),()=>{}}),e(),Ln(t)}function $s(e,t,n,s=[]){switch(e._x_bindings||(e._x_bindings=Ce({})),e._x_bindings[t]=n,t=s.includes("camel")?Rr(t):t,t){case"value":Or(e,n);break;case"style":xr(e,n);break;case"class":Tr(e,n);break;case"selected":case"checked":$r(e,t,n);break;default:Ms(e,t,n);break}}function Or(e,t){if(Rs(e))e.attributes.value===void 0&&(e.value=t),window.fromModel&&(typeof t=="boolean"?e.checked=rt(e.value)===t:e.checked=Fn(e.value,t));else if(kn(e))Number.isInteger(t)?e.value=t:!Array.isArray(t)&&typeof t!="boolean"&&![null,void 0].includes(t)?e.value=String(t):Array.isArray(t)?e.checked=t.some(n=>Fn(n,e.value)):e.checked=!!t;else if(e.tagName==="SELECT")Lr(e,t);else{if(e.value===t)return;e.value=t===void 0?"":t}}function Tr(e,t){e._x_undoAddedClasses&&e._x_undoAddedClasses(),e._x_undoAddedClasses=_n(e,t)}function xr(e,t){e._x_undoAddedStyles&&e._x_undoAddedStyles(),e._x_undoAddedStyles=yt(e,t)}function $r(e,t,n){Ms(e,t,n),Br(e,t,n)}function Ms(e,t,n){[null,void 0,!1].includes(n)&&Fr(t)?e.removeAttribute(t):(Bs(t)&&(n=t),Mr(e,t,n))}function Mr(e,t,n){e.getAttribute(t)!=n&&e.setAttribute(t,n)}function Br(e,t,n){e[t]!==n&&(e[t]=n)}function Lr(e,t){const n=[].concat(t).map(s=>s+"");Array.from(e.options).forEach(s=>{s.selected=n.includes(s.value)})}function Rr(e){return e.toLowerCase().replace(/-(\w)/g,(t,n)=>n.toUpperCase())}function Fn(e,t){return e==t}function rt(e){return[1,"1","true","on","yes",!0].includes(e)?!0:[0,"0","false","off","no",!1].includes(e)?!1:e?!!e:null}var Pr=new Set(["allowfullscreen","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected","shadowrootclonable","shadowrootdelegatesfocus","shadowrootserializable"]);function Bs(e){return Pr.has(e)}function Fr(e){return!["aria-pressed","aria-checked","aria-expanded","aria-selected"].includes(e)}function Gr(e,t,n){return e._x_bindings&&e._x_bindings[t]!==void 0?e._x_bindings[t]:Ls(e,t,n)}function Nr(e,t,n,s=!0){if(e._x_bindings&&e._x_bindings[t]!==void 0)return e._x_bindings[t];if(e._x_inlineBindings&&e._x_inlineBindings[t]!==void 0){let i=e._x_inlineBindings[t];return i.extract=s,us(()=>ye(e,i.expression))}return Ls(e,t,n)}function Ls(e,t,n){let s=e.getAttribute(t);return s===null?typeof n=="function"?n():n:s===""?!0:Bs(t)?!![t,"true"].includes(s):s}function kn(e){return e.type==="checkbox"||e.localName==="ui-checkbox"||e.localName==="ui-switch"}function Rs(e){return e.type==="radio"||e.localName==="ui-radio"}function Ps(e,t){var n;return function(){var s=this,i=arguments,r=function(){n=null,e.apply(s,i)};clearTimeout(n),n=setTimeout(r,t)}}function Fs(e,t){let n;return function(){let s=this,i=arguments;n||(e.apply(s,i),n=!0,setTimeout(()=>n=!1,t))}}function Gs({get:e,set:t},{get:n,set:s}){let i=!0,r,a=_e(()=>{let l=e(),c=n();if(i)s(Dt(l)),i=!1;else{let u=JSON.stringify(l),d=JSON.stringify(c);u!==r?s(Dt(l)):u!==d&&t(Dt(c))}r=JSON.stringify(e()),JSON.stringify(n())});return()=>{Oe(a)}}function Dt(e){return typeof e=="object"?JSON.parse(JSON.stringify(e)):e}function jr(e){(Array.isArray(e)?e:[e]).forEach(n=>n(Je))}var he={},Gn=!1;function Ur(e,t){if(Gn||(he=Ce(he),Gn=!0),t===void 0)return he[e];he[e]=t,as(he[e]),typeof t=="object"&&t!==null&&t.hasOwnProperty("init")&&typeof t.init=="function"&&he[e].init()}function zr(){return he}var Ns={};function Vr(e,t){let n=typeof t!="function"?()=>t:t;return e instanceof Element?js(e,n()):(Ns[e]=n,()=>{})}function Wr(e){return Object.entries(Ns).forEach(([t,n])=>{Object.defineProperty(e,t,{get(){return(...s)=>n(...s)}})}),e}function js(e,t,n){let s=[];for(;s.length;)s.pop()();let i=Object.entries(t).map(([a,l])=>({name:a,value:l})),r=hs(i);return i=i.map(a=>r.find(l=>l.name===a.name)?{name:`x-bind:${a.name}`,value:`"${a.value}"`}:a),yn(e,i,n).map(a=>{s.push(a.runCleanups),a()}),()=>{for(;s.length;)s.pop()()}}var Us={};function Hr(e,t){Us[e]=t}function Kr(e,t){return Object.entries(Us).forEach(([n,s])=>{Object.defineProperty(e,n,{get(){return(...i)=>s.bind(t)(...i)},enumerable:!1})}),e}var qr={get reactive(){return Ce},get release(){return Oe},get effect(){return _e},get raw(){return Qn},version:"3.14.9",flushAndStopDeferringMutations:Yi,dontAutoEvaluateFunctions:us,disableEffectScheduling:zi,startObservingMutations:fn,stopObservingMutations:rs,setReactivityEngine:Vi,onAttributeRemoved:ss,onAttributesAdded:ns,closestDataStack:Ee,skipDuringClone:de,onlyDuringClone:Er,addRootSelector:Es,addInitSelector:As,interceptClone:pt,addScopeToNode:Ke,deferMutations:Ji,mapAttributes:pn,evaluateLater:G,interceptInit:gr,setEvaluator:nr,mergeProxies:qe,extractProp:Nr,findClosest:xe,onElRemoved:cn,closestRoot:mt,destroyTree:$e,interceptor:ls,transition:Ht,setStyles:yt,mutateDom:x,directive:B,entangle:Gs,throttle:Fs,debounce:Ps,evaluate:ye,initTree:te,nextTick:bn,prefixed:Te,prefix:or,plugin:jr,magic:J,store:Ur,start:fr,clone:Ir,cloneNode:Ar,bound:Gr,$data:os,watch:Xn,walk:Se,data:Hr,bind:Vr},Je=qr;function Jr(e,t){const n=Object.create(null),s=e.split(",");for(let i=0;i<s.length;i++)n[s[i]]=!0;return i=>!!n[i]}var Yr=Object.freeze({}),Qr=Object.prototype.hasOwnProperty,wt=(e,t)=>Qr.call(e,t),pe=Array.isArray,Ve=e=>zs(e)==="[object Map]",Xr=e=>typeof e=="string",vn=e=>typeof e=="symbol",St=e=>e!==null&&typeof e=="object",Zr=Object.prototype.toString,zs=e=>Zr.call(e),Vs=e=>zs(e).slice(8,-1),Dn=e=>Xr(e)&&e!=="NaN"&&e[0]!=="-"&&""+parseInt(e,10)===e,eo=e=>{const t=Object.create(null);return n=>t[n]||(t[n]=e(n))},to=eo(e=>e.charAt(0).toUpperCase()+e.slice(1)),Ws=(e,t)=>e!==t&&(e===e||t===t),qt=new WeakMap,Pe=[],Y,we=Symbol("iterate"),Jt=Symbol("Map key iterate");function no(e){return e&&e._isEffect===!0}function so(e,t=Yr){no(e)&&(e=e.raw);const n=oo(e,t);return t.lazy||n(),n}function io(e){e.active&&(Hs(e),e.options.onStop&&e.options.onStop(),e.active=!1)}var ro=0;function oo(e,t){const n=function(){if(!n.active)return e();if(!Pe.includes(n)){Hs(n);try{return lo(),Pe.push(n),Y=n,e()}finally{Pe.pop(),Ks(),Y=Pe[Pe.length-1]}}};return n.id=ro++,n.allowRecurse=!!t.allowRecurse,n._isEffect=!0,n.active=!0,n.raw=e,n.deps=[],n.options=t,n}function Hs(e){const{deps:t}=e;if(t.length){for(let n=0;n<t.length;n++)t[n].delete(e);t.length=0}}var Ae=!0,En=[];function ao(){En.push(Ae),Ae=!1}function lo(){En.push(Ae),Ae=!0}function Ks(){const e=En.pop();Ae=e===void 0?!0:e}function q(e,t,n){if(!Ae||Y===void 0)return;let s=qt.get(e);s||qt.set(e,s=new Map);let i=s.get(n);i||s.set(n,i=new Set),i.has(Y)||(i.add(Y),Y.deps.push(i),Y.options.onTrack&&Y.options.onTrack({effect:Y,target:e,type:t,key:n}))}function ue(e,t,n,s,i,r){const a=qt.get(e);if(!a)return;const l=new Set,c=d=>{d&&d.forEach(f=>{(f!==Y||f.allowRecurse)&&l.add(f)})};if(t==="clear")a.forEach(c);else if(n==="length"&&pe(e))a.forEach((d,f)=>{(f==="length"||f>=s)&&c(d)});else switch(n!==void 0&&c(a.get(n)),t){case"add":pe(e)?Dn(n)&&c(a.get("length")):(c(a.get(we)),Ve(e)&&c(a.get(Jt)));break;case"delete":pe(e)||(c(a.get(we)),Ve(e)&&c(a.get(Jt)));break;case"set":Ve(e)&&c(a.get(we));break}const u=d=>{d.options.onTrigger&&d.options.onTrigger({effect:d,target:e,key:n,type:t,newValue:s,oldValue:i,oldTarget:r}),d.options.scheduler?d.options.scheduler(d):d()};l.forEach(u)}var co=Jr("__proto__,__v_isRef,__isVue"),qs=new Set(Object.getOwnPropertyNames(Symbol).map(e=>Symbol[e]).filter(vn)),uo=Js(),fo=Js(!0),Nn=ho();function ho(){const e={};return["includes","indexOf","lastIndexOf"].forEach(t=>{e[t]=function(...n){const s=C(this);for(let r=0,a=this.length;r<a;r++)q(s,"get",r+"");const i=s[t](...n);return i===-1||i===!1?s[t](...n.map(C)):i}}),["push","pop","shift","unshift","splice"].forEach(t=>{e[t]=function(...n){ao();const s=C(this)[t].apply(this,n);return Ks(),s}}),e}function Js(e=!1,t=!1){return function(s,i,r){if(i==="__v_isReactive")return!e;if(i==="__v_isReadonly")return e;if(i==="__v_raw"&&r===(e?t?Io:Zs:t?Ao:Xs).get(s))return s;const a=pe(s);if(!e&&a&&wt(Nn,i))return Reflect.get(Nn,i,r);const l=Reflect.get(s,i,r);return(vn(i)?qs.has(i):co(i))||(e||q(s,"get",i),t)?l:Yt(l)?!a||!Dn(i)?l.value:l:St(l)?e?ei(l):On(l):l}}var go=mo();function mo(e=!1){return function(n,s,i,r){let a=n[s];if(!e&&(i=C(i),a=C(a),!pe(n)&&Yt(a)&&!Yt(i)))return a.value=i,!0;const l=pe(n)&&Dn(s)?Number(s)<n.length:wt(n,s),c=Reflect.set(n,s,i,r);return n===C(r)&&(l?Ws(i,a)&&ue(n,"set",s,i,a):ue(n,"add",s,i)),c}}function yo(e,t){const n=wt(e,t),s=e[t],i=Reflect.deleteProperty(e,t);return i&&n&&ue(e,"delete",t,void 0,s),i}function po(e,t){const n=Reflect.has(e,t);return(!vn(t)||!qs.has(t))&&q(e,"has",t),n}function wo(e){return q(e,"iterate",pe(e)?"length":we),Reflect.ownKeys(e)}var So={get:uo,set:go,deleteProperty:yo,has:po,ownKeys:wo},bo={get:fo,set(e,t){return console.warn(`Set operation on key "${String(t)}" failed: target is readonly.`,e),!0},deleteProperty(e,t){return console.warn(`Delete operation on key "${String(t)}" failed: target is readonly.`,e),!0}},An=e=>St(e)?On(e):e,In=e=>St(e)?ei(e):e,Cn=e=>e,bt=e=>Reflect.getPrototypeOf(e);function Xe(e,t,n=!1,s=!1){e=e.__v_raw;const i=C(e),r=C(t);t!==r&&!n&&q(i,"get",t),!n&&q(i,"get",r);const{has:a}=bt(i),l=s?Cn:n?In:An;if(a.call(i,t))return l(e.get(t));if(a.call(i,r))return l(e.get(r));e!==i&&e.get(t)}function Ze(e,t=!1){const n=this.__v_raw,s=C(n),i=C(e);return e!==i&&!t&&q(s,"has",e),!t&&q(s,"has",i),e===i?n.has(e):n.has(e)||n.has(i)}function et(e,t=!1){return e=e.__v_raw,!t&&q(C(e),"iterate",we),Reflect.get(e,"size",e)}function jn(e){e=C(e);const t=C(this);return bt(t).has.call(t,e)||(t.add(e),ue(t,"add",e,e)),this}function Un(e,t){t=C(t);const n=C(this),{has:s,get:i}=bt(n);let r=s.call(n,e);r?Qs(n,s,e):(e=C(e),r=s.call(n,e));const a=i.call(n,e);return n.set(e,t),r?Ws(t,a)&&ue(n,"set",e,t,a):ue(n,"add",e,t),this}function zn(e){const t=C(this),{has:n,get:s}=bt(t);let i=n.call(t,e);i?Qs(t,n,e):(e=C(e),i=n.call(t,e));const r=s?s.call(t,e):void 0,a=t.delete(e);return i&&ue(t,"delete",e,void 0,r),a}function Vn(){const e=C(this),t=e.size!==0,n=Ve(e)?new Map(e):new Set(e),s=e.clear();return t&&ue(e,"clear",void 0,void 0,n),s}function tt(e,t){return function(s,i){const r=this,a=r.__v_raw,l=C(a),c=t?Cn:e?In:An;return!e&&q(l,"iterate",we),a.forEach((u,d)=>s.call(i,c(u),c(d),r))}}function nt(e,t,n){return function(...s){const i=this.__v_raw,r=C(i),a=Ve(r),l=e==="entries"||e===Symbol.iterator&&a,c=e==="keys"&&a,u=i[e](...s),d=n?Cn:t?In:An;return!t&&q(r,"iterate",c?Jt:we),{next(){const{value:f,done:h}=u.next();return h?{value:f,done:h}:{value:l?[d(f[0]),d(f[1])]:d(f),done:h}},[Symbol.iterator](){return this}}}}function re(e){return function(...t){{const n=t[0]?`on key "${t[0]}" `:"";console.warn(`${to(e)} operation ${n}failed: target is readonly.`,C(this))}return e==="delete"?!1:this}}function _o(){const e={get(r){return Xe(this,r)},get size(){return et(this)},has:Ze,add:jn,set:Un,delete:zn,clear:Vn,forEach:tt(!1,!1)},t={get(r){return Xe(this,r,!1,!0)},get size(){return et(this)},has:Ze,add:jn,set:Un,delete:zn,clear:Vn,forEach:tt(!1,!0)},n={get(r){return Xe(this,r,!0)},get size(){return et(this,!0)},has(r){return Ze.call(this,r,!0)},add:re("add"),set:re("set"),delete:re("delete"),clear:re("clear"),forEach:tt(!0,!1)},s={get(r){return Xe(this,r,!0,!0)},get size(){return et(this,!0)},has(r){return Ze.call(this,r,!0)},add:re("add"),set:re("set"),delete:re("delete"),clear:re("clear"),forEach:tt(!0,!0)};return["keys","values","entries",Symbol.iterator].forEach(r=>{e[r]=nt(r,!1,!1),n[r]=nt(r,!0,!1),t[r]=nt(r,!1,!0),s[r]=nt(r,!0,!0)}),[e,n,t,s]}var[ko,vo,La,Ra]=_o();function Ys(e,t){const n=e?vo:ko;return(s,i,r)=>i==="__v_isReactive"?!e:i==="__v_isReadonly"?e:i==="__v_raw"?s:Reflect.get(wt(n,i)&&i in s?n:s,i,r)}var Do={get:Ys(!1)},Eo={get:Ys(!0)};function Qs(e,t,n){const s=C(n);if(s!==n&&t.call(e,s)){const i=Vs(e);console.warn(`Reactive ${i} contains both the raw and reactive versions of the same object${i==="Map"?" as keys":""}, which can lead to inconsistencies. Avoid differentiating between the raw and reactive versions of an object and only use the reactive version if possible.`)}}var Xs=new WeakMap,Ao=new WeakMap,Zs=new WeakMap,Io=new WeakMap;function Co(e){switch(e){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function Oo(e){return e.__v_skip||!Object.isExtensible(e)?0:Co(Vs(e))}function On(e){return e&&e.__v_isReadonly?e:ti(e,!1,So,Do,Xs)}function ei(e){return ti(e,!0,bo,Eo,Zs)}function ti(e,t,n,s,i){if(!St(e))return console.warn(`value cannot be made reactive: ${String(e)}`),e;if(e.__v_raw&&!(t&&e.__v_isReactive))return e;const r=i.get(e);if(r)return r;const a=Oo(e);if(a===0)return e;const l=new Proxy(e,a===2?s:n);return i.set(e,l),l}function C(e){return e&&C(e.__v_raw)||e}function Yt(e){return!!(e&&e.__v_isRef===!0)}J("nextTick",()=>bn);J("dispatch",e=>ze.bind(ze,e));J("watch",(e,{evaluateLater:t,cleanup:n})=>(s,i)=>{let r=t(s),l=Xn(()=>{let c;return r(u=>c=u),c},i);n(l)});J("store",zr);J("data",e=>os(e));J("root",e=>mt(e));J("refs",e=>(e._x_refs_proxy||(e._x_refs_proxy=qe(To(e))),e._x_refs_proxy));function To(e){let t=[];return xe(e,n=>{n._x_refs&&t.push(n._x_refs)}),t}var Et={};function ni(e){return Et[e]||(Et[e]=0),++Et[e]}function xo(e,t){return xe(e,n=>{if(n._x_ids&&n._x_ids[t])return!0})}function $o(e,t){e._x_ids||(e._x_ids={}),e._x_ids[t]||(e._x_ids[t]=ni(t))}J("id",(e,{cleanup:t})=>(n,s=null)=>{let i=`${n}${s?`-${s}`:""}`;return Mo(e,i,t,()=>{let r=xo(e,n),a=r?r._x_ids[n]:ni(n);return s?`${n}-${a}-${s}`:`${n}-${a}`})});pt((e,t)=>{e._x_id&&(t._x_id=e._x_id)});function Mo(e,t,n,s){if(e._x_id||(e._x_id={}),e._x_id[t])return e._x_id[t];let i=s();return e._x_id[t]=i,n(()=>{delete e._x_id[t]}),i}J("el",e=>e);si("Focus","focus","focus");si("Persist","persist","persist");function si(e,t,n){J(t,s=>W(`You can't use [$${t}] without first installing the "${e}" plugin here: https://alpinejs.dev/plugins/${n}`,s))}B("modelable",(e,{expression:t},{effect:n,evaluateLater:s,cleanup:i})=>{let r=s(t),a=()=>{let d;return r(f=>d=f),d},l=s(`${t} = __placeholder`),c=d=>l(()=>{},{scope:{__placeholder:d}}),u=a();c(u),queueMicrotask(()=>{if(!e._x_model)return;e._x_removeModelListeners.default();let d=e._x_model.get,f=e._x_model.set,h=Gs({get(){return d()},set(p){f(p)}},{get(){return a()},set(p){c(p)}});i(h)})});B("teleport",(e,{modifiers:t,expression:n},{cleanup:s})=>{e.tagName.toLowerCase()!=="template"&&W("x-teleport can only be used on a <template> tag",e);let i=Wn(n),r=e.content.cloneNode(!0).firstElementChild;e._x_teleport=r,r._x_teleportBack=e,e.setAttribute("data-teleport-template",!0),r.setAttribute("data-teleport-target",!0),e._x_forwardEvents&&e._x_forwardEvents.forEach(l=>{r.addEventListener(l,c=>{c.stopPropagation(),e.dispatchEvent(new c.constructor(c.type,c))})}),Ke(r,{},e);let a=(l,c,u)=>{u.includes("prepend")?c.parentNode.insertBefore(l,c):u.includes("append")?c.parentNode.insertBefore(l,c.nextSibling):c.appendChild(l)};x(()=>{a(r,i,t),de(()=>{te(r)})()}),e._x_teleportPutBack=()=>{let l=Wn(n);x(()=>{a(e._x_teleport,l,t)})},s(()=>x(()=>{r.remove(),$e(r)}))});var Bo=document.createElement("div");function Wn(e){let t=de(()=>document.querySelector(e),()=>Bo)();return t||W(`Cannot find x-teleport element for selector: "${e}"`),t}var ii=()=>{};ii.inline=(e,{modifiers:t},{cleanup:n})=>{t.includes("self")?e._x_ignoreSelf=!0:e._x_ignore=!0,n(()=>{t.includes("self")?delete e._x_ignoreSelf:delete e._x_ignore})};B("ignore",ii);B("effect",de((e,{expression:t},{effect:n})=>{n(G(e,t))}));function Qt(e,t,n,s){let i=e,r=c=>s(c),a={},l=(c,u)=>d=>u(c,d);if(n.includes("dot")&&(t=Lo(t)),n.includes("camel")&&(t=Ro(t)),n.includes("passive")&&(a.passive=!0),n.includes("capture")&&(a.capture=!0),n.includes("window")&&(i=window),n.includes("document")&&(i=document),n.includes("debounce")){let c=n[n.indexOf("debounce")+1]||"invalid-wait",u=dt(c.split("ms")[0])?Number(c.split("ms")[0]):250;r=Ps(r,u)}if(n.includes("throttle")){let c=n[n.indexOf("throttle")+1]||"invalid-wait",u=dt(c.split("ms")[0])?Number(c.split("ms")[0]):250;r=Fs(r,u)}return n.includes("prevent")&&(r=l(r,(c,u)=>{u.preventDefault(),c(u)})),n.includes("stop")&&(r=l(r,(c,u)=>{u.stopPropagation(),c(u)})),n.includes("once")&&(r=l(r,(c,u)=>{c(u),i.removeEventListener(t,r,a)})),(n.includes("away")||n.includes("outside"))&&(i=document,r=l(r,(c,u)=>{e.contains(u.target)||u.target.isConnected!==!1&&(e.offsetWidth<1&&e.offsetHeight<1||e._x_isShown!==!1&&c(u))})),n.includes("self")&&(r=l(r,(c,u)=>{u.target===e&&c(u)})),(Fo(t)||ri(t))&&(r=l(r,(c,u)=>{Go(u,n)||c(u)})),i.addEventListener(t,r,a),()=>{i.removeEventListener(t,r,a)}}function Lo(e){return e.replace(/-/g,".")}function Ro(e){return e.toLowerCase().replace(/-(\w)/g,(t,n)=>n.toUpperCase())}function dt(e){return!Array.isArray(e)&&!isNaN(e)}function Po(e){return[" ","_"].includes(e)?e:e.replace(/([a-z])([A-Z])/g,"$1-$2").replace(/[_\s]/,"-").toLowerCase()}function Fo(e){return["keydown","keyup"].includes(e)}function ri(e){return["contextmenu","click","mouse"].some(t=>e.includes(t))}function Go(e,t){let n=t.filter(r=>!["window","document","prevent","stop","once","capture","self","away","outside","passive"].includes(r));if(n.includes("debounce")){let r=n.indexOf("debounce");n.splice(r,dt((n[r+1]||"invalid-wait").split("ms")[0])?2:1)}if(n.includes("throttle")){let r=n.indexOf("throttle");n.splice(r,dt((n[r+1]||"invalid-wait").split("ms")[0])?2:1)}if(n.length===0||n.length===1&&Hn(e.key).includes(n[0]))return!1;const i=["ctrl","shift","alt","meta","cmd","super"].filter(r=>n.includes(r));return n=n.filter(r=>!i.includes(r)),!(i.length>0&&i.filter(a=>((a==="cmd"||a==="super")&&(a="meta"),e[`${a}Key`])).length===i.length&&(ri(e.type)||Hn(e.key).includes(n[0])))}function Hn(e){if(!e)return[];e=Po(e);let t={ctrl:"control",slash:"/",space:" ",spacebar:" ",cmd:"meta",esc:"escape",up:"arrow-up",down:"arrow-down",left:"arrow-left",right:"arrow-right",period:".",comma:",",equal:"=",minus:"-",underscore:"_"};return t[e]=e,Object.keys(t).map(n=>{if(t[n]===e)return n}).filter(n=>n)}B("model",(e,{modifiers:t,expression:n},{effect:s,cleanup:i})=>{let r=e;t.includes("parent")&&(r=e.parentNode);let a=G(r,n),l;typeof n=="string"?l=G(r,`${n} = __placeholder`):typeof n=="function"&&typeof n()=="string"?l=G(r,`${n()} = __placeholder`):l=()=>{};let c=()=>{let h;return a(p=>h=p),Kn(h)?h.get():h},u=h=>{let p;a(O=>p=O),Kn(p)?p.set(h):l(()=>{},{scope:{__placeholder:h}})};typeof n=="string"&&e.type==="radio"&&x(()=>{e.hasAttribute("name")||e.setAttribute("name",n)});var d=e.tagName.toLowerCase()==="select"||["checkbox","radio"].includes(e.type)||t.includes("lazy")?"change":"input";let f=ce?()=>{}:Qt(e,d,t,h=>{u(At(e,t,h,c()))});if(t.includes("fill")&&([void 0,null,""].includes(c())||kn(e)&&Array.isArray(c())||e.tagName.toLowerCase()==="select"&&e.multiple)&&u(At(e,t,{target:e},c())),e._x_removeModelListeners||(e._x_removeModelListeners={}),e._x_removeModelListeners.default=f,i(()=>e._x_removeModelListeners.default()),e.form){let h=Qt(e.form,"reset",[],p=>{bn(()=>e._x_model&&e._x_model.set(At(e,t,{target:e},c())))});i(()=>h())}e._x_model={get(){return c()},set(h){u(h)}},e._x_forceModelUpdate=h=>{h===void 0&&typeof n=="string"&&n.match(/\./)&&(h=""),window.fromModel=!0,x(()=>$s(e,"value",h)),delete window.fromModel},s(()=>{let h=c();t.includes("unintrusive")&&document.activeElement.isSameNode(e)||e._x_forceModelUpdate(h)})});function At(e,t,n,s){return x(()=>{if(n instanceof CustomEvent&&n.detail!==void 0)return n.detail!==null&&n.detail!==void 0?n.detail:n.target.value;if(kn(e))if(Array.isArray(s)){let i=null;return t.includes("number")?i=It(n.target.value):t.includes("boolean")?i=rt(n.target.value):i=n.target.value,n.target.checked?s.includes(i)?s:s.concat([i]):s.filter(r=>!No(r,i))}else return n.target.checked;else{if(e.tagName.toLowerCase()==="select"&&e.multiple)return t.includes("number")?Array.from(n.target.selectedOptions).map(i=>{let r=i.value||i.text;return It(r)}):t.includes("boolean")?Array.from(n.target.selectedOptions).map(i=>{let r=i.value||i.text;return rt(r)}):Array.from(n.target.selectedOptions).map(i=>i.value||i.text);{let i;return Rs(e)?n.target.checked?i=n.target.value:i=s:i=n.target.value,t.includes("number")?It(i):t.includes("boolean")?rt(i):t.includes("trim")?i.trim():i}}})}function It(e){let t=e?parseFloat(e):null;return jo(t)?t:e}function No(e,t){return e==t}function jo(e){return!Array.isArray(e)&&!isNaN(e)}function Kn(e){return e!==null&&typeof e=="object"&&typeof e.get=="function"&&typeof e.set=="function"}B("cloak",e=>queueMicrotask(()=>x(()=>e.removeAttribute(Te("cloak")))));As(()=>`[${Te("init")}]`);B("init",de((e,{expression:t},{evaluate:n})=>typeof t=="string"?!!t.trim()&&n(t,{},!1):n(t,{},!1)));B("text",(e,{expression:t},{effect:n,evaluateLater:s})=>{let i=s(t);n(()=>{i(r=>{x(()=>{e.textContent=r})})})});B("html",(e,{expression:t},{effect:n,evaluateLater:s})=>{let i=s(t);n(()=>{i(r=>{x(()=>{e.innerHTML=r,e._x_ignoreSelf=!0,te(e),delete e._x_ignoreSelf})})})});pn(ys(":",ps(Te("bind:"))));var oi=(e,{value:t,modifiers:n,expression:s,original:i},{effect:r,cleanup:a})=>{if(!t){let c={};Wr(c),G(e,s)(d=>{js(e,d,i)},{scope:c});return}if(t==="key")return Uo(e,s);if(e._x_inlineBindings&&e._x_inlineBindings[t]&&e._x_inlineBindings[t].extract)return;let l=G(e,s);r(()=>l(c=>{c===void 0&&typeof s=="string"&&s.match(/\./)&&(c=""),x(()=>$s(e,t,c,n))})),a(()=>{e._x_undoAddedClasses&&e._x_undoAddedClasses(),e._x_undoAddedStyles&&e._x_undoAddedStyles()})};oi.inline=(e,{value:t,modifiers:n,expression:s})=>{t&&(e._x_inlineBindings||(e._x_inlineBindings={}),e._x_inlineBindings[t]={expression:s,extract:!1})};B("bind",oi);function Uo(e,t){e._x_keyExpression=t}Es(()=>`[${Te("data")}]`);B("data",(e,{expression:t},{cleanup:n})=>{if(zo(e))return;t=t===""?"{}":t;let s={};Nt(s,e);let i={};Kr(i,s);let r=ye(e,t,{scope:i});(r===void 0||r===!0)&&(r={}),Nt(r,e);let a=Ce(r);as(a);let l=Ke(e,a);a.init&&ye(e,a.init),n(()=>{a.destroy&&ye(e,a.destroy),l()})});pt((e,t)=>{e._x_dataStack&&(t._x_dataStack=e._x_dataStack,t.setAttribute("data-has-alpine-state",!0))});function zo(e){return ce?Kt?!0:e.hasAttribute("data-has-alpine-state"):!1}B("show",(e,{modifiers:t,expression:n},{effect:s})=>{let i=G(e,n);e._x_doHide||(e._x_doHide=()=>{x(()=>{e.style.setProperty("display","none",t.includes("important")?"important":void 0)})}),e._x_doShow||(e._x_doShow=()=>{x(()=>{e.style.length===1&&e.style.display==="none"?e.removeAttribute("style"):e.style.removeProperty("display")})});let r=()=>{e._x_doHide(),e._x_isShown=!1},a=()=>{e._x_doShow(),e._x_isShown=!0},l=()=>setTimeout(a),c=Wt(f=>f?a():r(),f=>{typeof e._x_toggleAndCascadeWithTransitions=="function"?e._x_toggleAndCascadeWithTransitions(e,f,a,r):f?l():r()}),u,d=!0;s(()=>i(f=>{!d&&f===u||(t.includes("immediate")&&(f?l():r()),c(f),u=f,d=!1)}))});B("for",(e,{expression:t},{effect:n,cleanup:s})=>{let i=Wo(t),r=G(e,i.items),a=G(e,e._x_keyExpression||"index");e._x_prevKeys=[],e._x_lookup={},n(()=>Vo(e,i,r,a)),s(()=>{Object.values(e._x_lookup).forEach(l=>x(()=>{$e(l),l.remove()})),delete e._x_prevKeys,delete e._x_lookup})});function Vo(e,t,n,s){let i=a=>typeof a=="object"&&!Array.isArray(a),r=e;n(a=>{Ho(a)&&a>=0&&(a=Array.from(Array(a).keys(),m=>m+1)),a===void 0&&(a=[]);let l=e._x_lookup,c=e._x_prevKeys,u=[],d=[];if(i(a))a=Object.entries(a).map(([m,y])=>{let b=qn(t,y,m,a);s(v=>{d.includes(v)&&W("Duplicate key on x-for",e),d.push(v)},{scope:{index:m,...b}}),u.push(b)});else for(let m=0;m<a.length;m++){let y=qn(t,a[m],m,a);s(b=>{d.includes(b)&&W("Duplicate key on x-for",e),d.push(b)},{scope:{index:m,...y}}),u.push(y)}let f=[],h=[],p=[],O=[];for(let m=0;m<c.length;m++){let y=c[m];d.indexOf(y)===-1&&p.push(y)}c=c.filter(m=>!p.includes(m));let $="template";for(let m=0;m<d.length;m++){let y=d[m],b=c.indexOf(y);if(b===-1)c.splice(m,0,y),f.push([$,m]);else if(b!==m){let v=c.splice(m,1)[0],E=c.splice(b-1,1)[0];c.splice(m,0,E),c.splice(b,0,v),h.push([v,E])}else O.push(y);$=y}for(let m=0;m<p.length;m++){let y=p[m];y in l&&(x(()=>{$e(l[y]),l[y].remove()}),delete l[y])}for(let m=0;m<h.length;m++){let[y,b]=h[m],v=l[y],E=l[b],L=document.createElement("div");x(()=>{E||W('x-for ":key" is undefined or invalid',r,b,l),E.after(L),v.after(E),E._x_currentIfEl&&E.after(E._x_currentIfEl),L.before(v),v._x_currentIfEl&&v.after(v._x_currentIfEl),L.remove()}),E._x_refreshXForScope(u[d.indexOf(b)])}for(let m=0;m<f.length;m++){let[y,b]=f[m],v=y==="template"?r:l[y];v._x_currentIfEl&&(v=v._x_currentIfEl);let E=u[b],L=d[b],g=document.importNode(r.content,!0).firstElementChild,M=Ce(E);Ke(g,M,r),g._x_refreshXForScope=T=>{Object.entries(T).forEach(([z,ne])=>{M[z]=ne})},x(()=>{v.after(g),de(()=>te(g))()}),typeof L=="object"&&W("x-for key cannot be an object, it must be a string or an integer",r),l[L]=g}for(let m=0;m<O.length;m++)l[O[m]]._x_refreshXForScope(u[d.indexOf(O[m])]);r._x_prevKeys=d})}function Wo(e){let t=/,([^,\}\]]*)(?:,([^,\}\]]*))?$/,n=/^\s*\(|\)\s*$/g,s=/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/,i=e.match(s);if(!i)return;let r={};r.items=i[2].trim();let a=i[1].replace(n,"").trim(),l=a.match(t);return l?(r.item=a.replace(t,"").trim(),r.index=l[1].trim(),l[2]&&(r.collection=l[2].trim())):r.item=a,r}function qn(e,t,n,s){let i={};return/^\[.*\]$/.test(e.item)&&Array.isArray(t)?e.item.replace("[","").replace("]","").split(",").map(a=>a.trim()).forEach((a,l)=>{i[a]=t[l]}):/^\{.*\}$/.test(e.item)&&!Array.isArray(t)&&typeof t=="object"?e.item.replace("{","").replace("}","").split(",").map(a=>a.trim()).forEach(a=>{i[a]=t[a]}):i[e.item]=t,e.index&&(i[e.index]=n),e.collection&&(i[e.collection]=s),i}function Ho(e){return!Array.isArray(e)&&!isNaN(e)}function ai(){}ai.inline=(e,{expression:t},{cleanup:n})=>{let s=mt(e);s._x_refs||(s._x_refs={}),s._x_refs[t]=e,n(()=>delete s._x_refs[t])};B("ref",ai);B("if",(e,{expression:t},{effect:n,cleanup:s})=>{e.tagName.toLowerCase()!=="template"&&W("x-if can only be used on a <template> tag",e);let i=G(e,t),r=()=>{if(e._x_currentIfEl)return e._x_currentIfEl;let l=e.content.cloneNode(!0).firstElementChild;return Ke(l,{},e),x(()=>{e.after(l),de(()=>te(l))()}),e._x_currentIfEl=l,e._x_undoIf=()=>{x(()=>{$e(l),l.remove()}),delete e._x_currentIfEl},l},a=()=>{e._x_undoIf&&(e._x_undoIf(),delete e._x_undoIf)};n(()=>i(l=>{l?r():a()})),s(()=>e._x_undoIf&&e._x_undoIf())});B("id",(e,{expression:t},{evaluate:n})=>{n(t).forEach(i=>$o(e,i))});pt((e,t)=>{e._x_ids&&(t._x_ids=e._x_ids)});pn(ys("@",ps(Te("on:"))));B("on",de((e,{value:t,modifiers:n,expression:s},{cleanup:i})=>{let r=s?G(e,s):()=>{};e.tagName.toLowerCase()==="template"&&(e._x_forwardEvents||(e._x_forwardEvents=[]),e._x_forwardEvents.includes(t)||e._x_forwardEvents.push(t));let a=Qt(e,t,n,l=>{r(()=>{},{scope:{$event:l},params:[l]})});i(()=>a())}));_t("Collapse","collapse","collapse");_t("Intersect","intersect","intersect");_t("Focus","trap","focus");_t("Mask","mask","mask");function _t(e,t,n){B(t,s=>W(`You can't use [x-${t}] without first installing the "${e}" plugin here: https://alpinejs.dev/plugins/${n}`,s))}Je.setEvaluator(fs);Je.setReactivityEngine({reactive:On,effect:so,release:io,raw:C});var Ko=Je,He=Ko;const Ct="not-the-news-db",Ot=29;let le=null,ke=null;const li=[{name:"feedItems",keyPath:"id",options:{autoIncrement:!0},indexes:[{name:"guid",keyPath:"guid",options:{unique:!0}}]},{name:"starred",keyPath:"id",options:{autoIncrement:!0},indexes:[{name:"guid",keyPath:"guid",options:{unique:!0}}]},{name:"read",keyPath:"id",options:{autoIncrement:!0},indexes:[{name:"guid",keyPath:"guid",options:{unique:!0}}]},{name:"currentDeckGuids",keyPath:"id",options:{autoIncrement:!0},indexes:[{name:"guid",keyPath:"guid",options:{unique:!0}}]},{name:"shuffledOutGuids",keyPath:"id",options:{autoIncrement:!0},indexes:[{name:"guid",keyPath:"guid",options:{unique:!0}}]},{name:"userSettings",keyPath:"key"},{name:"pendingOperations",keyPath:"id",options:{autoIncrement:!0}}];async function ft(){if(le)return le;if(ke)return ke;ke=xi(Ct,Ot,{upgrade(e,t){console.log(`[DB] Upgrading database from version ${t} to ${Ot}`);const n=new Set(e.objectStoreNames);li.forEach(s=>{let i;n.has(s.name)&&e.deleteObjectStore(s.name),i=e.createObjectStore(s.name,{keyPath:s.keyPath,...s.options||{}}),console.log(`[DB] Created/Recreated store: ${s.name}`),s.indexes&&s.indexes.forEach(r=>{i.createIndex(r.name,r.keyPath,r.options||{}),console.log(`[DB] Created index '${r.name}' on store '${s.name}'`)})})},blocked(){console.warn("[DB] Database upgrade blocked. Please close all other tabs with this site open.")},blocking(){console.warn("[DB] Database blocking other tabs.")}});try{return le=await ke,console.log(`[DB] Opened '${Ct}', version ${Ot}`),le}catch(e){throw console.error(`[DB] Failed to open database '${Ct}':`,e),le=null,ke=null,e}}async function ci(){le&&(le.close(),le=null,ke=null,console.log("[DB] Database connection closed."))}async function R(e){let t=await ft();return e(t)}const qo=Object.freeze(Object.defineProperty({__proto__:null,OBJECT_STORES_SCHEMA:li,closeDb:ci,initDb:ft,withDb:R},Symbol.toStringTag,{value:"Module"})),F=()=>navigator.onLine,K={starred:{store:"starred",type:"array",localOnly:!1,default:[],syncMode:"merge"},read:{store:"read",type:"array",localOnly:!1,default:[],syncMode:"merge"},currentDeckGuids:{store:"currentDeckGuids",type:"array",localOnly:!1,default:[],syncMode:"replace"},shuffledOutGuids:{store:"shuffledOutGuids",type:"array",localOnly:!1,default:[],syncMode:"replace"},lastStateSync:{store:"userSettings",type:"simple",localOnly:!1,default:0},lastFeedSync:{store:"userSettings",type:"simple",localOnly:!0,default:0},openUrlsInNewTabEnabled:{store:"userSettings",type:"simple",localOnly:!1,default:!0},imagesEnabled:{store:"userSettings",type:"simple",localOnly:!1,default:!0},itemButtonMode:{store:"userSettings",type:"simple",localOnly:!1,default:"menu"},syncEnabled:{store:"userSettings",type:"simple",localOnly:!1,default:!0},theme:{store:"userSettings",type:"simple",localOnly:!1,default:"dark"},themeStyle:{store:"userSettings",type:"simple",localOnly:!1,default:"originalDark"},themeStyleLight:{store:"userSettings",type:"simple",localOnly:!1,default:"originalLight"},themeStyleDark:{store:"userSettings",type:"simple",localOnly:!1,default:"originalDark"},customCss:{store:"userSettings",type:"simple",localOnly:!1,default:""},fontSize:{store:"userSettings",type:"simple",localOnly:!0,default:100},feedWidth:{store:"userSettings",type:"simple",localOnly:!0,default:50},animationSpeed:{store:"userSettings",type:"simple",localOnly:!1,default:100},feedLastModified:{store:"userSettings",type:"simple",localOnly:!0,default:0},rssFeeds:{store:"userSettings",type:"simple",localOnly:!1,default:{}},keywordBlacklist:{store:"userSettings",type:"simple",localOnly:!1,default:[]},shuffleCount:{store:"userSettings",type:"simple",localOnly:!1,default:2},lastShuffleResetDate:{store:"userSettings",type:"simple",localOnly:!1,default:null},shadowsEnabled:{store:"userSettings",type:"simple",localOnly:!1,default:!0},curvesEnabled:{store:"userSettings",type:"simple",localOnly:!1,default:!0},flickToSelectEnabled:{store:"userSettings",type:"simple",localOnly:!1,default:!1},fontTitle:{store:"userSettings",type:"simple",localOnly:!1,default:"'Playfair Display', serif"},fontBody:{store:"userSettings",type:"simple",localOnly:!1,default:"inherit"},pregeneratedOnlineDeck:{store:"userSettings",type:"simple",localOnly:!0,default:null},pregeneratedOfflineDeck:{store:"userSettings",type:"simple",localOnly:!0,default:null}};async function S(e,t="userSettings"){return R(async n=>{try{const s=await n.get(t,e);return{value:s?s.value:K[e]?.default||null,lastModified:s?.lastModified||null}}catch(s){return console.error(`Failed to load simple state for key '${e}':`,s),{value:K[e]?.default||null,lastModified:null}}})}const Jo=e=>{switch(e){case"starred":return"starredAt";case"read":return"readAt";case"currentDeckGuids":return"addedAt";case"shuffledOutGuids":return"shuffledAt";default:return"updatedAt"}};async function be(e){return console.log(`ENTERING loadArrayState for ${e}`),R(async t=>{try{const n=await t.getAll(e);if(n.length>0&&(typeof n[0]=="string"||n[0].id===void 0)){console.log(`[DB] Migration required for '${e}'.`);const i=Jo(e),r=new Date().toISOString(),a=new Map;n.forEach(d=>{const f=typeof d=="string"?d:d.guid;f&&!a.has(f)&&a.set(f,d)});const c=Array.from(a.values()).map(d=>({guid:typeof d=="string"?d:d.guid,[i]:r})),u=t.transaction(e,"readwrite");await u.store.clear();for(const d of c)await u.store.put(d);return await u.done,console.log(`[DB] Migration complete for '${e}'.`),{value:await t.getAll(e)}}return{value:n||K[e]?.default||[]}}catch(n){return console.error(`Failed to load array state from store '${e}':`,n),{value:K[e]?.default||[]}}})}const ui=Object.freeze(Object.defineProperty({__proto__:null,USER_STATE_DEFS:K,loadArrayState:be,loadSimpleState:S},Symbol.toStringTag,{value:"Module"}));async function Q(e=10){let t=0;for(;t<e;){const n=U.currentUser;if(n)try{return await n.getIdToken()}catch(s){console.error("[Auth] Failed to get ID token:",s)}await new Promise(s=>setTimeout(s,200)),t++}return console.warn(`[Auth] Could not obtain token after ${e} attempts.`),null}const Ye="https://news.loveopenly.net";async function Ie(e,t,n){return R(async s=>{try{const i=n||new Date().toISOString();await s.put("userSettings",{key:e,value:t,lastModified:i})}catch(i){console.error(`[DB] Failed to save sync metadata for key '${e}':`,i)}})}async function Yo(e){return R(async t=>{const n={...e};n.id&&delete n.id;try{const s=t.transaction("pendingOperations","readwrite"),i=await s.store.add(n);return await s.done,i}catch(s){throw console.error("[DB] Error buffering operation:",s),s}})}async function X(e){if(!e||typeof e.type!="string"||e.type==="simpleUpdate"&&(e.value===null||e.value===void 0)){console.warn("[DB] Skipping invalid or empty operation:",e);return}try{const t=await Yo(e);console.log(`[DB] Operation buffered with ID: ${t}`,e);const{value:n}=await S("syncEnabled");if(F()&&n){console.log(`[DB] Attempting immediate sync for ${e.type} (ID: ${t}).`);const s=[{...e,id:t}],i=await Q();if(!i){console.warn(`[DB] No auth token available for immediate sync, buffering op ${t}.`);return}const r=await fetch(`${Ye}/api/profile`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(s)});if(!r.ok){const c=await r.text();throw new Error(`HTTP error ${r.status} for immediate sync. Details: ${c}`)}const a=await r.json(),l=a.results?.find(c=>c.id===t);if(l?.status==="success"){await R(u=>u.delete("pendingOperations",t)),console.log(`[DB] Successfully synced and removed immediate op ${t} (${e.type}).`),a.serverTime&&await Ie("lastStateSync",a.serverTime);let c=null;e.key?c=e.key:e.type==="readDelta"?c="read":e.type==="starDelta"&&(c="starred"),V(!1,c?[c]:[],this&&this.loadFeedItemsFromDB?this:null)}else console.warn(`[DB] Immediate sync for op ${t} reported non-success by server:`,l)}else console.log(`[DB] ${F()?"Sync is disabled.":"Offline."} Buffering op ${t} for later batch sync.`)}catch(t){console.error(`[DB] Network error during immediate sync for ${e.type}. Will retry with batch sync.`,t)}}async function oe(){const{value:e}=await S("syncEnabled");if(!F()||!e){console.log("[DB] Offline or sync is disabled. Skipping batch sync.");return}const t=await R(i=>i.getAll("pendingOperations")).catch(i=>(console.error("[DB] Error fetching pending operations:",i),null));if(!t||t.length===0){t&&console.log("[DB] No pending operations.");return}console.log(`[DB] Processing ${t.length} pending operations...`);const n=10,s=new Set;for(let i=0;i<t.length;i+=n){const r=t.slice(i,i+n);console.log(`[DB] Sending batch ${i/n+1} (${r.length} ops) to /api/user-state.`);try{const a=await Q();if(!a){console.warn("[DB] No auth token available for batch sync.");return}const l=await fetch(`${Ye}/api/profile`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(r)});if(!l.ok)throw new Error(`HTTP error ${l.status} for batch sync. Details: ${await l.text()}`);const c=await l.json();console.log(`[DB] Batch ${i/n+1} sync successful. Server response:`,c),c.results&&Array.isArray(c.results)?await R(async u=>{const d=u.transaction("pendingOperations","readwrite");for(const f of c.results)if(f.status==="success"&&f.id!==void 0){await d.store.delete(f.id);const h=r.find(p=>p.id===f.id);h&&(h.key?s.add(h.key):h.type==="readDelta"?s.add("read"):h.type==="starDelta"&&s.add("starred"))}else console.warn(`[DB] Op ${f.id??"N/A"} (${f.opType}) ${f.status}: ${f.reason||"N/A"}`);await d.done}):console.warn("[DB] Server response invalid; cannot clear buffered operations."),c.serverTime&&await Ie("lastStateSync",c.serverTime)}catch(a){console.error("[DB] Error during batch synchronization:",a)}}s.size>0&&(console.log(`[DB] Post-batch sync: Triggering single pull for ${s.size} unique keys.`),V(!1,Array.from(s)))}let Tt=!1,Jn=0;const Qo=500;async function xt(e,t,n=!1){if(!n&&(await R(d=>d.getAll("pendingOperations")).catch(()=>[])).some(d=>d.key===e||d.type==="starDelta"&&e==="starred"||d.type==="readDelta"&&e==="read"||d.type==="simpleUpdate"&&d.key==="currentDeckGuids"))return console.log(`[DB] Skipping pull for '${e}' because local changes are pending synchronization.`),{key:e,status:"skipped_pending"};const{value:s,lastModified:i}=t.type==="array"?await be(t.store):await S(e,t.store),r=i||"",a=await Q();if(!a)return console.warn(`[DB] No auth token available for ${e}, skipping pull.`),{key:e,status:"no_token"};const l={"Content-Type":"application/json",Authorization:`Bearer ${a}`};r&&!n&&(l["If-None-Match"]=r);try{const c=new AbortController,u=setTimeout(()=>c.abort(),1e4),d=await fetch(`${Ye}/api/profile/${e}`,{method:"GET",headers:l,signal:c.signal});if(clearTimeout(u),d.status===304&&!n)return{key:e,status:304,timestamp:r};if(!d.ok)return console.error(`[DB] HTTP error for ${e}: ${d.status}`),{key:e,status:d.status};const f=await d.json();if(console.log(`[DB Sync] Received data for ${e}:`,f.value),t.type==="array"){const h=f.value||[],p=s||[];if((t.syncMode||"merge")==="replace"||n)console.log(`[DB Sync] Replacing local '${e}' with server snapshot.`),await R(async $=>{const m=$.transaction(t.store,"readwrite");await m.store.clear();for(const y of h){const b={...y};delete b.id,await m.store.put(b)}await m.done});else{const $=new Set(p.map(v=>v.guid)),m=new Set(h.map(v=>v.guid)),y=h.filter(v=>!$.has(v.guid)),b=p.filter(v=>!m.has(v.guid));(y.length>0||b.length>0)&&(console.log(`[DB Sync] Merging '${e}': ${y.length} added, ${b.length} removed.`),await R(async v=>{const E=v.transaction(t.store,"readwrite");for(const L of y){const g={...L};delete g.id,await E.store.put(g)}for(const L of b)await E.store.delete(L.id);await E.done}))}}else await Ie(e,f.value,f.lastModified);return{key:e,status:200,timestamp:f.lastModified}}catch(c){return console.error(`[DB] Failed to pull ${e}:`,c),{key:e,status:"error"}}}async function V(e=!1,t=[],n=null){if(!F())return;let{value:s}=await S("syncEnabled");if(!s&&!e){console.log("[DB] Sync is disabled locally. Checking for remote status...");const r=K.syncEnabled;(await xt("syncEnabled",r,!1)).status===200&&(s=(await S("syncEnabled")).value)}if(!s&&!e||Tt&&!e)return;const i=Date.now();if(!(!e&&i-Jn<Qo)){Jn=i,Tt=!0,console.log(`[DB] Pulling user state (force=${e}, skip=${t.join(",")})...`);try{let r=[...t];const a=localStorage.getItem("theme");if(t.length>0&&!e&&a){console.log("[DB Sync] Verifying theme consistency before deferring heavy keys...");const f=K.theme;if((await xt("theme",f,!1)).status===200){const{value:p}=await S("theme");p!==a?(console.log(`[DB Sync] Theme mismatch detected (Local: ${a}, Server: ${p}). Aborting skip and pulling all state.`),r=[]):console.log("[DB Sync] Theme is consistent, proceeding with deferred sync.")}}const l=Object.entries(K).filter(([f,h])=>!h.localOnly&&f!=="syncEnabled"&&!r.includes(f)),d=(await Promise.allSettled(l.map(([f,h])=>xt(f,h,e)))).filter(f=>f.status==="fulfilled").map(f=>f.value).reduce((f,h)=>h?.timestamp&&h.timestamp>f?h.timestamp:f,"");d&&await Ie("lastStateSync",d),n&&n.loadFeedItemsFromDB&&(console.log("[DB Sync] State pull complete, triggering app data reload."),setTimeout(()=>{n._loadAndManageAllData&&n._loadAndManageAllData()},100))}catch(r){console.error("[DB] User state pull failed:",r)}finally{Tt=!1,console.log("[DB] User state pull completed.")}}}async function di(){return R(e=>e.getAll("feedItems")).catch(e=>(console.error("Failed to get all feed items:",e),[]))}async function fi(e,t,n,s){const r=[];for(let a=0;a<e.length;a+=50){if(!F())return console.warn("[DB] Offline mid-sync. Aborting batch fetch."),null;const l=e.slice(a,a+50),c=await Q();if(!c)return console.warn("[DB] No auth token available for batch fetch."),null;const u=await fetch(`${Ye}/api/list`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify({guids:l})});if(u.ok){const d=await u.json();if(r.push(...d),t){const f=s+r.length;t.progressMessage=`Fetching feed content... (${f}/${n})`}}else return console.error(`[DB] Failed to fetch batch. Status: ${u.status}`),null}return r}async function ae(e){const{value:t}=await S("syncEnabled");if(!F()||!t)return t&&console.log("[DB] Offline. Skipping feed sync."),!0;console.log("[DB] Fetching new feed items from worker (Delta Sync).");try{const n=await Q();if(!n)return console.warn("[DB] No auth token available for feed sync."),!1;let s=0;await R(async c=>{const u=await c.getAll("feedItems");u.length>0&&(s=Math.max(...u.map(d=>d.timestamp||0)))}),console.log(`[DB] Local newest item timestamp: ${s} (${new Date(s).toISOString()})`);const i=await fetch(`${Ye}/api/refresh`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({since:s})});if(!i.ok){if(i.status===429){console.warn("[DB] Sync throttled by server. Backing off.");const c=Date.now();return await Ie("lastFeedSync",c),e&&(e.lastFeedSync=c),!1}throw new Error(`HTTP error ${i.status} for /api/refresh`)}const a=(await i.json()).items||[];if(console.log(`[DB] Received ${a.length} new items from worker (Delta).`),a.length>0){const c=a.map(d=>d.guid);console.log(`[DB] Fetching full content for ${c.length} delta items...`);const u=await fi(c,e,c.length,0);u&&u.length>0?(await R(async d=>{const f=d.transaction("feedItems","readwrite");for(const h of u)h.guid&&await f.store.put(h);await f.done}),e&&e.loadFeedItemsFromDB&&await e.loadFeedItemsFromDB(),e&&e.loadAndDisplayDeck&&await e.loadAndDisplayDeck(),e&&e.updateCounts&&e.updateCounts()):console.warn("[DB] Failed to fetch full content for delta items.")}const l=Date.now();return await Ie("lastFeedSync",l),e&&(e.lastFeedSync=l),!0}catch(n){return console.error("[DB] Failed to synchronize feed from worker:",n),!1}}async function Tn(e){if(!F())return console.log("[DB] Skipping full sync: Offline."),!0;const{value:t}=await S("syncEnabled");if(!t)return!0;console.log("[DB] Full sync initiated.");try{return await oe(),await V(!1,[],e),await ae(e)}catch(n){return console.error("[DB] Full sync failed:",n),!1}}const Xo=Object.freeze(Object.defineProperty({__proto__:null,_fetchItemsInBatches:fi,getAllFeedItems:di,performFeedSync:ae,performFullSync:Tn,processPendingOperations:oe,pullUserState:V,queueAndAttemptSyncOperation:X},Symbol.toStringTag,{value:"Module"}));async function A(e,t,n="userSettings"){await R(i=>i.put(n,{key:e,value:t,lastModified:new Date().toISOString()}));const s=K[e];s&&!s.localOnly&&await X({type:"simpleUpdate",key:e,value:t,timestamp:new Date().toISOString()})}const Zo=e=>{switch(e){case"starred":return"starredAt";case"read":return"readAt";case"currentDeckGuids":return"addedAt";case"shuffledOutGuids":return"shuffledAt";default:return"updatedAt"}};async function ea(e,t){return R(n=>n.getFromIndex(e,"guid",t)).catch(n=>{console.error(`Error finding item by GUID '${t}' in store '${e}':`,n)})}async function hi(e,t,n){await R(async i=>{const r=i.transaction(e,"readwrite");if(!t||!t.guid){console.error("[DB] updateArrayState requires an item with a guid property.",t);return}const a=r.objectStore(e);if(n)await a.put(t);else{const l=await a.index("guid").get(t.guid);l?.id!==void 0&&await a.delete(l.id)}await r.done});const s=Object.entries(K).find(([,i])=>i.store===e);if(s&&!s[1].localOnly){let i="";e==="starred"&&(i="starDelta"),e==="read"&&(i="readDelta"),i&&await X({type:i,guid:t.guid,action:n?"add":"remove",timestamp:t[Zo(e)]||new Date().toISOString()})}}async function xn(e,t){const{value:n}=await be(e),s=new Set(n.map(u=>u.guid));await Qe(e,t);const i=new Set(t.map(u=>u.guid)),r=[...s].filter(u=>!i.has(u)),a=[...i].filter(u=>!i.has(u)),l=Object.entries(K).find(([,u])=>u.store===e);if(!l||l[1].localOnly)return;let c="";if(e==="starred"&&(c="starDelta"),e==="read"&&(c="readDelta"),!c){await X({type:"simpleUpdate",key:l[0],value:t,timestamp:new Date().toISOString()});return}if(r.length>0){console.log(`[DB] Queuing ${r.length} 'remove' operations for '${e}'.`);for(const u of r)await X({type:c,guid:u,action:"remove",timestamp:new Date().toISOString()})}if(a.length>0){console.log(`[DB] Queuing ${a.length} 'add' operations for '${e}'.`);for(const u of a)await X({type:c,guid:u,action:"add",timestamp:new Date().toISOString()})}}async function ta(e,t){if(!Array.isArray(e)||!Array.isArray(t)){console.warn("[DB] pruneStaleReadItems skipped due to invalid input.");return}const n=new Set(t.map(r=>r.guid)),s=Date.now(),i=e.filter(r=>{if(n.has(r.guid))return!0;const l=new Date(r.readAt).getTime(),c=(s-l)/(1440*60*1e3),u=c<30;return u||console.log(`[Pruning] Item ${r.guid} is stale (age: ${c.toFixed(1)} days) and not in current feed.`),u});if(i.length<e.length){const r=e.length-i.length;console.log(`[DB] Pruning ${r} stale read items.`),await xn("read",i)}else console.log("[DB] No stale read items to prune.")}async function Qe(e,t){return R(async n=>{const s=n.transaction(e,"readwrite");await s.store.clear();for(const i of t){const r=JSON.parse(JSON.stringify(i));delete r.id,await s.store.put(r)}await s.done})}const Xt=Object.freeze(Object.defineProperty({__proto__:null,findByGuid:ea,overwriteArrayAndSyncChanges:xn,pruneStaleReadItems:ta,saveArrayState:Qe,saveSimpleState:A,updateArrayState:hi},Symbol.toStringTag,{value:"Module"}));function ot(e){const t=new Date,n=new Date(e),s=Math.floor((t.getTime()-n.getTime())/1e3),i=336*60*60;if(s>i)return n.toLocaleString("en-GB",{weekday:"short",day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});const r=Math.floor(s/60),a=Math.floor(r/60),l=Math.floor(a/24);if(s<60)return"Just now";if(r<60)return`${r} minute${r!==1?"s":""} ago`;if(a<24)return`${a} hour${a!==1?"s":""} ago`;if(l<7)return`${l} day${l!==1?"s":""} ago`;const c=Math.floor(l/7);return`${c} week${c!==1?"s":""} ago`}function Zt(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function je(e){const t=[];if(!e)return t;if(Array.isArray(e))e.forEach(n=>{typeof n=="string"?t.push(n):n&&typeof n=="object"&&n.url&&t.push(n.url.trim())});else if(typeof e=="object")for(const n in e){const s=e[n];if(s&&typeof s=="object")for(const i in s){const r=s[i];Array.isArray(r)&&r.forEach(a=>{a&&a.url&&t.push(a.url.trim())})}}return t}function ht(e,t){if(!e)return console.warn("mapRawItem received an undefined or null item. Returning null."),null;const s=new DOMParser().parseFromString(e.description||"","text/html"),i=s.querySelectorAll("img");let r="";if(i.length>0){const f=i[0];r=f.src||"";let h=!1;const p=s.body.firstElementChild;(f===p||p?.tagName==="A"&&f===p.firstElementChild||p?.tagName==="P"&&f===p.firstElementChild||p?.tagName==="DIV"&&f===p.firstElementChild)&&(h=!0),(h||i.length===1)&&f.remove()}s.querySelectorAll("img").forEach(f=>{f.setAttribute("loading","lazy"),f.setAttribute("onload","this.classList.add('loaded')")});let a="";const l=s.querySelector(".source-url");l?(a=l.textContent?.trim()||"",l.remove()):a=e.source||(e.link?new URL(e.link).hostname:"");let c=s.body.innerHTML.trim();c=c.replace(/^<br\s*\/?>/i,""),c=c.replace(/<p><\/p>/gi,""),c=c.replace(/<div><\/div>/gi,"");const u=c.trim(),d=Date.parse(e.pubDate)||0;return{guid:e.guid,image:r||e.image||"",title:e.title,link:e.link,pubDate:t(e.pubDate||""),description:u,source:a,timestamp:d}}function gi(e,t){if(console.log(`ENTERING mapRawItems. rawList length: ${e.length}`),!Array.isArray(e))return console.warn("mapRawItems received a non-array input. Returning empty array."),[];const n=e.map(s=>ht(s,t)).filter(s=>s!==null).sort((s,i)=>i.timestamp-s.timestamp);return console.log(`EXITING mapRawItems. Returning length: ${n.length}`),n}async function en(e,t,n,s,i,r){console.log("ENTERING generateNewDeck with filterMode:",i,"isOnlineOverride:",r),console.log("generateNewDeck: allFeedItems count:",e.length),console.log("generateNewDeck: readItems count:",t.length);try{const{loadSimpleState:l}=await j(async()=>{const{loadSimpleState:g}=await Promise.resolve().then(()=>ui);return{loadSimpleState:g}},void 0),c=await l("keywordBlacklist"),u=(Array.isArray(c.value)?c.value:[]).map(g=>g.trim().toLowerCase()).filter(g=>g.length>0),d=g=>{if(u.length===0)return!1;const M=`${g.title} ${g.description} ${g.guid}`.toLowerCase();return u.some(T=>M.includes(T))},f=g=>{if(!Array.isArray(g))return new Set;const M=g.map(T=>typeof T=="object"&&"guid"in T&&T.guid?T.guid.toLowerCase():typeof T=="string"?T.toLowerCase():"");return new Set(M.filter(T=>!!T))},h=new Set(e.map(g=>g.guid)),p=new Set([...f(t)].filter(g=>h.has(g))),O=new Set([...f(n)].filter(g=>h.has(g))),$=new Set([...f(s)].filter(g=>h.has(g)));console.log(`[generateNewDeck] readGuidsSet size: ${p.size}`),console.log(`[generateNewDeck] shuffledOutGuidsSet size: ${$.size}`);let m=[];switch(console.log(`[generateNewDeck] Initial filteredItems count: ${m.length}`),i){case"read":m=e.filter(g=>p.has(g.guid));break;case"starred":m=e.filter(g=>O.has(g.guid));break;default:m=e.filter(g=>!p.has(g.guid)&&!$.has(g.guid)&&!d(g)),m.length===0&&(console.log("generateNewDeck: No unread/unshuffled items found, trying any unread items."),m=e.filter(g=>!p.has(g.guid)&&!d(g))),m.length===0&&(console.log("generateNewDeck: No unread items found, trying all unshuffled items."),m=e.filter(g=>!$.has(g.guid)&&!d(g))),m.length===0&&(console.log("generateNewDeck: Absolutely no filter matches, using all non-blacklisted items."),m=e.filter(g=>!d(g)));break}if(console.log("generateNewDeck: Final filteredItems count:",m.length),i==="read"||i==="starred")return m.sort((g,M)=>M.timestamp-g.timestamp),console.log(`[generateNewDeck] Filtered items for ${i}: ${m.length}`),m;let y=[];const b=new Set,v=g=>y.length<10&&g&&!b.has(g.guid)?(y.push(g),b.add(g.guid),!0):!1,E=(g,M)=>{let T=0;for(const z of g){if(T>=M||y.length>=10)break;v(z)&&T++}};if(typeof r=="boolean"?r:navigator.onLine){const g=Date.now(),M=D=>/<a\s+href=/i.test(D.description||""),T=D=>D.title?.includes("?"),z=D=>(D.description||"").length>=150&&D.description.substring(0,150).includes("?"),ne=D=>{const N=D.description||"";return N.length>=150&&N.substring(N.length-150).includes("?")},se=D=>D.hasQuestion||T(D)||z(D)||ne(D),fe=D=>D.hasImage||D.image!=="",Be=D=>(D.description||"").length>=750,H=D=>(D.description||"").length>0&&(D.description||"").length<750,k=m.filter(D=>g-D.timestamp<=1440*60*1e3);E(k,2),console.log(`[generateNewDeck] After recentItems: ${y.length}`);const w=m.filter(M);E(w,1),console.log(`[generateNewDeck] After itemsWithLinks: ${y.length}`);const I=m.filter(se);E(I,3),console.log(`[generateNewDeck] After itemsWithQuestion: ${y.length}`);const Z=m.filter(fe);E(Z,1),console.log(`[generateNewDeck] After itemsWithImages: ${y.length}`);const P=m.filter(Be);E(P,1),console.log(`[generateNewDeck] After longItems: ${y.length}`);const kt=m.filter(H);E(kt,1),console.log(`[generateNewDeck] After shortItems: ${y.length}`);const Ci=m.filter(D=>!b.has(D.guid)),Oi=Zt([...Ci]);for(const D of Oi){if(y.length>=10)break;v(D)}if(console.log(`[generateNewDeck] After shuffledRemaining: ${y.length}`),y.length<10){const D=e.filter(N=>$.has(N.guid)&&!p.has(N.guid)&&!b.has(N.guid));D.sort((N,ie)=>N.timestamp-ie.timestamp);for(const N of D){if(y.length>=10)break;v(N)}if(console.log(`[generateNewDeck] After resurfaceCandidates: ${y.length}`),y.length<10){const N=e.filter(ie=>!b.has(ie.guid));N.sort((ie,Ti)=>ie.timestamp-Ti.timestamp);for(const ie of N){if(y.length>=10)break;y.push(ie),b.add(ie.guid)}console.log(`[generateNewDeck] After remainingAllItems: ${y.length}`)}}}else{let g=[...m];const M=k=>k.title?.includes("?"),T=k=>k.description?.length>=150&&k.description.substring(0,150).includes("?"),z=k=>{const w=k.description;return w?.length>=150&&w.substring(w.length-150).includes("?")},ne=k=>/<a\s+href=/i.test(k.description),se=k=>k.image!=="";if(g=g.filter(k=>!M(k)),g=g.filter(k=>!(k.description&&T(k))),g=g.filter(k=>!(k.description&&z(k))),g=g.filter(k=>!ne(k)),g=g.filter(k=>!se(k)),g.length<10){let k=m.filter(I=>!g.includes(I));const w=[I=>se(I),I=>ne(I),I=>I.description&&z(I),I=>I.description&&T(I),I=>M(I)];for(const I of w){for(;g.length<10;){const Z=k.find(I);if(Z)g.push(Z),k=k.filter(P=>P!==Z);else break}if(g.length>=10)break}for(;g.length<10&&k.length>0;)g.push(k.shift())}const fe=Date.now();y=g.filter(k=>fe-k.timestamp<=1440*60*1e3).slice(0,2);const H=g.filter(k=>!y.includes(k));y=y.concat(H.slice(0,10-y.length))}return Zt([...y])}catch(a){return console.error("An error occurred during deck generation:",a),[]}}const Yn=Object.freeze(Object.defineProperty({__proto__:null,formatDate:ot,generateNewDeck:en,mapRawItem:ht,mapRawItems:gi,parseRssFeedsConfig:je,shuffleArray:Zt},Symbol.toStringTag,{value:"Module"}));function tn(e){try{return JSON.parse(JSON.stringify(e))}catch(n){console.error("JSON serialization failed during sanitization, using manual fallback.",n)}const t={};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const s=e[n],i=typeof s;i==="object"&&s!==null?Array.isArray(s)?t[n]=s.map(r=>tn(r)):t[n]=tn(s):i!=="function"&&i!=="symbol"&&i!=="undefined"&&(t[n]=s)}return t}async function nn(e,t,n){const s=t.toLowerCase(),r=e[n].some(c=>c.guid.toLowerCase()===s)?"remove":"add",a=new Date().toISOString(),l=n==="read"?{guid:t,readAt:a}:{guid:t,starredAt:a};r==="add"?n==="read"?e.read=[...e.read,l]:e.starred=[...e.starred,l]:n==="read"?e.read=e.read.filter(c=>c.guid!==t):e.starred=e.starred.filter(c=>c.guid!==t),typeof e.updateCounts=="function"&&e.updateCounts(),(async()=>{try{await hi(n,l,r==="add");const u={type:`${n}Delta`,guid:t,action:r,timestamp:a};await X(u)}catch(c){console.error(`[Background State Update] Failed for ${n} on ${t}:`,c)}})()}async function mi(e,t,n){if(!Array.isArray(t))return[];if(!Array.isArray(e)||e.length===0)return t;const s=new Set(e.filter(i=>i&&i.guid).map(i=>String(i.guid).trim().toLowerCase()));return t.filter(i=>{if(!i||!i.guid)return console.log("[Pruning] Removing invalid/empty read item."),!1;const r=String(i.guid).trim().toLowerCase();if(s.has(r))return!0;if(i.readAt){const l=new Date(i.readAt).getTime();if(!isNaN(l)){const c=(n-l)/864e5,u=c<30;return u||console.log(`[Pruning] Removing stale read item ${r} (age: ${c.toFixed(1)} days)`),u}}return!0})}async function yi(e){const{value:t}=await be("read");let n=!1,s=[];if(Array.isArray(t)){const r=new Date().toISOString();for(const a of t)if(typeof a=="string"&&a)s.push({guid:a,readAt:r}),n=!0;else if(typeof a=="object"&&a!==null&&typeof a.guid=="string"&&a.guid){const l=a.readAt||a.timestamp;a.readAt||(a.readAt=l||r,n=!0),s.push(a)}}console.log(`[Pruning] Checking ${s.length} read items against ${e.length} feed items.`);const i=await mi(e,s,Date.now());if(i.length!==s.length?(console.log(`[Pruning] ${s.length-i.length} items pruned.`),n=!0):console.log("[Pruning] No items were pruned."),n)try{await Qe("read",i),console.log(`Sanitized, pruned, or migrated read items. Original count: ${t.length}, New count: ${i.length}`)}catch(r){console.error("Error saving pruned read items:",r)}return i}async function pi(){const{value:e}=await be("currentDeckGuids");if(e&&e.length>0&&typeof e[0]=="string"){console.log("[loadCurrentDeck] Migrating legacy string-based deck data...");const n=new Date().toISOString(),s=e.map(i=>({guid:i,addedAt:n}));return await Qe("currentDeckGuids",s),console.log(`[loadCurrentDeck] Migration complete. Loaded ${s.length} objects.`),s}const t=Array.isArray(e)?e.filter(n=>typeof n=="object"&&n!==null&&typeof n.guid=="string"&&n.guid):[];return console.log(`[loadCurrentDeck] Loaded ${t.length} deck objects.`),t}async function wi(e){if(!Array.isArray(e)){console.error("[saveCurrentDeck] Invalid input: expected an array of objects.");return}const t=e.filter(n=>typeof n=="object"&&n!==null&&typeof n.guid=="string"&&n.guid);t.length!==e.length&&console.warn("[saveCurrentDeck] Filtered out invalid items from the generated deck."),console.log("[saveCurrentDeck] Saving",t.length,"deck objects.");try{const n=t.map(s=>tn(s));await xn("currentDeckGuids",n)}catch(n){console.error("[saveCurrentDeck] An error occurred while saving the deck:",n)}}async function Si(){const{value:e}=await S("shuffleCount"),{value:t}=await S("lastShuffleResetDate");return{shuffleCount:typeof e=="number"?e:2,lastShuffleResetDate:t||null}}async function gt(e,t){await A("shuffleCount",e),await A("lastShuffleResetDate",t),await X({type:"simpleUpdate",key:"shuffleCount",value:e,timestamp:new Date().toISOString()}),await X({type:"simpleUpdate",key:"lastShuffleResetDate",value:t,timestamp:new Date().toISOString()})}async function bi(e,t){e.filterMode=t,await A("filterMode",t),await X({type:"simpleUpdate",key:"filterMode",value:t,timestamp:new Date().toISOString()})}async function _i(){const{value:e}=await S("filterMode");return e||"unread"}const sn=Object.freeze(Object.defineProperty({__proto__:null,loadAndPruneReadItems:yi,loadCurrentDeck:pi,loadFilterMode:_i,loadShuffleState:Si,pruneStaleRead:mi,saveCurrentDeck:wi,saveShuffleState:gt,setFilterMode:bi,toggleItemStateAndSync:nn},Symbol.toStringTag,{value:"Module"})),na=()=>document.getElementById("sync-toggle"),sa=()=>document.getElementById("images-toggle"),ia=()=>document.getElementById("open-urls-in-new-tab-toggle"),ra=()=>document.getElementById("shadows-toggle"),oa=()=>document.getElementById("curves-toggle"),aa=()=>document.getElementById("flick-to-select-toggle"),la=()=>document.querySelector("#ntn-title h2");function ca(e,t=30){const n=e.split(" ");let s=[],i=[],r=0;for(const a of n){const l=a.length+(s.length>0?1:0);r+l<=t?(s.push(a),r+=l):i.push(a)}return[s.join(" "),i.join(" ")].filter(Boolean)}async function ki(e){const t=la();if(!t){console.warn("displayTemporaryMessageInTitle: 'ntn-title h2' element not found.");return}const n="NOT THE NEWS",s=ca(e),i=t.style.overflow;t.style.overflow="visible";const r=a=>new Promise(l=>setTimeout(l,a));s.length>0&&(t.textContent=s[0],await r(1500)),s.length>1?(t.textContent=s.join(" "),await r(1500)):s.length===1&&await r(1500),t.textContent=n,t.style.overflow=i}let $t;function _(e,t){console.log(`[Status] ${t}`),$t&&clearTimeout($t),e.syncStatusMessage=t;const n=()=>{e.showSyncStatus=!0,$t=setTimeout(()=>{e.showSyncStatus=!1,setTimeout(()=>{e.showSyncStatus||(e.syncStatusMessage="")},300)},1e3)};e.$nextTick?e.$nextTick(n):n()}let Mt;function vi(e,t,n=null){Mt&&clearTimeout(Mt),e.undoStack.push({guid:t,index:n}),e.undoItemGuid=t,e.undoItemIndex=n,e.showUndo=!0,e.undoTimerActive=!1,e.$nextTick(()=>{requestAnimationFrame(()=>{const s=document.querySelector("#undo-notification .undo-button");if(s&&e.curvesEnabled){const i=s.getBoundingClientRect().height;console.log(`[Undo] Measured button height: ${i}`),i>10&&(e.undoBtnRadius=i/2-2)}else s&&!e.curvesEnabled&&(e.undoBtnRadius=0);e.undoTimerActive=!0})}),Mt=setTimeout(()=>{e.showUndo=!1,e.undoTimerActive=!1,setTimeout(()=>{e.showUndo||(e.undoItemGuid=null,e.undoStack=[])},500)},5e3)}function rn(e){const t=document.getElementById("main-settings"),n=document.getElementById("appearance-settings-block"),s=document.getElementById("behavior-settings-block"),i=document.getElementById("rss-settings-block"),r=document.getElementById("keywords-settings-block"),a=document.getElementById("css-settings-block"),l=document.getElementById("advanced-settings-block"),c=document.getElementById("backup-settings-block"),u=document.getElementById("restore-settings-block");if(!t||!n||!s||!i||!r||!a||!l||!c||!u)return console.warn("One or more settings panels not found."),Promise.resolve();switch(t.style.display="none",n.style.display="none",s.style.display="none",i.style.display="none",r.style.display="none",a.style.display="none",l.style.display="none",c.style.display="none",u.style.display="none",e.modalView){case"main":t.style.display="block";break;case"appearance":n.style.display="block";break;case"behavior":s.style.display="block";break;case"rss":i.style.display="block";break;case"keywords":r.style.display="block";break;case"css":a.style.display="block";break;case"advanced":l.style.display="block";break;case"backup":c.style.display="block";break;case"restore":u.style.display="block";break;default:console.warn("Unknown modalView:",e.modalView),t.style.display="block"}return Promise.resolve()}function Di(e){!e?.entries?.length||!e.read||!e.starred||e.currentDeckGuids}function $n(){window.scrollTo({top:0,behavior:"smooth"})}let Ei=!1;function ua(e){Ei=e}const Ai=(()=>{let e,t=0;return(n="scroll-to-top")=>{const s=document.getElementById(n);if(!s)return;const i=()=>{if(Ei){s.classList.remove("visible"),t=window.scrollY;return}const r=window.scrollY;s.classList.toggle("visible",r<t&&r>0),t=r,clearTimeout(e),e=setTimeout(()=>s.classList.remove("visible"),2e3)};window.addEventListener("scroll",i),s.addEventListener("click",r=>{r.preventDefault(),$n()})}})();async function ve(){let e="",t=0;const n=document.querySelectorAll(".entry[data-guid]"),s=Array.from(n).find(i=>i.getBoundingClientRect().bottom>0);if(s){const i=s.getBoundingClientRect();e=s.dataset.guid||"",t=i.top}await A("lastViewedItemId",e),await A("lastViewedItemOffset",t)}const da=Object.freeze(Object.defineProperty({__proto__:null,attachScrollToTopHandler:Ai,createStatusBarMessage:_,displayTemporaryMessageInTitle:ki,manageSettingsPanelVisibility:rn,saveCurrentScrollPosition:ve,scrollToTop:$n,setKeyboardScrolling:ua,showUndoNotification:vi,updateCounts:Di},Symbol.toStringTag,{value:"Module"})),fa={syncEnabled:"Auto-Sync",imagesEnabled:"Images",itemButtonMode:"Item Button",openUrlsInNewTabEnabled:"Open in New Tab",shadowsEnabled:"Shadows",curvesEnabled:"Curves",flickToSelectEnabled:"Flick to Select"};async function Me(e,t,n,s=()=>{}){const i=t();i&&i.addEventListener("change",async()=>{const r=e[n];await A(n,r);const a=fa[n]||n;_(e,`${a} ${r?"Enabled":"Disabled"}.`),s(r)})}async function ha(e){await Me(e,na,"syncEnabled",async t=>{e.updateSyncStatusMessage?.(),t&&(console.log("Sync enabled, triggering full sync."),await Tn(e)||_(e,"Sync finished with some issues."),e._loadAndManageAllData&&await e._loadAndManageAllData())})}async function ga(e){await Me(e,sa,"imagesEnabled")}async function ma(e){const t=document.getElementById("item-button-mode-selector");t&&t.addEventListener("change",async()=>{const n=e.itemButtonMode;await A("itemButtonMode",n),_(e,`Item Button set to ${n}.`)})}async function ya(e){await Me(e,ra,"shadowsEnabled")}async function pa(e){await Me(e,oa,"curvesEnabled")}async function wa(e){await Me(e,aa,"flickToSelectEnabled")}async function Sa(e){await Me(e,ia,"openUrlsInNewTabEnabled")}async function ba(e){window.requestAnimationFrame(async()=>{const{value:t}=await S("lastViewedItemId"),{value:n}=await S("lastViewedItemOffset");if(!t||!e.deck?.length)return;if(e.deck.some(i=>i.guid===t)){const i=document.querySelector(`.entry[data-guid="${t}"]`);i&&(e.selectedGuid=t,i.scrollIntoView({behavior:"auto",block:"start"}),typeof n=="number"&&n!==0&&window.scrollTo({top:window.scrollY-n,behavior:"auto"}))}})}let st;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),st=e;const t=document.getElementById("install-button");t&&(t.style.display="block",t.addEventListener("click",()=>{st.prompt(),st.userChoice.then(n=>{n.outcome==="accepted"?console.log("PWA installed"):console.log("PWA installation dismissed"),st=null})}))});const Fe=2,ee=e=>typeof e=="object"&&e.guid?e.guid:e,at=async(e,t,n,s,i,r="unread",a=null,l=null)=>{if(console.log("manageDailyDeck: START"),console.log("manageDailyDeck: Input params:",{entriesCount:e.length,readItemsCount:t.length,starredItemsCount:n.length,shuffledOutItemsCount:s.length,shuffleCount:i,filterMode:r,lastShuffleResetDate:a,hasPregen:!!l}),!Array.isArray(e)||e.length===0)return console.log("[deckManager] Skipping deck management: entries is empty."),{deck:[],currentDeckGuids:[],shuffledOutGuids:Array.isArray(s)?s:[],shuffleCount:typeof i=="number"?i:Fe,lastShuffleResetDate:typeof a=="string"?a:new Date().toDateString()};const c=Array.isArray(t)?t:[],u=Array.isArray(n)?n:[],d=Array.isArray(s)?s:[],{loadCurrentDeck:f}=await j(async()=>{const{loadCurrentDeck:w}=await Promise.resolve().then(()=>sn);return{loadCurrentDeck:w}},void 0),h=await f(),{loadSimpleState:p}=await j(async()=>{const{loadSimpleState:w}=await Promise.resolve().then(()=>ui);return{loadSimpleState:w}},void 0),O=await p("keywordBlacklist"),$=(Array.isArray(O.value)?O.value:[]).map(w=>w.trim().toLowerCase()).filter(w=>w.length>0),m=w=>{if($.length===0)return!1;const I=`${w.title} ${w.description} ${w.guid}`.toLowerCase();return $.some(Z=>I.includes(Z))},y=new Set(c.map(w=>ee(w).toLowerCase())),b=new Set(u.map(w=>ee(w).toLowerCase())),v=new Set(d.map(w=>ee(w).toLowerCase())),E=new Map(e.map(w=>[w.guid.toLowerCase(),w]));let L=h.map(w=>E.get(ee(w).toLowerCase())).filter(w=>!!w);const g=new Date().toDateString(),M=a!==g,T=!h||h.length===0||L.length===0,z=T||L.every(w=>{const I=w.guid.toLowerCase();return y.has(I)||v.has(I)||m(w)}),ne=!T&&L.every(w=>v.has(w.guid.toLowerCase()));let se=L,fe=h,Be=d,H=typeof i=="number"?i:Fe,k=a||g;if(M||z||r!=="unread"||h.length===0&&e.length>0){console.log(`[deckManager] Resetting deck. Reason: New Day (${M}), Deck Effectively Empty (${z}), Filter Mode Changed (${r}), or Initial Load (${h.length===0}).`),!M&&h.length>0&&z&&r==="unread"&&(ne||(console.log("[deckManager] Automatically incrementing (refunding) shuffleCount due to deck cleared by reading."),H=Math.min(Fe,H+1),await gt(H,k)));let w=[],I=!1;if(l&&l.length>0&&(l.some(kt=>!y.has(ee(kt)))?I=!0:console.log("[deckManager] Pre-generated deck is stale (all items read). Falling back to manual generation.")),I&&l){if(console.log("[deckManager] Using pre-generated deck inside manageDailyDeck"),w=[...l],w.length<10){console.log(`[deckManager] Pregen is small (${w.length}), topping up to 10.`);const P=await en(e,c,u,[...d,...w.map(ee)],r);w=[...w,...P].slice(0,10)}}else console.log("[deckManager] Generating new deck from scratch inside manageDailyDeck"),w=await en(e,c,u,d,r);const Z=new Date().toISOString();fe=(w||[]).map(P=>({guid:ee(P),addedAt:Z})),se=(w||[]).map(P=>E.get(ee(P))).filter(P=>!!P).map(P=>({...P,isRead:y.has(P.guid),isStarred:b.has(P.guid)})),await wi(fe),M&&(Be=[],await Qe("shuffledOutGuids",[]),H=Fe,await gt(H,g),k=g,await A("lastShuffleResetDate",g))}else se=L.map(w=>({...w,isRead:y.has(w.guid),isStarred:b.has(w.guid)}));return{deck:se||[],currentDeckGuids:fe||[],shuffledOutGuids:Be||[],shuffleCount:typeof H=="number"?H:Fe,lastShuffleResetDate:typeof k=="string"?k:new Date().toDateString()}};async function _a(e){if(console.log("[deckManager] processShuffle called."),e.shuffleCount<=0){_(e,"No shuffles left for today!");return}const t=e.deck.map(h=>h.guid);console.log(`[deckManager] processShuffle: Visible GUIDs to shuffle out: ${t.length}`,t);const n=(e.shuffledOutGuids||[]).map(h=>({guid:ee(h),shuffledAt:new Date().toISOString()})),s=new Set(n.map(h=>h.guid.toLowerCase())),i=new Set([...s,...t.map(h=>h.toLowerCase())]),r=new Date().toISOString(),a=Array.from(i).map(h=>({guid:h,shuffledAt:r}));e.shuffledOutGuids=a,e.shuffleCount--;const{overwriteArrayAndSyncChanges:l}=await j(async()=>{const{overwriteArrayAndSyncChanges:h}=await Promise.resolve().then(()=>Xt);return{overwriteArrayAndSyncChanges:h}},void 0);await l("shuffledOutGuids",a),await gt(e.shuffleCount,e.lastShuffleResetDate??new Date().toDateString());const c=e.isOnline,u=c?"pregeneratedOnlineDeck":"pregeneratedOfflineDeck",d=e[u],f=await at(e.entries,e.read,e.starred,e.shuffledOutGuids,e.shuffleCount,e.filterMode,e.lastShuffleResetDate,d);if(e.deck=f.deck,e.currentDeckGuids=f.currentDeckGuids,e.shuffledOutGuids=f.shuffledOutGuids,e.shuffleCount=f.shuffleCount,e.lastShuffleResetDate=f.lastShuffleResetDate,d&&d.length>0&&e.currentDeckGuids.length>0&&e.currentDeckGuids[0].guid===d[0].guid){console.log(`[deckManager] Consumed pre-generated ${c?"ONLINE":"OFFLINE"} deck in processShuffle.`),u==="pregeneratedOnlineDeck"?e.pregeneratedOnlineDeck=null:e.pregeneratedOfflineDeck=null;const{saveSimpleState:h}=await j(async()=>{const{saveSimpleState:p}=await Promise.resolve().then(()=>Xt);return{saveSimpleState:p}},void 0);await h(u,null)}e.deck.length>0&&(e.selectedGuid=null,e.$nextTick(()=>{e.deck.length>0&&e.selectItem(e.deck[0].guid)})),ki("Feed shuffled!"),console.log(`[deckManager] Deck shuffled. Remaining shuffles: ${e.shuffleCount}.`),e.pregenerateDecks()}const ka=1e4;async function Bt(e,t){const n=Date.now();if(e.selectedGuid&&e.selectedTimestamp&&n-e.selectedTimestamp>ka){console.log("[Navigation] Selection is old (>10s). Reselecting current item.");const i=e.selectedGuid;e.selectedGuid=null,e.$nextTick(()=>{e.selectedGuid=i})}else{const{setKeyboardScrolling:i}=await j(async()=>{const{setKeyboardScrolling:r}=await Promise.resolve().then(()=>da);return{setKeyboardScrolling:r}},void 0);i(!0),await va(e,t),setTimeout(()=>i(!1),1e3)}}async function Ii(e,t){const n=e.target;if(n.tagName==="INPUT"||n.tagName==="TEXTAREA"||n.isContentEditable)return;const s=e.key,i=e.ctrlKey||e.metaKey;if(t.openSettings){if(["j","k","s","L","i","o","Enter","r","m","t","u","p"," ","ArrowUp","ArrowDown"].includes(s)&&!i){if(s==="Enter"&&["BUTTON","SELECT","A","INPUT","TEXTAREA"].includes(n.tagName))return;e.preventDefault()}const a=document.querySelector(".modal-content");if(!a){s==="Escape"&&(e.preventDefault(),t.openSettings=!1);return}const c=Array.from(a.querySelectorAll('button, select, input, textarea, [tabindex]:not([tabindex="-1"])')).filter(h=>{const p=window.getComputedStyle(h);return p.display!=="none"&&p.visibility!=="hidden"&&h.offsetParent!==null});if(s==="Escape"){e.preventDefault(),t.openSettings=!1;return}if(c.length===0)return;const u=c[0],d=c[c.length-1],f=c.indexOf(document.activeElement);if(s==="Tab"&&(e.shiftKey?document.activeElement===u&&(e.preventDefault(),d.focus()):document.activeElement===d&&(e.preventDefault(),u.focus())),s==="ArrowDown"||s==="j"&&!i){e.preventDefault();const h=(f+1)%c.length;c[h].focus()}if(s==="ArrowUp"||s==="k"&&!i){e.preventDefault();const h=(f-1+c.length)%c.length;c[h].focus()}if(n.tagName==="INPUT"&&n.type==="range"&&(s==="ArrowLeft"||s==="ArrowRight"||s==="h"&&!i||s==="l"&&!i)){e.preventDefault();const h=parseFloat(n.step)||1,p=parseFloat(n.value),$=s==="ArrowRight"||s==="l"?p+h:p-h;n.value=$.toString(),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))}s==="Enter"&&n.tagName!=="SELECT"&&(e.preventDefault(),n.click());return}if(t.openShortcuts&&s!=="?"&&s!=="Escape"&&!(s==="k"&&i)){["ArrowUp","ArrowDown","PageUp","PageDown","Home","End"," ","j","k"].includes(s)&&e.preventDefault();return}if(!(e.shiftKey&&["j","k","ArrowDown","ArrowUp"].includes(s)))switch(s){case"j":case"ArrowDown":e.preventDefault(),await Bt(t,1);break;case"k":i?(e.preventDefault(),t.openShortcuts=!t.openShortcuts):(e.preventDefault(),await Bt(t,-1));break;case"ArrowUp":e.preventDefault(),await Bt(t,-1);break;case"l":case"ArrowRight":t.selectedGuid&&(e.preventDefault(),t.selectedSubElement==="item"?t.selectedSubElement="read":t.selectedSubElement==="read"?t.selectedSubElement="star":t.selectedSubElement==="star"&&(t.selectedSubElement="play",setTimeout(()=>{const r=document.querySelector(`.entry[data-guid="${t.selectedGuid}"]`),a=r?.querySelector(".play-button");if(r&&a){const l=r.getBoundingClientRect(),c=a.getBoundingClientRect(),u=window.innerHeight;if(l.bottom>u){const d=c.bottom-u+20;window.scrollBy({top:d,behavior:"smooth"})}}},50)));break;case"h":case"ArrowLeft":t.selectedGuid&&(e.preventDefault(),t.selectedSubElement==="play"?t.selectedSubElement="star":t.selectedSubElement==="star"?t.selectedSubElement="read":t.selectedSubElement==="read"&&(t.selectedSubElement="item"));break;case"p":t.selectedGuid&&(e.preventDefault(),t.speakItem(t.selectedGuid));break;case" ":case"n":e.preventDefault(),t.selectedGuid?await t.toggleRead(t.selectedGuid):t.filteredEntries.length>0&&(t.selectedGuid=t.filteredEntries[0].guid,Mn(t.selectedGuid,t));break;case"s":case"L":t.selectedGuid&&(e.preventDefault(),await t.toggleStar(t.selectedGuid));break;case"i":e.preventDefault(),t.imagesEnabled=!t.imagesEnabled,_(t,`Images ${t.imagesEnabled?"Enabled":"Disabled"}.`),j(()=>Promise.resolve().then(()=>Xt),void 0).then(r=>{r.saveSimpleState("imagesEnabled",t.imagesEnabled)});break;case"o":case"Enter":if(t.selectedGuid)if(e.preventDefault(),t.selectedSubElement==="read")await t.toggleRead(t.selectedGuid);else if(t.selectedSubElement==="star")await t.toggleStar(t.selectedGuid);else if(t.selectedSubElement==="play")t.itemButtonMode==="menu"?t.toggleItemMenu(t.selectedGuid):t.speakItem(t.selectedGuid);else{const r=t.filteredEntries.find(a=>a.guid===t.selectedGuid);r?.link&&window.open(r.link,"_blank","noopener,noreferrer")}break;case"r":case"m":t.selectedGuid&&(e.preventDefault(),await t.toggleRead(t.selectedGuid));break;case"t":e.preventDefault(),t.scrollToTop();break;case"u":e.preventDefault(),await t.undoMarkRead();break;case"/":e.preventDefault(),t.toggleSearch();break;case"?":e.preventDefault(),t.openShortcuts?t.openShortcuts=!1:t.openShortcuts=!0;break;case"Escape":t.openShortcuts?(e.preventDefault(),t.openShortcuts=!1):t.openSettings?(e.preventDefault(),t.openSettings=!1):t.selectedGuid&&(e.preventDefault(),t.selectedGuid=null);break;case"z":i&&(e.preventDefault(),await t.undoMarkRead());break}}async function va(e,t){const n=e.filteredEntries;if(n.length!==0){if(e.selectedGuid){let i=n.findIndex(r=>r.guid===e.selectedGuid)+t;i>=n.length&&(i=n.length-1),i<0&&(i=0),e.selectedGuid=n[i].guid}else{const s=e.lastSelectedGuid,i=s?n.findIndex(r=>r.guid===s):-1;if(i===-1)e.selectedGuid=n[0].guid;else{let r=i+t;r>=n.length&&(r=n.length-1),r<0&&(r=0),e.selectedGuid=n[r].guid}}Mn(e.selectedGuid,e)}}function Mn(e,t){if(e){if(t.filteredEntries.length>0&&t.filteredEntries[0].guid===e){t.scrollToTop();return}setTimeout(()=>{const n=document.querySelector(`.entry[data-guid="${e}"]`);if(n){const s=document.querySelector("#header"),i=s?s.getBoundingClientRect().height:0,a=n.getBoundingClientRect().top+window.pageYOffset-i-20;window.scrollTo({top:a,behavior:"smooth"})}},10)}}const Da=Object.freeze(Object.defineProperty({__proto__:null,handleKeyboardShortcuts:Ii,scrollSelectedIntoView:Mn},Symbol.toStringTag,{value:"Module"}));let De=null;function Ea(e){return new DOMParser().parseFromString(e,"text/html").body.textContent||""}function Aa(e){const t=new DOMParser().parseFromString(e,"text/html");let n=0;const s=i=>{if(i.nodeType===Node.TEXT_NODE){const r=i.textContent?.split(/(\s+)/)||[],a=document.createDocumentFragment();r.forEach(l=>{if(l.trim().length>0){const c=document.createElement("span");c.classList.add("tts-word"),c.dataset.wordIndex=n.toString(),c.textContent=l,a.appendChild(c),n++}else a.appendChild(document.createTextNode(l))}),i.parentNode?.replaceChild(a,i)}else i.nodeType===Node.ELEMENT_NODE&&Array.from(i.childNodes).forEach(s)};return Array.from(t.body.childNodes).forEach(s),t.body.innerHTML}function Ia(e,t){if(e.speakingGuid===t){console.log(`[TTS] Stopping speech for ${t}`),on(e);return}const n=e.entries.find(c=>c.guid===t);if(!n)return;on(e),e.entries.forEach(c=>{c._originalDescription&&(c.description=c._originalDescription)}),e.speakingGuid=t,n._originalDescription||(n._originalDescription=n.description),n.description=Aa(n._originalDescription);const s=Ea(n._originalDescription),i=`${n.title}. ${s}`.replace(/\s+/g," ").trim();console.log(`[TTS] Speaking item: ${n.title.substring(0,30)}...`);const r=new SpeechSynthesisUtterance(i),a=window.speechSynthesis.getVoices(),l=a.find(c=>c.lang.startsWith("en")&&(c.name.includes("Google")||c.name.includes("Natural")))||a.find(c=>c.lang.startsWith("en"))||a[0];l&&(console.log(`[TTS] Voice: ${l.name}`),r.voice=l),r.onboundary=c=>{if(c.name==="word"){const u=c.charIndex,f=(i.substring(0,u).match(/\S+/g)||[]).length;requestAnimationFrame(()=>{const h=document.querySelector(`.entry[data-guid="${t}"] .itemdescription`);if(h){h.querySelectorAll(".tts-highlight").forEach(O=>O.classList.remove("tts-highlight"));const p=h.querySelector(`.tts-word[data-word-index="${f}"]`);p&&p.classList.add("tts-highlight")}})}},r.onstart=()=>console.log("[TTS] Audio started"),r.onend=()=>{console.log("[TTS] Audio finished"),e.speakingGuid===t&&an(e,n)},r.onerror=c=>{console.error("[TTS] Engine error:",c.error),e.speakingGuid===t&&an(e,n)},De&&clearInterval(De),window.speechSynthesis.cancel(),window.speechSynthesis.resume(),setTimeout(()=>{window.speechSynthesis.speak(r),De=setInterval(()=>{if(!e.speakingGuid){clearInterval(De);return}window.speechSynthesis.speaking&&(window.speechSynthesis.pause(),window.speechSynthesis.resume())},1e4)},50)}function on(e){if(window.speechSynthesis.cancel(),De&&clearInterval(De),e.speakingGuid){const t=e.entries.find(n=>n.guid===e.speakingGuid);t&&an(e,t)}}function an(e,t){e.speakingGuid=null,t._originalDescription&&(t.description=t._originalDescription);const n=document.querySelector(`.entry[data-guid="${t.guid}"] .itemdescription`);n&&n.querySelectorAll(".tts-highlight").forEach(s=>s.classList.remove("tts-highlight"))}function Ca(e,t){if(!t||t.trim()==="")return e;const n=t.toLowerCase().trim().split(/\s+/);return e.filter(s=>{const i=(s.title||"").toLowerCase(),r=(s.description||"").toLowerCase(),a=`${i} ${r}`;return n.every(l=>a.includes(l))})}function Oa(e){e.showSearchBar=!e.showSearchBar,e.showSearchBar?(e.searchQuery="",e.$nextTick(()=>{const t=document.getElementById("search-input");t&&t.focus()})):e.searchQuery=""}const Ta="https://news.loveopenly.net";async function xa(e){const t=await fetch(`${Ta}/api/lookup?url=${encodeURIComponent(e)}`);if(!t.ok){const n=await t.json();throw new Error(n.error||`Discovery failed with status ${t.status}`)}return t.json()}async function $a(e){const t=e.discoveryUrl.trim();if(t){e.isDiscovering=!0,e.discoveryError="",e.discoveryResults=[];try{const n=await xa(t);e.discoveryResults=n.feeds,n.feeds.length===0&&(e.discoveryError="No feeds found on this website.",_(e,"No RSS feeds found at this URL."))}catch(n){console.error("[Discovery] Error:",n),e.discoveryError=n.message}finally{e.isDiscovering=!1}}}const Ge="https://news.loveopenly.net";let Ue=!1,ln=!1;$i(U,e=>{const t=window.location.pathname;Ue=!0,console.log(`[Auth Event] User: ${e?.uid||"null"}, Path: ${t}, Initialized: ${ln}`),e?(localStorage.setItem("isAuthenticated","true"),t.endsWith("login.html")&&(console.log("[Auth Check] Already logged in, redirecting to home"),window.location.replace("/"))):(localStorage.removeItem("isAuthenticated"),ln&&!t.endsWith("login.html")&&(console.log("[Auth Check] User session ended, redirecting to login.html"),window.location.replace("/login.html")))});function Ma(){return{loading:!0,progressMessage:"Initializing...",deck:[],feedItems:{},filterMode:"unread",openSettings:!1,openShortcuts:!1,modalView:"main",showSearchBar:!1,searchQuery:"",shuffleCount:0,lastShuffleResetDate:null,lastFeedSync:0,syncEnabled:!0,imagesEnabled:!0,itemButtonMode:"play",openUrlsInNewTabEnabled:!0,rssFeedsInput:"",keywordBlacklistInput:"",discoveryUrl:"",isDiscovering:!1,discoveryResults:[],discoveryError:"",shadowsEnabled:!0,curvesEnabled:!0,flickToSelectEnabled:!1,entries:[],read:[],starred:[],currentDeckGuids:[],shuffledOutGuids:[],pregeneratedOnlineDeck:null,pregeneratedOfflineDeck:null,errorMessage:"",userEmail:"",isOnline:F(),deckManaged:!1,syncStatusMessage:"",showSyncStatus:!1,theme:localStorage.getItem("theme")||"dark",themeStyle:localStorage.getItem("theme")==="light"?localStorage.getItem("themeStyleLight")||"originalLight":localStorage.getItem("themeStyleDark")||"originalDark",themeStyleLight:localStorage.getItem("themeStyleLight")||"originalLight",themeStyleDark:localStorage.getItem("themeStyleDark")||"originalDark",fontTitle:"'Playfair Display', serif",fontBody:"inherit",_initialRssFeedsInput:"",_initialKeywordBlacklistInput:"",customCss:"",fontSize:100,feedWidth:50,animationSpeed:100,showUndo:!1,undoTimerActive:!1,undoItemGuid:null,undoItemIndex:null,undoStack:[],undoBtnRadius:20,selectedGuid:null,selectedSubElement:"item",selectedTimestamp:null,lastSelectedGuid:null,starredGuid:null,activeMenuGuid:null,readingGuid:null,speakingGuid:null,closingGuid:null,nextSwipeDirection:"left",fullscreenImage:null,activeExpandGuid:null,db:null,_lastFilterHash:"",_cachedFilteredEntries:null,scrollObserver:null,imageObserver:null,staleItemObserver:null,_initComplete:!1,_isSyncing:!1,_isPregenerating:!1,backupSelections:{feeds:!0,appearance:!0,history:!0,settings:!0},showRestorePreview:!1,restoreData:null,initApp:async function(){try{const e=localStorage.getItem("isAuthenticated")==="true";if(e)console.log("[Auth] Hint found, proceeding with optimistic load.");else{console.log("[Auth] No hint found, waiting for verification..."),this.progressMessage="Verifying authentication...";let n=0;for(;!Ue&&n<50;)await new Promise(s=>setTimeout(s,100)),n++}if(!e&&!U.currentUser&&!window.location.pathname.endsWith("login.html")){console.log("[Auth] Not logged in, redirecting to login.html"),window.location.replace("/login.html");return}U.currentUser&&(ln=!0,this.userEmail=U.currentUser.email||(U.currentUser.isAnonymous?"Guest":"Authenticated User")),this.progressMessage="Connecting to database...";try{this.db=await ft()}catch(n){throw console.error("Database initialization failed:",n),new Error(`Local database failed: ${n.message}`)}this.progressMessage="Loading settings...";try{await this._loadInitialState()}catch(n){console.error("Initial state load failed:",n)}const t=this.lastFeedSync===0;if(t&&e&&console.log("[Init] New device detected (no local sync history). Performing full blocking sync."),this._initImageObserver(),"speechSynthesis"in window&&(window.speechSynthesis.getVoices(),window.speechSynthesis.onvoiceschanged=()=>{const n=window.speechSynthesis.getVoices();console.log(`[TTS] Voices loaded: ${n.length} available.`)}),this.isOnline=F(),this.isOnline)if(Ue){if(U.currentUser){this.progressMessage=t?"Restoring profile...":"Syncing user profile...";try{F()&&await oe(),await V(!1,t?[]:["rssFeeds","keywordBlacklist","customCss","shuffleCount","lastShuffleResetDate","animationSpeed","openUrlsInNewTabEnabled","themeStyle","themeStyleLight","themeStyleDark","read","starred"],this)}catch(s){console.error("Profile sync failed:",s)}const n=600*1e3;if(Date.now()-(this.lastFeedSync||0)>n)if(Object.keys(this.feedItems).length>0&&!t)ae(this);else{this.progressMessage=t?"Building your feed...":"Syncing latest content...";try{await ae(this)}catch{console.warn("Initial feed sync failed.")}}}}else{console.log("[Init] Waiting for background auth verification before network sync...");const n=async()=>{let s=0;for(;!Ue&&s<100;)await new Promise(i=>setTimeout(i,100)),s++;if(U.currentUser){console.log("[Init] Auth verified in background, triggering sync."),t&&(this.progressMessage="Restoring account data..."),await oe(),await V(!1,t?[]:["rssFeeds","keywordBlacklist","customCss","shuffleCount","lastShuffleResetDate","animationSpeed","openUrlsInNewTabEnabled","themeStyle","themeStyleLight","themeStyleDark","read","starred"],this);const r=600*1e3;Date.now()-(this.lastFeedSync||0)>r&&(t&&(this.progressMessage="Downloading latest news..."),await ae(this))}};t?await n():n()}if(this.progressMessage="Loading local data...",await this._loadAndManageAllData(),this.progressMessage="Applying user preferences...",ha(this),ga(this),ma(this),ya(this),pa(this),wa(this),Sa(this),Ai(),this.$nextTick(()=>{ba(this)}),this.deck.length===0)this.entries.length>0?this.progressMessage="Fetching and building your feed...":this.progressMessage="No feed items found. Please configure your RSS feeds.",await new Promise(n=>setTimeout(n,1e3));else if(await new Promise(n=>setTimeout(n,500)),!this.selectedGuid){const{value:n}=await S("lastViewedItemId");!(n&&this.deck.some(i=>i.guid===n))&&this.deck.length>0&&this.selectItem(this.deck[0].guid)}this.loading=!1,this._initComplete=!0,(async()=>(console.log("[Init] Starting background initialization tasks..."),this._setupWatchers(),this._setupEventListeners(),this._setupFlickToSelectListeners(),this._startPeriodicSync(),this._startWorkerFeedSync(),this._initScrollObserver(),this._initObservers(),this.pregenerateDecks(),await this.updateSyncStatusMessage(),Ue&&U.currentUser&&(console.log("[Init] Pulling remaining user state in background..."),await V(!1,[],this)),console.log("[Init] Background initialization complete.")))()}catch(e){console.error("Initialization failed:",e),this.errorMessage=`Could not load feed: ${e.message}`,this.progressMessage=`Error: ${e.message}`,this.loading=!1,_(this,`Could not load feed: ${e.message}`)}},performBackgroundSync:async function(){if(!(!this.syncEnabled||!this.isOnline)){console.log("Performing immediate background sync..."),this.progressMessage="Syncing...",this.loading=!0;try{await oe();const e=await ae(this);await V(),await this._loadAndManageAllData(),this.deckManaged=!0,this.progressMessage="",this.loading=!1,console.log("Immediate background sync complete."),e||_(this,"Sync finished with errors.")}catch(e){console.error("Immediate background sync failed:",e),this.progressMessage="Sync Failed!",this.loading=!1,_(this,`Sync failed: ${e.message}`)}}},updateSyncStatusMessage:async function(){F()?this.syncEnabled||_(this,"Sync is disabled."):_(this,"Offline.")},logout:async function(){try{await Li(U)}catch(e){console.error("Logout error:",e),_(this,`Logout failed: ${e.message}`)}},changePassword:function(){U.currentUser&&(this.modalView="change-password")},submitPasswordChange:async function(){const e=U.currentUser;if(!e)return;const t=document.getElementById("new-password-input"),n=t.value;if(!n||n.length<6){alert("Password must be at least 6 characters long.");return}try{await Bi(e,n),_(this,"Password updated successfully!"),t.value="",this.modalView="advanced"}catch(s){console.error("Password update error:",s),s.code==="auth/requires-recent-login"?alert("This operation requires recent authentication. Please log out and log back in, then try again."):_(this,`Failed to update password: ${s.message}`)}},deleteAccount:async function(){const e=U.currentUser;if(!(!e||!confirm(`CRITICAL: This will permanently delete your account and all your saved data from the server. This action CANNOT be undone.

Are you absolutely sure?`)||!confirm("FINAL WARNING: Are you really, really sure you want to delete your account?")))try{await this.resetApplicationData(),await Mi(e),alert("Your account has been successfully deleted."),window.location.href="/login.html"}catch(s){console.error("Account deletion error:",s),s.code==="auth/requires-recent-login"?alert("This operation requires recent authentication. Please log out and log back in, then try again."):_(this,`Failed to delete account: ${s.message}`)}},loadAndDisplayDeck:async function(){let e=this.currentDeckGuids;Array.isArray(e)||(e=[]),console.log(`[loadAndDisplayDeck] Processing ${e.length} GUIDs for display`),console.log(`[loadAndDisplayDeck] feedItems contains ${Object.keys(this.feedItems).length} items`);const t=[],n=new Set(this.read.map(l=>l.guid.toLowerCase())),s=new Set(this.starred.map(l=>l.guid.toLowerCase())),i=new Set,r=[];let a=0;for(const l of e){const c=l.guid;if(typeof c!="string"||!c)continue;const u=this.feedItems[c.toLowerCase()];if(u&&u.guid&&u.description&&u.title&&!i.has(u.guid.toLowerCase())){const d=ht(u,ot);if(d&&d.title){const f=d.guid.toLowerCase();d.isRead=n.has(f),d.isStarred=s.has(f),t.push(d),i.add(f),a++}else r.push(c)}else r.push(c)}if(console.log(`[loadAndDisplayDeck] Found ${a} items locally, ${r.length} items missing.`),r.length>0&&F()){console.log(`[loadAndDisplayDeck] Attempting to fetch ${r.length} missing items from server...`);const{_fetchItemsInBatches:l}=await j(async()=>{const{_fetchItemsInBatches:u}=await Promise.resolve().then(()=>Xo);return{_fetchItemsInBatches:u}},void 0),c=await l(r,this,r.length,a);if(c&&c.length>0){console.log(`[loadAndDisplayDeck] Successfully fetched ${c.length} items from server.`);const{withDb:u}=await j(async()=>{const{withDb:d}=await Promise.resolve().then(()=>qo);return{withDb:d}},void 0);await u(async d=>{const f=d.transaction("feedItems","readwrite");for(const h of c)h.guid&&(await f.store.put(h),this.feedItems[h.guid.toLowerCase()]=h);await f.done});for(const d of c){const f=ht(d,ot);if(f&&!i.has(f.guid.toLowerCase())){const h=f.guid.toLowerCase();f.isRead=n.has(h),f.isStarred=s.has(h),t.push(f),i.add(h),a++}}}}this.deck=Array.isArray(t)?t:[],console.log(`[loadAndDisplayDeck] Final deck size: ${this.deck.length}`)},loadFeedItemsFromDB:async function(){if(!this.db){this.entries=[],this.feedItems={};return}const e=await di();this.feedItems={};const t=[],n=new Set;e.forEach(s=>{s&&s.guid&&!n.has(s.guid.toLowerCase())&&(this.feedItems[s.guid.toLowerCase()]=s,t.push(s),n.add(s.guid.toLowerCase()))}),this.entries=gi(t,ot)||[]},get filteredEntries(){Array.isArray(this.deck)||(this.deck=[]);const e=this.deck.length>0?this.deck[0].guid.substring(0,8):"empty",t=`${this.entries.length}-${this.filterMode}-${this.read.length}-${this.starred.length}-${this.imagesEnabled}-${this.currentDeckGuids.length}-${this.deck.length}-${this.keywordBlacklistInput}-${this.searchQuery}-${e}`;if(this.entries.length>0&&t===this._lastFilterHash&&this._cachedFilteredEntries!==null)return this._cachedFilteredEntries;let n=[];const s=new Map(this.read.map(a=>[a.guid.toLowerCase(),a.readAt])),i=new Map(this.starred.map(a=>[a.guid.toLowerCase(),a.starredAt]));switch(this.filterMode){case"unread":n=this.deck.filter(a=>!s.has(a.guid.toLowerCase()));break;case"all":n=this.entries;break;case"read":n=this.entries.filter(a=>s.has(a.guid.toLowerCase())).sort((a,l)=>new Date(s.get(l.guid.toLowerCase())||0).getTime()-new Date(s.get(a.guid.toLowerCase())||0).getTime());break;case"starred":n=this.entries.filter(a=>i.has(a.guid.toLowerCase())).sort((a,l)=>new Date(i.get(l.guid.toLowerCase())||0).getTime()-new Date(i.get(a.guid.toLowerCase())||0).getTime());break}n=n.map(a=>{const l=a.guid.toLowerCase();return{...a,isRead:s.has(l),isStarred:i.has(l)}});const r=(this.keywordBlacklistInput??"").split(/\r?\n/).map(a=>a.trim().toLowerCase()).filter(a=>a.length>0);return r.length>0&&(n=n.filter(a=>{const l=`${a.title} ${a.description} ${a.guid}`.toLowerCase();return!r.some(c=>l.includes(c))})),n=Ca(n,this.searchQuery),this._cachedFilteredEntries=n,this._lastFilterHash=t,n},get allCount(){return this.entries.length},get starredCount(){if(!this.entries.length)return 0;const e=new Set(this.starred.map(t=>(typeof t=="string"?t:t.guid).toLowerCase()));return this.entries.filter(t=>e.has(t.guid.toLowerCase())).length},get readCount(){if(!this.entries.length)return 0;const e=new Set(this.read.map(t=>(typeof t=="string"?t:t.guid).toLowerCase()));return this.entries.filter(t=>e.has(t.guid.toLowerCase())).length},get unreadCount(){if(!this.entries.length||!this.currentDeckGuids.length)return 0;const e=new Set(this.read.map(i=>(typeof i=="string"?i:i.guid).toLowerCase())),t=new Set(this.shuffledOutGuids.map(i=>(typeof i=="string"?i:i.guid).toLowerCase())),n=new Set(this.currentDeckGuids.map(i=>(typeof i=="string"?i:i.guid).toLowerCase())),s=(this.keywordBlacklistInput??"").split(/\r?\n/).map(i=>i.trim().toLowerCase()).filter(i=>i.length>0);return this.entries.filter(i=>{const r=i.guid.toLowerCase();if(!(n.has(r)&&!e.has(r)&&!t.has(r)))return!1;if(s.length>0){const l=`${i.title} ${i.description} ${i.guid}`.toLowerCase();if(s.some(c=>l.includes(c)))return!1}return!0}).length},get isSettingsDirty(){return this.rssFeedsInput!==this._initialRssFeedsInput||this.keywordBlacklistInput!==this._initialKeywordBlacklistInput},isStarred:function(e){if(!e)return!1;const t=e.toLowerCase();return this.starred.some(n=>(typeof n=="string"?n:n.guid).toLowerCase()===t)},isRead:function(e){if(!e)return!1;const t=e.toLowerCase();return this.read.some(n=>(typeof n=="string"?n:n.guid).toLowerCase()===t)},toggleStar:async function(e){const t=!this.starred.some(n=>n.guid===e);if(t){this.starredGuid=e;const n=667*(100/(this.animationSpeed||100));setTimeout(()=>{this.starredGuid===e&&(this.starredGuid=null)},n)}this.deck=this.deck.map(n=>n.guid===e?{...n,isStarred:t}:n),this.entries=this.entries.map(n=>n.guid===e?{...n,isStarred:t}:n),await nn(this,e,"starred")},speakItem:function(e){Ia(this,e)},toggleRead:async function(e){this.speakingGuid===e&&on(this);const t=this.isRead(e),n=this.selectedGuid===e;let s=null;if(!t&&n&&this.filterMode==="unread"){const a=this.filteredEntries,l=a.findIndex(c=>c.guid===e);l!==-1&&(l<a.length-1?s=a[l+1].guid:l>0&&(s=a[l-1].guid))}if(!t){this.readingGuid=e;const a=100/(this.animationSpeed||100);this.filterMode==="unread"?(this.closingGuid=e,await new Promise(l=>setTimeout(l,333*a)),s&&this.selectItem(s),await new Promise(l=>setTimeout(l,300*a))):await new Promise(l=>setTimeout(l,333*a)),this.readingGuid=null,this.closingGuid=null}let i=null;if(this.deck=this.deck.map(a=>a.guid===e?{...a,isRead:!t}:a),this.entries=this.entries.map(a=>a.guid===e?{...a,isRead:!t}:a),await nn(this,e,"read"),t||(this.nextSwipeDirection=this.nextSwipeDirection==="left"?"right":"left"),this.filterMode==="unread"&&!t){i=this.currentDeckGuids.findIndex(l=>l.guid===e),i===-1&&(i=null),this.deck=this.deck.filter(l=>l.guid!==e),this.currentDeckGuids=this.currentDeckGuids.filter(l=>l.guid!==e);const{saveCurrentDeck:a}=await j(async()=>{const{saveCurrentDeck:l}=await Promise.resolve().then(()=>sn);return{saveCurrentDeck:l}},void 0);await a(this.currentDeckGuids),!s&&n&&(this.selectedGuid=null)}else if(this.filterMode==="unread"&&t&&!this.currentDeckGuids.some(a=>a.guid===e)){const a={guid:e,addedAt:new Date().toISOString()};this.undoItemIndex!==null&&this.undoItemIndex>=0?this.currentDeckGuids.splice(this.undoItemIndex,0,a):this.currentDeckGuids.push(a);const{saveCurrentDeck:l}=await j(async()=>{const{saveCurrentDeck:c}=await Promise.resolve().then(()=>sn);return{saveCurrentDeck:c}},void 0);await l(this.currentDeckGuids)}this.updateCounts(),await this._reconcileAndRefreshUI(),this.updateSyncStatusMessage(),!t&&this.filterMode!=="all"&&vi(this,e,i);let r=this.deck.filter(a=>!this.isRead(a.guid)).length;if(this.filterMode==="unread"&&r===0){for(console.log("[toggleRead] Last item read. Preloading next deck during undo period..."),this.pregenerateDecks(),this.loadFeedItemsFromDB();this.showUndo;)await new Promise(a=>setTimeout(a,100));if(this.undoStack=[],r=this.deck.filter(a=>!this.isRead(a.guid)).length,r>0){console.log("[toggleRead] Undo detected, skipping refresh.");return}}if(this.filterMode==="unread"&&r<3){console.log(`[toggleRead] Deck running low (${r} unread), initiating refresh.`);const a=this.isOnline?"pregeneratedOnlineDeck":"pregeneratedOfflineDeck",l=!!this[a];r===0&&!l&&(this.progressMessage="Generating new deck...",this.loading=!0);try{await this._loadAndManageAllData(),r===0&&this.deck.length>0&&this.selectItem(this.deck[0].guid)}catch(c){console.error("[toggleRead] Error during deck refresh:",c)}finally{this.loading=!1,this.progressMessage=""}}},toggleItemMenu:function(e){this.activeMenuGuid===e?this.activeMenuGuid=null:this.activeMenuGuid=e},shareItem:function(e){const t=this.entries.find(n=>n.guid===e);t&&(console.log(`[Share] Sharing item: ${t.title}`),_(this,"Sharing feature coming soon!"),this.activeMenuGuid=null)},undoMarkRead:async function(){if(this.undoStack.length===0){this.showUndo=!1;return}const e=this.undoStack.pop();if(!e)return;const t=e.guid;this.undoItemGuid=t,this.undoItemIndex=e.index,this.undoStack.length===0&&(this.showUndo=!1),await this.toggleRead(t),this.undoItemGuid=null,this.undoItemIndex=null},selectItem:function(e){if(this.selectedGuid===e){this.openShortcuts&&(this.openShortcuts=!1);return}this.selectedGuid=e,this.openShortcuts&&(this.openShortcuts=!1),j(()=>Promise.resolve().then(()=>Da),void 0).then(t=>{t.scrollSelectedIntoView(e,this)})},processShuffle:async function(){await _a(this),this.updateCounts()},loadRssFeeds:async function(){try{const e=await S("rssFeeds");this.rssFeedsInput=je(e.value).join(`
`),console.log(`[DEBUG] Content for rssFeeds input: ${this.rssFeedsInput}`)}catch(e){console.error("Error loading RSS feeds:",e)}},loadKeywordBlacklist:async function(){const{value:e}=await S("keywordBlacklist");this.keywordBlacklistInput=Array.isArray(e)?e.join(`
`):"",console.log(`[DEBUG] Content for keywordBlacklist input: ${this.keywordBlacklistInput}`)},loadCustomCss:async function(){const{value:e}=await S("customCss");this.customCss=typeof e=="string"&&e.trim()!==""?e:this.generateCustomCssTemplate(),this.applyCustomCss()},saveRssFeeds:async function(){const t=this.rssFeedsInput.split(/\r?\n/).map(l=>{const c=l.trim();return c.length===0||c.startsWith("#")?l:!c.includes("://")&&c.includes(".")?`https://${c}`:l}),n=t.map(l=>l.trim()),{value:s}=await S("rssFeeds"),i=je(s);if(i.length===n.filter(l=>l&&!l.startsWith("#")).length&&n.filter(l=>l&&!l.startsWith("#")).every(l=>i.includes(l))){console.log("[saveRssFeeds] No changes detected, skipping save and sync."),_(this,"No changes to feeds.");return}const a=[];if(n.forEach(l=>{const c=l.trim();if(c.length>0&&!c.startsWith("#"))try{const u=new URL(c);u.protocol!=="http:"&&u.protocol!=="https:"&&a.push(l)}catch{a.push(l)}}),!(a.length>0&&!confirm(`The following URLs appear to be invalid:

${a.slice(0,5).join(`
`)}${a.length>5?`
...and more`:""}

Invalid URLs will be saved but ignored by the sync process. Proceed anyway?`)))try{await A("rssFeeds",n),this.rssFeedsInput=t.join(`
`),this._initialRssFeedsInput=this.rssFeedsInput,_(this,"RSS Feeds saved!"),this.loading=!0,this.progressMessage="Saving feeds and performing full sync...";const l=await Q();l&&await fetch(`${Ge}/api/refresh`,{method:"POST",headers:{Authorization:`Bearer ${l}`}}).catch(d=>console.error("[Worker Sync] Immediate sync failed:",d));const c=await Tn(this);await this.loadFeedItemsFromDB();const u=await at(Array.from(this.entries),this.read,this.starred,this.shuffledOutGuids,this.shuffleCount,this.filterMode,this.lastShuffleResetDate);this.deck=u.deck,this.currentDeckGuids=u.currentDeckGuids,this.shuffledOutGuids=u.shuffledOutGuids,this.shuffleCount=u.shuffleCount,this.lastShuffleResetDate=u.lastShuffleResetDate,await this.loadAndDisplayDeck(),this.deck.length>0&&this.selectItem(this.deck[0].guid),this.progressMessage="",this.loading=!1,c||_(this,"Feeds saved, but sync finished with errors.")}catch(l){console.error("Error saving RSS feeds:",l),_(this,`Failed to save RSS feeds: ${l.message}`),this.loading=!1}},saveKeywordBlacklist:async function(){const e=this.keywordBlacklistInput.split(/\r?\n/).map(i=>i.trim()).filter(Boolean).sort(),{value:t}=await S("keywordBlacklist"),n=Array.isArray(t)?[...t].sort():[];if(n.length===e.length&&e.every((i,r)=>i===n[r])){console.log("[saveKeywordBlacklist] No changes detected, skipping save."),_(this,"No changes to blacklist.");return}try{await A("keywordBlacklist",e),this.keywordBlacklistInput=e.join(`
`),this._initialKeywordBlacklistInput=this.keywordBlacklistInput,_(this,"Keyword Blacklist saved!"),this.updateCounts()}catch(i){console.error("Error saving keyword blacklist:",i),_(this,`Failed to save keyword blacklist: ${i.message}`)}},saveCustomCss:async function(){try{await A("customCss",this.customCss),this.applyCustomCss(),_(this,"Custom CSS saved!")}catch(e){console.error("Error saving custom CSS:",e),_(this,`Failed to save custom CSS: ${e.message}`)}},resetCustomCss:async function(){confirm("Reset Custom CSS to default template? This will overwrite your current customizations.")&&(this.customCss=this.generateCustomCssTemplate(),await this.saveCustomCss(),_(this,"Custom CSS reset to template!"))},generateCustomCssTemplate:function(){const e=getComputedStyle(document.documentElement),t=["--bg","--fg","--primary","--secondary","--card-bg","--card-border","--card-shadow-color","--fg-muted","--border-radius"];let n=`/* Custom CSS Template - Current theme: ${this.theme} ${this.themeStyle} */
:root {
`;return t.forEach(s=>{const i=e.getPropertyValue(s).trim();i&&(n+=`  ${s}: ${i};
`)}),n+=`}

/* Add custom styles below */
`,n},applyCustomCss:function(){let e=document.getElementById("custom-user-css");e||(e=document.createElement("style"),e.id="custom-user-css",document.head.appendChild(e)),e.textContent=this.customCss},loadThemeStyle:async function(){const[,e,t]=await Promise.all([S("themeStyle"),S("themeStyleLight"),S("themeStyleDark")]);this.themeStyleLight=typeof e.value=="string"?e.value:"originalLight",this.themeStyleDark=typeof t.value=="string"?t.value:"originalDark",this.theme==="light"?this.themeStyle=this.themeStyleLight:this.themeStyle=this.themeStyleDark,this.applyThemeStyle()},updateThemeAndStyle:async function(e,t){console.log(`Updating theme to ${t} and style to ${e}`),this.theme=t,this.themeStyle=e;const n=document.documentElement;n.classList.remove("light","dark"),n.classList.add(t),localStorage.setItem("theme",t),await A("theme",t),t==="light"?(this.themeStyleLight=e,await A("themeStyleLight",e)):(this.themeStyleDark=e,await A("themeStyleDark",e)),await A("themeStyle",e),this.applyThemeStyle(),_(this,`Theme set to ${t} (${e}).`)},saveThemeStyle:async function(){this.theme==="light"?(this.themeStyleLight=this.themeStyle,await A("themeStyleLight",this.themeStyleLight)):(this.themeStyleDark=this.themeStyle,await A("themeStyleDark",this.themeStyleDark)),await A("themeStyle",this.themeStyle),this.applyThemeStyle()},applyThemeStyle:function(){const e=document.documentElement;e.classList.remove("light","dark"),e.classList.add(this.theme);const t=Array.from(e.classList).filter(n=>n.startsWith("theme-"));e.classList.remove(...t),this.themeStyle!=="originalLight"&&this.themeStyle!=="originalDark"&&e.classList.add(`theme-${this.themeStyle}`)},loadFontSize:async function(){const{value:e}=await S("fontSize");this.fontSize=typeof e=="number"?e:100,this.applyFontSize()},saveFontSize:async function(){await A("fontSize",this.fontSize),this.applyFontSize()},applyFontSize:function(){document.documentElement.style.setProperty("--font-scale",(this.fontSize/100).toString())},loadFeedWidth:async function(){const{value:e}=await S("feedWidth");this.feedWidth=typeof e=="number"?e:50,this.applyFeedWidth()},saveFeedWidth:async function(){await A("feedWidth",this.feedWidth),this.applyFeedWidth()},applyFeedWidth:function(){document.documentElement.style.setProperty("--feed-width",`${this.feedWidth}%`)},saveFonts:async function(){await Promise.all([A("fontTitle",this.fontTitle),A("fontBody",this.fontBody)]),this.applyFonts()},applyFonts:function(){document.documentElement.style.setProperty("--font-title",this.fontTitle),document.documentElement.style.setProperty("--font-body",this.fontBody)},loadAnimationSpeed:async function(){const{value:e}=await S("animationSpeed");this.animationSpeed=typeof e=="number"?e:100,this.applyAnimationSpeed()},saveAnimationSpeed:async function(){await A("animationSpeed",this.animationSpeed),this.applyAnimationSpeed()},applyAnimationSpeed:function(){const e=100/(this.animationSpeed||100);document.documentElement.style.setProperty("--animation-duration-factor",e.toString())},updateCounts:function(){Di(this)},scrollToTop:function(){$n()},observeImage:function(e){this.imageObserver&&this.imageObserver.observe(e)},_initImageObserver:function(){this.imageObserver=new IntersectionObserver(e=>{e.forEach(t=>{if(t.isIntersecting){const n=t.target;n.dataset.src&&(n.src=n.dataset.src,this.imageObserver?.unobserve(n))}})},{root:null,rootMargin:"50% 0px",threshold:.01})},resetApplicationData:async function(){console.log("resetApplicationData called.");const e=confirm("Are you sure you want to reset the application? This will clear all local data, cache, and unregister the service worker.");if(console.log("User confirmed reset:",e),!e){console.log("Reset cancelled by user.");return}this.openSettings=!1,this.loading=!0,this.progressMessage="Resetting application data...";try{if(console.log("Closing database connection..."),await ci(),console.log("Unregistering service workers..."),"serviceWorker"in navigator){const s=await navigator.serviceWorker.getRegistrations();for(const i of s)await i.unregister(),console.log("Service Worker unregistered:",i.scope)}console.log("Service workers unregistered."),console.log("Clearing feed and progress IndexedDB object stores...");try{const s=await ft(),i=["read","starred","currentDeckGuids","shuffledOutGuids","feedItems","pendingOperations"],r=s.transaction([...i,"userSettings"],"readwrite");await Promise.all(i.map(l=>(console.log(`Clearing object store: ${l}`),r.objectStore(l).clear()))),console.log("Clearing sync metadata from userSettings...");const a=r.objectStore("userSettings");await Promise.all([a.delete("lastFeedSync"),a.delete("lastStateSync")]),await r.done,console.log("Specific IndexedDB object stores and sync metadata cleared.")}catch(s){console.error("Error clearing IndexedDB stores:",s)}console.log("localStorage is preserved."),console.log("DEBUG: About to make fetch call to /api/admin/wipe");const t=await Q(),n=await fetch(`${Ge}/api/admin/wipe`,{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:`Bearer ${t}`}:{}}});if(!n.ok){let s="Failed to reset backend data.";try{const i=await n.json();s=i.message||i.error||s}catch{const r=await n.text();s=`Server error (${n.status}): ${r.substring(0,100)}`}throw new Error(s)}console.log("Backend application data reset successfully."),_(this,"Application reset complete! Reloading..."),await V(!0),setTimeout(()=>{window.location.reload()},1e3)}catch(t){console.error("Error during application reset:",t),this.errorMessage=`Failed to reset application: ${t.message}`,_(this,`Failed to reset application: ${t.message}`),this.loading=!1}},backupConfig:async function(){console.log("backupConfig called."),this.showUndo=!1,_(this,"Generating backup file...");try{this.progressMessage="Fetching configuration for backup...";const e=await Q(),t=await fetch(`${Ge}/api/admin/archive-export`,{method:"GET",headers:{...e?{Authorization:`Bearer ${e}`}:{}}});if(!t.ok){let c="Failed to fetch config for backup.";try{const u=await t.json();c=u.message||u.error||c}catch{const d=await t.text();c=`Server error (${t.status}): ${d.substring(0,100)}`}throw new Error(c)}const n=await t.json(),s={feeds:["rssFeeds","keywordBlacklist"],appearance:["theme","themeStyle","themeStyleLight","themeStyleDark","fontSize","feedWidth","animationSpeed","customCss","shadowsEnabled","curvesEnabled","imagesEnabled"],history:["read","starred","hidden"],settings:["syncEnabled","openUrlsInNewTabEnabled","itemButtonMode","flickToSelectEnabled","filterMode","lastViewedItemId","lastViewedItemOffset","searchQuery","showSearchBar"]},i={};for(const[c,u]of Object.entries(this.backupSelections))u&&s[c].forEach(f=>{n[f]!==void 0&&(i[f]=n[f])});if(Object.keys(i).length===0){_(this,"No data selected for backup.");return}const r=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),a=URL.createObjectURL(r),l=document.createElement("a");l.href=a,l.download=`not-the-news-config-backup-${new Date().toISOString().replace(/:/g,"-").split(".")[0]}.json`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(o),_(this,"Backup ready for download!"),console.log("Configuration backed up successfully!")}catch{console.error("Error during config backup:",error),_(this,`Failed to backup configuration: ${error.message}`)}finally{this.progressMessage=""}},restoreConfig:async function(e){const t=e.target.files?.[0];if(t)try{const n=await new Promise((a,l)=>{const c=new FileReader;c.onload=u=>a(u.target?.result),c.onerror=u=>l(u),c.readAsText(t)});this.restoreData=JSON.parse(n);const s=["rssFeeds","theme","read","starred","keywordBlacklist","fontSize"];if(!Object.keys(this.restoreData).some(a=>s.includes(a))){_(this,"The selected file does not appear to be a valid Not The News backup."),this.restoreData=null,this.modalView="advanced";return}this.showRestorePreview=!0,this.modalView="restore";const r={feeds:["rssFeeds","keywordBlacklist"],appearance:["theme","themeStyle","themeStyleLight","themeStyleDark","fontSize","feedWidth","animationSpeed","customCss","shadowsEnabled","curvesEnabled","imagesEnabled"],history:["read","starred","hidden"],settings:["syncEnabled","openUrlsInNewTabEnabled","itemButtonMode","flickToSelectEnabled","filterMode","lastViewedItemId","lastViewedItemOffset","searchQuery","showSearchBar"]};for(const[a,l]of Object.entries(r))this.backupSelections[a]=l.some(c=>this.restoreData[c]!==void 0)}catch(n){console.error("Error parsing restoration file:",n),_(this,`Invalid backup file: ${n.message}`)}finally{e.target.value=""}},confirmRestore:async function(){if(this.restoreData&&confirm("This will overwrite selected settings and reload the application. Proceed?")){this.openSettings=!1,this.loading=!0,this.progressMessage="Restoring configuration...";try{const e={feeds:["rssFeeds","keywordBlacklist"],appearance:["theme","themeStyle","themeStyleLight","themeStyleDark","fontSize","feedWidth","animationSpeed","customCss","shadowsEnabled","curvesEnabled","imagesEnabled"],history:["read","starred","hidden"],settings:["syncEnabled","openUrlsInNewTabEnabled","itemButtonMode","flickToSelectEnabled","filterMode","lastViewedItemId","lastViewedItemOffset","searchQuery","showSearchBar"]},t={};for(const[i,r]of Object.entries(this.backupSelections))r&&e[i].forEach(l=>{if(this.restoreData[l]!==void 0){let c=this.restoreData[l];l==="themeStyle"&&c==="original"&&(c=this.restoreData.theme==="light"?"originalLight":"originalDark"),l==="themeStyleLight"&&c==="original"&&(c="originalLight"),l==="themeStyleDark"&&c==="original"&&(c="originalDark"),t[l]=c}});if(t.syncEnabled=!0,Object.keys(t).length===0){_(this,"No data selected for restoration."),this.loading=!1;return}const n=await Q(),s=await fetch(`${Ge}/api/admin/archive-import`,{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:`Bearer ${n}`}:{}},body:JSON.stringify(t)});if(!s.ok){let i="Failed to restore backend data.";try{const r=await s.json();i=r.error||r.message||i}catch{const a=await s.text();i=`Server error (${s.status}): ${a.substring(0,100)}`}throw new Error(i)}_(this,"Restoration complete! Reloading..."),await V(!0),setTimeout(()=>window.location.reload(),1e3)}catch(e){console.error("Error during restoration:",e),_(this,`Restoration failed: ${e.message}`),this.loading=!1}}},_loadInitialState:async function(){try{const[e,t,n,s,i,r,a,l,c,u,d,f]=await Promise.all([S("syncEnabled"),S("imagesEnabled"),S("itemButtonMode"),S("openUrlsInNewTabEnabled"),_i(),S("theme"),S("curvesEnabled"),S("flickToSelectEnabled"),S("animationSpeed"),S("lastFeedSync"),S("fontTitle"),S("fontBody")]);this.syncEnabled=e.value??!0,this.imagesEnabled=t.value??!0,this.itemButtonMode=n.value??"play",this.openUrlsInNewTabEnabled=s.value??!0,this.curvesEnabled=a.value??!0,this.flickToSelectEnabled=l.value??!1,this.animationSpeed=c.value??100,this.lastFeedSync=u.value??0,this.fontTitle=d.value??"'Playfair Display', serif",this.fontBody=f.value??"inherit",this.filterMode=i;const h=r.value==="light"||r.value==="dark"?r.value:"dark";this.theme!==h&&(this.theme=h,localStorage.setItem("theme",this.theme)),this.isOnline=F();const[p,O,$,m]=await Promise.all([S("rssFeeds"),S("keywordBlacklist"),S("themeStyleLight"),S("themeStyleDark")]),y=typeof $.value=="string"?$.value:"originalLight",b=typeof m.value=="string"?m.value:"originalDark";this.themeStyleLight=y==="original"?"originalLight":y,this.themeStyleDark=b==="original"?"originalDark":b,localStorage.setItem("themeStyleLight",this.themeStyleLight),localStorage.setItem("themeStyleDark",this.themeStyleDark);const v=this.theme==="light"?this.themeStyleLight:this.themeStyleDark;this.themeStyle!==v&&(this.themeStyle=v,this.applyThemeStyle()),this.rssFeedsInput=je(p.value).join(`
`),this.keywordBlacklistInput=Array.isArray(O.value)?O.value.join(`
`):"",await this.loadCustomCss(),await this.loadFontSize(),await this.loadFeedWidth(),this.applyAnimationSpeed(),this.applyThemeStyle(),this.applyFonts(),this._initialRssFeedsInput=this.rssFeedsInput,this._initialKeywordBlacklistInput=this.keywordBlacklistInput;const[E,L]=await Promise.all([S("pregeneratedOnlineDeck"),S("pregeneratedOfflineDeck")]);this.pregeneratedOnlineDeck=E.value,this.pregeneratedOfflineDeck=L.value}catch(e){console.error("Error loading initial state:",e),this.syncEnabled=!0,this.imagesEnabled=!0,this.openUrlsInNewTabEnabled=!0,this.filterMode="unread",this.theme="dark",this.rssFeedsInput="",this.keywordBlacklistInput=""}},_loadAndManageAllData:async function(e){console.log("_loadAndManageAllData: START"),this.progressMessage="Loading saved feed items...",await this.loadFeedItemsFromDB(),console.log(`_loadAndManageAllData: After loadFeedItemsFromDB. Entries: ${this.entries.length}`),this.progressMessage="Loading user state from storage...";const[t,n,s,i,r,a]=await Promise.all([be("starred"),be("shuffledOutGuids"),pi(),Si(),S("rssFeeds"),S("keywordBlacklist")]);console.log("_loadAndManageAllData: Loaded starred state:",t.value),this.starred=Array.isArray(t.value)?t.value:[],this.shuffledOutGuids=Array.isArray(n.value)?n.value:[],this.currentDeckGuids=Array.isArray(s)?s:[],console.log("_loadAndManageAllData: Loaded currentDeckGuids:",this.currentDeckGuids.slice(0,3),typeof this.currentDeckGuids[0]),this.shuffleCount=i.shuffleCount,this.lastShuffleResetDate=i.lastShuffleResetDate;const{parseRssFeedsConfig:l}=await j(async()=>{const{parseRssFeedsConfig:h}=await Promise.resolve().then(()=>Yn);return{parseRssFeedsConfig:h}},void 0);this.rssFeedsInput=l(r.value).join(`
`),this.keywordBlacklistInput=Array.isArray(a.value)?a.value.join(`
`):"",this._initialRssFeedsInput=this.rssFeedsInput,this._initialKeywordBlacklistInput=this.keywordBlacklistInput,this.progressMessage="Optimizing local storage...",this.read=await yi(Object.values(this.feedItems)),console.log(`_loadAndManageAllData: After loadAndPruneReadItems. Read count: ${this.read.length}`),console.log("[deckManager] Starting deck management with all data loaded."),this.progressMessage="Organizing your deck...",console.log("_loadAndManageAllData: Before manageDailyDeck",{readCount:this.read.length,currentDeckGuidsCount:this.currentDeckGuids.length,shuffleCount:this.shuffleCount});const c=this.isOnline,u=c?"pregeneratedOnlineDeck":"pregeneratedOfflineDeck",d=this[u],f=await at(Array.from(this.entries),this.read,this.starred,this.shuffledOutGuids,this.shuffleCount,this.filterMode,this.lastShuffleResetDate,d);this.deck=f.deck,this.currentDeckGuids=f.currentDeckGuids,this.shuffledOutGuids=f.shuffledOutGuids,this.shuffleCount=f.shuffleCount,this.lastShuffleResetDate=f.lastShuffleResetDate,d&&d.length>0&&this.currentDeckGuids.length>0&&this.currentDeckGuids[0].guid===d[0].guid&&(console.log(`[deckManager] Consumed pre-generated ${c?"ONLINE":"OFFLINE"} deck in _loadAndManageAllData.`),u==="pregeneratedOnlineDeck"?this.pregeneratedOnlineDeck=null:this.pregeneratedOfflineDeck=null,await A(u,null),this.pregenerateDecks()),console.log("_loadAndManageAllData: After manageDailyDeck. Deck size:",this.deck.length),this.progressMessage="Displaying your feed...",await this.loadAndDisplayDeck(),console.log("_loadAndManageAllData: After loadAndDisplayDeck. Final Deck size:",this.deck.length),this.updateAllUI(),this._initComplete&&this.deck.length>0&&!this.showUndo&&(console.log("[_loadAndManageAllData] Auto-selecting first item after refresh."),this.selectItem(this.deck[0].guid)),console.log("_loadAndManageAllData: END")},updateAllUI:function(){this.updateCounts()},_reconcileAndRefreshUI:async function(){console.log("[UI] _reconcileAndRefreshUI: Initiating UI reconciliation and refresh."),await this.loadAndDisplayDeck(),this.updateAllUI(),console.log("[UI] _reconcileAndRefreshUI: Completed UI reconciliation and refresh.")},_initObservers:function(){this.staleItemObserver=new IntersectionObserver(e=>{e.forEach(t=>{if(!t.isIntersecting){const n=t.target.dataset.guid;console.log(`[Observer] Stale item ${n} is off-screen. Removing.`),this.deck=this.deck.filter(s=>s.guid!==n),this.staleItemObserver?.unobserve(t.target)}})},{root:null,threshold:0})},_setupWatchers:function(){this.$watch("openShortcuts",async e=>{const t=window.innerWidth<1024;e?(t||document.body.classList.add("no-scroll"),await ve()):(document.body.classList.remove("no-scroll"),document.body.style.overflow="")}),this.$watch("openSettings",async e=>{const t=window.innerWidth<1024;if(e){window.location.hash!=="#settings"&&window.history.pushState({modal:"settings"},"","#settings"),this.showUndo=!1,this.backupSelections={feeds:!0,appearance:!0,history:!0,settings:!0},this.showRestorePreview=!1,this.restoreData=null,t||document.body.classList.add("no-scroll"),this.modalView="main",await rn(this),this.$nextTick(()=>{document.querySelector(".modal-content")?.querySelector("button, select, input, textarea")?.focus()});const[n,s]=await Promise.all([S("rssFeeds"),S("keywordBlacklist")]);this.rssFeedsInput=je(n.value).join(`
`),Array.isArray(s.value)?this.keywordBlacklistInput=s.value.filter(Boolean).sort().join(`
`):typeof s.value=="string"?this.keywordBlacklistInput=s.value.split(/\r?\n/).filter(Boolean).sort().join(`
`):this.keywordBlacklistInput="",await ve()}else window.location.hash==="#settings"&&window.history.back(),document.body.classList.remove("no-scroll"),document.body.style.overflow="",await ve()}),this.$watch("fullscreenImage",e=>{e?window.location.hash!=="#image"&&window.history.pushState({modal:"image"},"","#image"):window.location.hash==="#image"&&window.history.back()}),window.addEventListener("popstate",e=>{this.openSettings&&window.location.hash!=="#settings"&&(this.openSettings=!1),this.openShortcuts&&window.location.hash!=="#shortcuts"&&(this.openShortcuts=!1),this.fullscreenImage&&window.location.hash!=="#image"&&(this.fullscreenImage=null)}),this.$watch("openShortcuts",async e=>{const t=window.innerWidth<1024;e?(window.location.hash!=="#shortcuts"&&window.history.pushState({modal:"shortcuts"},"","#shortcuts"),t||document.body.classList.add("no-scroll"),await ve()):(window.location.hash==="#shortcuts"&&window.history.back(),document.body.classList.remove("no-scroll"),document.body.style.overflow="")}),this.$watch("openUrlsInNewTabEnabled",()=>{document.querySelectorAll(".itemdescription").forEach(e=>this.handleEntryLinks(e))}),this.$watch("modalView",async()=>{await rn(this),this.$nextTick(()=>{document.querySelector(".modal-content")?.querySelector('div[style*="display: block"] button, div[style*="display: block"] select, div[style*="display: block"] input, div[style*="display: block"] textarea')?.focus()})}),this.$watch("filterMode",async e=>{if(await bi(this,e),e==="unread"){const t=await at(Array.from(this.entries),this.read,this.starred,this.shuffledOutGuids,this.shuffleCount,this.filterMode,this.lastShuffleResetDate);this.deck=t.deck,this.currentDeckGuids=t.currentDeckGuids,this.shuffleCount=t.shuffleCount,this.lastShuffleResetDate=t.lastShuffleResetDate}this.scrollToTop()}),this.$watch("shadowsEnabled",e=>{document.body.classList.toggle("no-shadows",!e)}),document.body.classList.toggle("no-shadows",!this.shadowsEnabled),this.$watch("curvesEnabled",e=>{document.body.classList.toggle("no-curves",!e),e?this.undoBtnRadius=20:this.undoBtnRadius=0}),document.body.classList.toggle("no-curves",!this.curvesEnabled),this.curvesEnabled||(this.undoBtnRadius=0),this.$watch("entries",()=>this.updateCounts()),this.$watch("read",()=>this.updateCounts()),this.$watch("starred",()=>this.updateCounts()),this.$watch("currentDeckGuids",()=>this.updateCounts()),this.$watch("selectedGuid",e=>{e?(this.lastSelectedGuid=e,this.selectedTimestamp=Date.now(),this.selectedSubElement="item"):(this.selectedTimestamp=null,this.selectedSubElement="item")}),this.$watch("isOnline",e=>{document.documentElement.style.setProperty("--offline-padding",e?"0":"30px")}),this.$watch("fontTitle",()=>this.applyFonts()),this.$watch("fontBody",()=>this.applyFonts()),document.documentElement.style.setProperty("--offline-padding",this.isOnline?"0":"30px")},_setupEventListeners:function(){const e=async()=>{if(!this.syncEnabled||!this.isOnline)return;console.log("Performing periodic background sync..."),await oe();const n=await ae(this);await V(),await this._loadAndManageAllData(),this.deckManaged=!0,console.log(`Background sync complete. Success: ${n}`)};window.addEventListener("online",async()=>{if(this.isOnline=!0,await this.updateSyncStatusMessage(),this.syncEnabled)try{await oe(),await e()}catch(n){console.error("Error handling online event:",n)}}),window.addEventListener("offline",async()=>{this.isOnline=!1,await this.updateSyncStatusMessage()});let t;window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{ve()},1e3)},{passive:!0}),window.addEventListener("keydown",n=>{Ii(n,this)}),window.addEventListener("visibilitychange",()=>{if(document.visibilityState==="visible"){const n=F();if(this.isOnline!==n&&(console.log(`[Connectivity] Visibility change detected. Updating status: ${n?"ONLINE":"OFFLINE"}`),this.isOnline=n,this.updateSyncStatusMessage()),this.selectedGuid){console.log("[Visibility] App returned to foreground. Redrawing selection animation.");const s=this.selectedGuid;this.selectedGuid=null,this.$nextTick(()=>{this.selectedGuid=s})}}}),setInterval(()=>{const n=F();this.isOnline!==n&&(console.log(`[Connectivity] Heartbeat status change: ${n?"ONLINE":"OFFLINE"}`),this.isOnline=n,this.updateSyncStatusMessage())},3e4)},_setupFlickToSelectListeners:function(){let e=0;const t=800,n=.5,s=50,i=100,r=u=>{const d=this.filteredEntries;if(d.length===0)return null;let h=(this.selectedGuid?d.findIndex(p=>p.guid===this.selectedGuid):-1)+u;return h<0&&(h=0),h>=d.length&&(h=d.length-1),d[h].guid},a=u=>{const d=Date.now();if(d-e<t)return;const f=r(u);!f||f===this.selectedGuid||(console.log(`[Flick] Triggering selection move: direction=${u}`),e=d,window.scrollTo(window.scrollX,window.scrollY),this.selectItem(f))};window.addEventListener("wheel",u=>{!this.flickToSelectEnabled||this.openSettings||this.showSearchBar||Math.abs(u.deltaY)>i&&a(u.deltaY>0?1:-1)},{passive:!0});let l=0,c=0;window.addEventListener("touchstart",u=>{!this.flickToSelectEnabled||this.openSettings||this.showSearchBar||(l=u.touches[0].clientY,c=Date.now())},{passive:!0}),window.addEventListener("touchend",u=>{if(!this.flickToSelectEnabled||this.openSettings||this.showSearchBar)return;const d=u.changedTouches[0].clientY,f=Date.now(),h=d-l,p=f-c;p>0&&Math.abs(h)/p>n&&Math.abs(h)>s&&a(h<0?1:-1)},{passive:!0})},_startPeriodicSync:function(){let e=Date.now();const t=()=>e=Date.now();["mousemove","mousedown","keydown","scroll","click","visibilitychange","focus"].forEach(i=>{document.addEventListener(i,t,!0),i==="focus"&&window.addEventListener(i,t,!0),i==="visibilitychange"&&document.addEventListener(i,t,!0)});const n=300*1e3,s=60*1e3;setInterval(async()=>{const i=Date.now();if(!(!this.isOnline||this.openSettings||!this.syncEnabled||i-e>s)){console.log("Starting scheduled background sync...");try{await oe();const r=await ae(this);await V(),await this._loadAndManageAllData(),this.deckManaged=!0,console.log(`Scheduled sync complete. Success: ${r}`),r||_(this,"Sync finished with issues."),await this.pregenerateDecks()}catch(r){console.error("Periodic sync failed:",r),_(this,"Sync failed!")}}},n)},_startWorkerFeedSync:function(){setInterval(async()=>{if(!(!this.isOnline||!this.syncEnabled)){console.log("[Worker Sync] Triggering background feed processing...");try{const e=await Q();if(!e)return;fetch(`${Ge}/api/refresh`,{method:"POST",headers:{Authorization:`Bearer ${e}`}}).then(t=>t.json()).then(t=>console.log("[Worker Sync] Background sync complete:",t)).catch(t=>console.error("[Worker Sync] Background sync failed:",t))}catch(e){console.error("[Worker Sync] Periodic setup failed:",e)}}},600*1e3)},_initScrollObserver:function(){const e=new IntersectionObserver(async()=>{},{root:document.querySelector("#feed-container"),rootMargin:"0px",threshold:.1}),t=document.querySelector("#feed-container");if(!t)return;const n=()=>{t.querySelectorAll("[data-guid]").forEach(i=>{e.observe(i)})};n(),new MutationObserver(()=>{e.disconnect(),n()}).observe(t,{childList:!0,subtree:!0}),this.scrollObserver=e},handleEntryLinks:function(e){e&&e.querySelectorAll("a").forEach(t=>{t.hostname!==window.location.hostname&&(this.openUrlsInNewTabEnabled?(t.setAttribute("target","_blank"),t.setAttribute("rel","noopener noreferrer")):t.removeAttribute("target")),t.addEventListener("click",n=>{const s=n.target.closest(".item");if(!s)return;const i=s.dataset.guid;if(!i||this.selectedGuid===i)return;const r=s.getBoundingClientRect(),a=window.innerHeight,c=(Math.min(r.bottom,a)-Math.max(r.top,0))/a;console.log(`[LinkClick] Item coverage: ${(c*100).toFixed(1)}%`),c>.9?(this.selectedGuid=i,console.log(`[LinkClick] High coverage (${(c*100).toFixed(1)}%), skipping double-click.`)):(n.preventDefault(),n.stopPropagation(),console.log(`[LinkClick] Low coverage (${(c*100).toFixed(1)}%), selecting item first.`),this.selectItem(i))})})},toggleSearch:function(){Oa(this)},loadSvg:async function(e,t){try{const n=await fetch(`/images/icons/${t}`);if(n.ok){const s=await n.text();e.innerHTML=s;const i=e.querySelector("svg");i&&(i.setAttribute("width","100%"),i.setAttribute("height","100%"))}}catch(n){console.error(`Failed to load SVG: ${t}`,n)}},discoverFeed:async function(){await $a(this)},preloadThemes:function(){console.log("[Theme] Preloading all theme styles into browser cache...");const e=["sepia","solarized-light","github-light","atom-one-light","gruvbox-light","catppuccin-latte","rose-pine-dawn","paper","morning","midnight","nord","dracula","monokai","gruvbox-dark","catppuccin-mocha","tokyo-night","synthwave","material-dark"],t=document.createElement("div");t.style.display="none",t.id="theme-preloader",document.body.appendChild(t),e.forEach(n=>{const s=document.createElement("div");s.className=`theme-${n}`,t.appendChild(s),window.getComputedStyle(s).getPropertyValue("--bg")}),setTimeout(()=>{document.body.removeChild(t),console.log("[Theme] Preloading completed.")},2e3)},pregenerateDecks:async function(){if(!this._isPregenerating){this._isPregenerating=!0,console.log("[Background] Starting pre-generation of decks...");try{await this._generateAndSavePregeneratedDeck(!0),await this._generateAndSavePregeneratedDeck(!1),console.log("[Background] Deck pre-generation completed.")}catch(e){console.error("[Background] Deck pre-generation failed:",e)}finally{this._isPregenerating=!1}}},_generateAndSavePregeneratedDeck:async function(e){const{generateNewDeck:t}=await j(async()=>{const{generateNewDeck:a}=await Promise.resolve().then(()=>Yn);return{generateNewDeck:a}},void 0),n=await t(Array.from(this.entries),this.read,this.starred,this.shuffledOutGuids,"unread",e),s=new Date().toISOString(),i=(n||[]).map(a=>({guid:a.guid,addedAt:s})),r=e?"pregeneratedOnlineDeck":"pregeneratedOfflineDeck";this[r]=i,await A(r,i),console.log(`[Background] Pregenerated ${e?"ONLINE":"OFFLINE"} deck saved. Size: ${i.length}`)},$nextTick:function(e){return He.nextTick(e)},$watch:function(e,t){return He.watch(this,e,t)}}}He.data("rssApp",Ma);window.Alpine=He;He.start();
